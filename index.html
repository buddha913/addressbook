
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>MUDDHA CSV Analyzer v30 · 패턴/티어/코치봇 활성화</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width: 100%; height: 100%; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #f7f9ff;
      background:
        radial-gradient(circle at 50% 10%, rgba(255, 75, 175, 0.35), transparent 55%),
        radial-gradient(circle at 10% 90%, rgba(65, 225, 255, 0.35), transparent 55%),
        radial-gradient(circle at 90% 80%, rgba(70, 120, 255, 0.35), transparent 55%),
        radial-gradient(circle at 50% 55%, rgba(0, 0, 0, 0.8), #050612 70%);
      background-color: #050612;
      overflow: hidden;
    }

    .app-shell {
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    /* Sidebar */
    .sidebar {
      width: 240px;
      min-width: 220px;
      height: 100%;
      padding: 20px 18px 18px;
      background: radial-gradient(circle at 0 0, rgba(255, 75, 175, 0.22), transparent 55%),
                  radial-gradient(circle at 100% 100%, rgba(70, 120, 255, 0.22), transparent 50%),
                  linear-gradient(180deg, #050818 0%, #050712 100%);
      box-shadow: 8px 0 32px rgba(0, 0, 0, 0.85);
      border-right: 1px solid rgba(255, 255, 255, 0.06);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .logo-block {
      padding-bottom: 14px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }
    .logo-title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #fdf7ff;
    }
    .logo-sub {
      margin-top: 4px;
      font-size: 11px;
      color: rgba(200, 216, 255, 0.75);
    }

    .live-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
      font-size: 10px;
      padding: 3px 9px;
      border-radius: 999px;
      background: linear-gradient(135deg, rgba(255, 74, 170, 0.18), rgba(68, 142, 255, 0.18));
      border: 1px solid rgba(255, 164, 219, 0.7);
      color: #ffe9ff;
    }
    .live-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #ff4ba7;
      box-shadow: 0 0 10px rgba(255, 75, 167, 0.95);
    }

    .sidebar-section-title {
      font-size: 11px;
      text-transform: uppercase;
      color: rgba(166, 185, 230, 0.8);
      letter-spacing: 0.12em;
      margin: 8px 4px 4px;
    }

    .nav-list {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .nav-item {
      position: relative;
      width: 100%;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid transparent;
      background: transparent;
      color: rgba(225, 232, 255, 0.9);
      cursor: pointer;
      transition: all 0.15s ease-out;
      overflow: hidden;
    }

    .nav-item::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(120deg, rgba(255, 75, 175, 0.7), rgba(68, 142, 255, 0.7));
      opacity: 0;
      transition: opacity 0.18s ease-out;
      z-index: -1;
    }

    .nav-item span.icon {
      width: 20px;
      text-align: center;
      opacity: 0.9;
      font-size: 15px;
    }

    .nav-item.active {
      color: #fdf7ff; /* 기본 밝은 글씨 유지 */
      font-weight: 500;
      border-color: rgba(255, 75, 175, 0.9); /* 핑크 계열 테두리 강조 */
      box-shadow: 0 0 0 1px rgba(68, 142, 255, 0.7); /* 살짝 글로우 */
    }
    .nav-item.active::before {
  opacity: 0; /* 배경 그라디언트는 끄고, 테두리만 강조 */
}

    .nav-item:hover:not(.active) {
      background: rgba(255, 255, 255, 0.04);
      border-color: rgba(255, 255, 255, 0.18);
    }

    .sidebar-footer {
      margin-top: auto;
      padding-top: 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      font-size: 11px;
      color: rgba(182, 199, 236, 0.9);
      line-height: 1.6;
    }
    .sidebar-footer b { color: #ffffff; }

    /* Main */
    .main {
      flex: 1;
      min-width: 0;
      height: 100%;
      padding: 20px 24px 20px 20px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
    }

    .top-left {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .top-title {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }
    .top-subtitle {
      font-size: 12px;
      color: rgba(210, 221, 255, 0.9);
    }

    .top-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .pill-btn {
      font-size: 12px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid rgba(246, 249, 255, 0.75);
      background: rgba(5, 8, 20, 0.75);
      color: #f7f9ff;
      backdrop-filter: blur(14px);
      cursor: pointer;
      transition: all 0.15s ease-out;
    }
    .pill-btn:hover { background: rgba(10, 16, 34, 0.95); }
    .pill-btn.secondary {
      border-color: rgba(200, 205, 230, 0.75);
      background: rgba(5, 8, 22, 0.7);
    }

    .content-scroll {
      flex: 1;
      overflow-y: auto;
      padding-right: 6px;
      padding-bottom: 8px;
    }
    .content-scroll::-webkit-scrollbar { width: 6px; }
    .content-scroll::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.33);
      border-radius: 999px;
    }
    .content-scroll::-webkit-scrollbar-track { background: transparent; }

    /* Tabs */
    .tab-panel { display: none; animation: fadeInUp 0.18s ease-out; }
    .tab-panel.active { display: block; }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Main big card */
    .card-main {
      max-width: 1180px;
      background: linear-gradient(145deg, rgba(10, 18, 40, 0.96), rgba(5, 8, 24, 0.98));
      border-radius: 22px;
      padding: 18px 20px 16px;
      position: relative;
      overflow: hidden;
      color: #f6f8ff;
      box-shadow:
        0 26px 48px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(15, 25, 60, 0.9);
      margin-bottom: 18px;
    }
    .card-main::before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      padding: 1px;
      background: linear-gradient(120deg, #ff4ba7, #4ae0ff, #4370ff);
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
              mask-composite: exclude;
      opacity: 0.9;
      pointer-events: none;
    }
    .card-header-line {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
    }
    .card-title-main { font-size: 16px; font-weight: 600; }
    .card-title-sub {
      margin-top: 4px;
      font-size: 12px;
      color: rgba(204, 216, 252, 0.9);
    }
    .card-chip {
      padding: 6px 11px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(8, 240, 155, 0.1);
      border: 1px solid rgba(111, 255, 210, 0.9);
      color: #e6fff7;
      box-shadow: 0 0 18px rgba(8, 210, 145, 0.7);
      white-space: nowrap;
    }
    .card-body-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.7fr);
      gap: 18px;
      align-items: center;
    }
    .score-main {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: 0.05em;
    }
    .score-range {
      margin-top: 6px;
      font-size: 12px;
      color: rgba(205, 219, 255, 0.96);
    }
    .score-caption {
      margin-top: 8px;
      font-size: 11px;
      color: rgba(180, 197, 240, 0.95);
      line-height: 1.5;
    }
    .metric-list {
      border-radius: 18px;
      background: radial-gradient(circle at 0 0, rgba(255, 75, 175, 0.12), transparent 55%),
                  radial-gradient(circle at 100% 100%, rgba(74, 224, 255, 0.12), transparent 55%),
                  rgba(3, 10, 30, 0.95);
      border: 1px solid rgba(150, 176, 240, 0.9);
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
    }
    .metric-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 2px;
      color: rgba(225, 235, 255, 0.96);
    }
    .metric-row + .metric-row {
      border-top: 1px dashed rgba(122, 145, 212, 0.75);
    }
    .metric-label { font-size: 12px; }
    .metric-value-pill {
      min-width: 72px;
      text-align: right;
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(8, 20, 50, 0.98);
      border: 1px solid rgba(182, 208, 255, 0.98);
      color: #f3f7ff;
    }

    /* Dashboard secondary cards grid */
    .dash-grid {
      max-width: 1180px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
      margin-bottom: 10px;
    }
    .dash-card {
      border-radius: 18px;
      padding: 12px 14px 11px;
      background: rgba(5, 10, 32, 0.92);
      border: 1px solid rgba(170, 195, 250, 0.5);
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.75);
      font-size: 12px;
    }
    
    /* Yapping Planner (side tab) */
    .planner-page {
      max-width: 1200px;
      margin-top: 10px;
    }
    .planner-layout {
      display: grid;
      grid-template-columns: 1.3fr 1fr;
      gap: 14px;
    }
    .planner-left {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .planner-right {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .planner-card {
      border-radius: 22px;
      padding: 16px 18px 14px;
      background:
        radial-gradient(circle at 0 0, rgba(255, 75, 175, 0.16), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(74, 224, 255, 0.18), transparent 55%),
        rgba(5, 10, 32, 0.96);
      border: 1px solid rgba(172, 196, 255, 0.8);
      box-shadow: 0 22px 48px rgba(0, 0, 0, 0.85);
      margin-bottom: 4px;
    }
    .planner-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
    }
    .planner-card-title {
      font-size: 15px;
      font-weight: 600;
    }
    .planner-card-sub {
      margin-top: 4px;
      font-size: 11px;
      color: rgba(195, 211, 250, 0.96);
    }
    .planner-auto-save {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: rgba(15, 23, 42, 0.96);
      color: rgba(226, 232, 255, 0.96);
      white-space: nowrap;
    }
    .planner-form-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px 10px;
      font-size: 11px;
    }
    .planner-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .planner-field label {
      font-size: 11px;
      color: rgba(203, 213, 225, 0.96);
    }
    .planner-field.wide {
      grid-column: span 2;
    }
    .planner-field.full {
      grid-column: span 4;
    }
    .planner-field input,
    .planner-field select,
    .planner-field textarea {
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: rgba(6, 12, 32, 0.96);
      color: #f9fafb;
      font-size: 12px;
      padding: 6px 8px;
      outline: none;
    }
    .planner-field textarea {
      resize: vertical;
    }
    .planner-chip-row {
      display: inline-flex;
      gap: 6px;
    }
    .planner-chip {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: rgba(15, 23, 42, 0.96);
      color: rgba(226, 232, 255, 0.96);
      cursor: pointer;
    }
    .planner-chip.active {
      background: linear-gradient(135deg, #ff4ba7, #5ee0ff);
      color: #050816;
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.8), 0 10px 22px rgba(0, 0, 0, 0.85);
    }
    .planner-actions-row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 14px;
    }
    .planner-primary-btn,
    .planner-secondary-btn {
      flex: 1;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 13px;
      cursor: pointer;
      border: none;
    }
    .planner-primary-btn {
      background: linear-gradient(135deg, #ff4ba7, #5ee0ff);
      color: #050816;
      font-weight: 600;
      box-shadow: 0 16px 32px rgba(0, 0, 0, 0.9);
    }
    .planner-secondary-btn {
      background: rgba(15, 23, 42, 0.96);
      color: rgba(226, 232, 255, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.9);
    }
    .planner-saved-summary {
      font-size: 11px;
      color: rgba(203, 213, 225, 0.96);
      margin-bottom: 6px;
    }
    .planner-saved-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .planner-saved-item {
      border-radius: 12px;
      padding: 6px 8px;
      background: rgba(6, 12, 32, 0.96);
      border: 1px solid rgba(51, 65, 85, 0.9);
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .planner-saved-item.done {
      opacity: 0.6;
    }
    .planner-saved-line1 {
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }
    .planner-saved-title {
      font-weight: 500;
      color: rgba(229, 231, 235, 0.98);
    }
    .planner-saved-title.done {
      text-decoration: line-through;
    }
    .planner-saved-meta {
      font-size: 10px;
      color: rgba(156, 163, 175, 0.96);
    }
    .planner-saved-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 2px;
      font-size: 9px;
    }
    .planner-badge {
      border-radius: 999px;
      padding: 2px 6px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: rgba(15, 23, 42, 0.96);
      color: rgba(226, 232, 255, 0.96);
    }
    .planner-saved-actions {
      margin-top: 4px;
      display: flex;
      gap: 4px;
    }
    .planner-mini-btn {
      flex: 0 0 auto;
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 10px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: rgba(15, 23, 42, 0.96);
      color: rgba(226, 232, 255, 0.96);
      cursor: pointer;
    }
    .planner-mini-btn.primary {
      background: rgba(34, 197, 94, 0.16);
      border-color: rgba(34, 197, 94, 0.9);
      color: rgba(187, 247, 208, 0.96);
    }
    .planner-mini-btn.danger {
      background: rgba(239, 68, 68, 0.12);
      border-color: rgba(248, 113, 113, 0.96);
      color: rgba(254, 202, 202, 0.98);
    }
    .planner-filter-row {
      display: flex;
      gap: 4px;
      white-space: nowrap;
    }
    .planner-filter-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: rgba(15, 23, 42, 0.96);
      color: rgba(226, 232, 255, 0.96);
      font-size: 11px;
      padding: 4px 8px;
      cursor: pointer;
    }
    .planner-filter-btn.active {
      background: linear-gradient(135deg, #ff4ba7, #5ee0ff);
      color: #050816;
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.8), 0 10px 22px rgba(0, 0, 0, 0.85);
    }

    .planner-calendar-controls {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
    }
    .planner-calendar-tabs {
      display: inline-flex;
      padding: 2px;
      border-radius: 999px;
      background: rgba(6, 12, 32, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.8);
    }
    .planner-calendar-tab {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      background: transparent;
      color: rgba(203, 213, 225, 0.95);
    }
    .planner-calendar-tab.active {
      background: linear-gradient(135deg, #ff4ba7, #5ee0ff);
      color: #050816;
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.8), 0 10px 22px rgba(0, 0, 0, 0.85);
    }
    .planner-calendar-nav {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: rgba(226, 232, 255, 0.96);
    }
    .planner-nav-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: rgba(15, 23, 42, 0.96);
      color: rgba(226, 232, 255, 0.96);
      font-size: 11px;
      padding: 3px 8px;
      cursor: pointer;
    }
    .planner-range-label {
      min-width: 148px;
      text-align: center;
    }
    .planner-calendar-body {
      margin-top: 6px;
    }
    .planner-week-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 6px;
      margin-top: 6px;
    }
    .planner-day {
      border-radius: 14px;
      padding: 6px 6px 5px;
      font-size: 11px;
      background: rgba(6, 12, 32, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.6);
      min-height: 96px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .planner-day-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 2px;
      font-size: 11px;
      color: rgba(209, 213, 219, 0.96);
    }
    .planner-day-count {
      font-size: 10px;
      color: rgba(156, 163, 175, 0.96);
    }
    .planner-pill {
      border-radius: 10px;
      padding: 3px 5px;
      background: rgba(17, 24, 39, 0.96);
      border: 1px solid rgba(156, 163, 175, 0.8);
      font-size: 10px;
      line-height: 1.4;
      display: flex;
      flex-direction: column;
      gap: 1px;
    }
    .planner-pill-main {
      display: flex;
      justify-content: space-between;
      gap: 4px;
    }
    .planner-pill-title {
      font-weight: 500;
      color: rgba(229, 231, 235, 0.98);
    }
    .planner-pill-meta {
      font-size: 9px;
      color: rgba(156, 163, 175, 0.96);
    }
    .planner-pill-tagline {
      font-size: 9px;
      color: rgba(196, 181, 253, 0.96);
    }
    .planner-dot {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 999px;
      margin-right: 3px;
    }
    .planner-dot.core { background: #f97316; box-shadow: 0 0 6px rgba(248, 113, 113, 0.9); }
    .planner-dot.sub { background: #22c55e; box-shadow: 0 0 6px rgba(74, 222, 128, 0.9); }
    .planner-dot.long { background: #38bdf8; box-shadow: 0 0 6px rgba(56, 189, 248, 0.9); }

    .planner-empty {
      font-size: 11px;
      color: rgba(148, 163, 184, 0.96);
      padding: 6px 4px 4px;
    }
    .planner-month-grid {
      margin-top: 6px;
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
    }
    .planner-month-cell {
      border-radius: 10px;
      padding: 4px 4px 3px;
      min-height: 70px;
      background: rgba(6, 12, 32, 0.95);
      border: 1px solid rgba(31, 41, 55, 0.9);
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 10px;
    }
    .planner-month-day {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      font-size: 10px;
      color: rgba(209, 213, 219, 0.96);
    }
    .planner-month-other {
      opacity: 0.45;
    }
    .planner-month-count {
      font-size: 9px;
      color: rgba(148, 163, 184, 0.96);
    }
    .planner-month-item {
      font-size: 9px;
      color: rgba(226, 232, 255, 0.96);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Dashboard YAP Timeline widget (full-width row B) */
    .dash-yap-section {
      grid-column: 1 / -1;
      border-radius: 22px;
      padding: 16px 18px 14px;
      background:
        radial-gradient(circle at 0 0, rgba(255, 75, 175, 0.16), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(74, 224, 255, 0.18), transparent 55%),
        rgba(5, 10, 32, 0.96);
      border: 1px solid rgba(172, 196, 255, 0.8);
      box-shadow: 0 22px 48px rgba(0, 0, 0, 0.85);
    }
    .dash-yap-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    .dash-yap-title {
      font-size: 14px;
      font-weight: 600;
    }
    .dash-yap-sub {
      margin-top: 4px;
      font-size: 11px;
      color: rgba(195, 211, 250, 0.96);
    }
    .dash-yap-controls {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
    }
    .dash-yap-tabs {
      display: inline-flex;
      padding: 2px;
      border-radius: 999px;
      background: rgba(6, 12, 32, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.8);
    }
    .dash-yap-tab {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      background: transparent;
      color: rgba(203, 213, 225, 0.95);
    }
    .dash-yap-tab.active {
      background: linear-gradient(135deg, #ff4ba7, #5ee0ff);
      color: #050816;
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.8), 0 10px 22px rgba(0, 0, 0, 0.85);
    }
    .dash-yap-nav-wrap {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: rgba(226, 232, 255, 0.96);
    }
    .dash-yap-nav {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: rgba(15, 23, 42, 0.96);
      color: rgba(226, 232, 255, 0.96);
      font-size: 11px;
      padding: 3px 8px;
      cursor: pointer;
    }
    .dash-yap-range {
      min-width: 148px;
      text-align: center;
    }
    .dash-yap-body {
      margin-top: 6px;
    }
    .dash-yap-week-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 6px;
      margin-top: 6px;
    }
    .dash-yap-day {
      border-radius: 14px;
      padding: 6px 6px 5px;
      font-size: 11px;
      background: rgba(6, 12, 32, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.6);
      min-height: 90px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .dash-yap-day-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 2px;
      font-size: 11px;
      color: rgba(209, 213, 219, 0.96);
    }
    .dash-yap-day-count {
      font-size: 10px;
      color: rgba(156, 163, 175, 0.96);
    }
    .dash-yap-pill {
      border-radius: 10px;
      padding: 3px 5px;
      background: rgba(17, 24, 39, 0.96);
      border: 1px solid rgba(156, 163, 175, 0.8);
      font-size: 10px;
      line-height: 1.4;
      display: flex;
      flex-direction: column;
      gap: 1px;
    }
    .dash-yap-pill-main {
      display: flex;
      justify-content: space-between;
      gap: 4px;
    }
    .dash-yap-pill-title {
      font-weight: 500;
      color: rgba(229, 231, 235, 0.98);
    }
    .dash-yap-pill-meta {
      font-size: 9px;
      color: rgba(156, 163, 175, 0.96);
    }
    .dash-yap-tagline {
      font-size: 9px;
      color: rgba(196, 181, 253, 0.96);
    }
    .dash-yap-dot {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 999px;
      margin-right: 3px;
    }
    .dash-yap-dot.core { background: #f97316; box-shadow: 0 0 6px rgba(248, 113, 113, 0.9); }
    .dash-yap-dot.sub { background: #22c55e; box-shadow: 0 0 6px rgba(74, 222, 128, 0.9); }
    .dash-yap-dot.long { background: #38bdf8; box-shadow: 0 0 6px rgba(56, 189, 248, 0.9); }

    .dash-yap-empty {
      font-size: 11px;
      color: rgba(148, 163, 184, 0.96);
      padding: 6px 4px 4px;
    }
    .dash-yap-month-grid {
      margin-top: 6px;
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
    }
    .dash-yap-month-cell {
      border-radius: 10px;
      padding: 4px 4px 3px;
      min-height: 64px;
      background: rgba(6, 12, 32, 0.95);
      border: 1px solid rgba(31, 41, 55, 0.9);
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 10px;
    }
    .dash-yap-month-day {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      font-size: 10px;
      color: rgba(209, 213, 219, 0.96);
    }
    .dash-yap-month-other {
      opacity: 0.45;
    }
    .dash-yap-month-count {
      font-size: 9px;
      color: rgba(148, 163, 184, 0.96);
    }
    .dash-yap-month-item {
      font-size: 9px;
      color: rgba(226, 232, 255, 0.96);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    @media (max-width: 1100px) {
      .planner-layout {
        grid-template-columns: 1fr;
      }
      .planner-right {
        order: -1;
      }
    }
.csv-main-tabs {
      margin: 4px 0 14px;
      display: inline-flex;
      gap: 8px;
      padding: 3px;
      border-radius: 999px;
      background: rgba(6, 10, 28, 0.98);
      border: 1px solid rgba(120, 148, 220, 0.9);
    }
    .csv-main-btn {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 11px;
      letter-spacing: 0.03em;
      cursor: pointer;
      background: transparent;
      color: rgba(208, 220, 255, 0.9);
      transition: all 0.15s ease-out;
      white-space: nowrap;
    }
    .csv-main-btn.active {
      background: linear-gradient(135deg, #ff4ba7, #5ee0ff);
      color: #050816;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.85), 0 10px 20px rgba(0,0,0,0.8);
    }
    .csv-main-btn:not(.active):hover {
      background: rgba(255,255,255,0.06);
    }
    .csv-main-panel {
      display: none;
    }
    .csv-main-panel.active {
      display: block;
    }
    .dash-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }
    .dash-card-title {
      font-size: 13px;
      font-weight: 600;
    }
    .dash-card-tag {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15, 25, 60, 0.95);
      border: 1px solid rgba(160, 190, 255, 0.8);
      color: rgba(223, 235, 255, 0.96);
      white-space: nowrap;
    }
    .dash-card-body {
      font-size: 11px;
      color: rgba(205, 220, 255, 0.95);
      line-height: 1.6;
    }
    .rank-list {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .rank-row {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
    }
    .rank-name { opacity: 0.9; }
    .rank-pos { opacity: 0.95; }

    .kpi-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
      flex-wrap: wrap;
    }
    .kpi-pill {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(10, 18, 46, 0.98);
      border: 1px solid rgba(166, 194, 255, 0.9);
    }
    .planner-list {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .planner-item {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      opacity: 0.96;
    }

    .ad-card {
      position: relative;
      overflow: hidden;
      background:
        radial-gradient(circle at 0 0, rgba(255, 75, 175, 0.24), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(74, 224, 255, 0.24), transparent 55%),
        rgba(5, 8, 26, 0.96);
      border-radius: 18px;
      padding: 14px 16px;
      border: 1px dashed rgba(230, 238, 255, 0.9);
      text-align: left;
    }
    .ad-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: rgba(230, 238, 255, 0.9);
      opacity: 0.85;
    }
    .ad-title {
      margin-top: 6px;
      font-size: 14px;
      font-weight: 600;
    }
    .ad-sub {
      margin-top: 4px;
      font-size: 11px;
      color: rgba(215, 229, 255, 0.94);
    }
    .ad-chip {
      display: inline-block;
      margin-top: 10px;
      font-size: 10px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.8);
      background: rgba(3, 8, 26, 0.9);
    }

    /* Placeholder for other tabs */
    .tab-placeholder {
      max-width: 1180px;
      padding: 16px 18px;
      border-radius: 18px;
      background: rgba(6, 10, 30, 0.94);
      border: 1px dashed rgba(185, 208, 250, 0.9);
      font-size: 13px;
      color: rgba(224, 235, 255, 0.98);
    }
    .tab-placeholder h2 {
      font-size: 15px;
      margin-bottom: 8px;
    }
    .tab-placeholder p {
      font-size: 12px;
      color: rgba(195, 212, 250, 0.96);
    }

    
    /* KAITO 리더보드 탭 */
    .kaito-hero {
      max-width: 960px;
      margin: 0 auto 18px;
      padding: 18px 18px 14px;
      border-radius: 20px;
      background:
        radial-gradient(circle at 0% 0%, rgba(94, 234, 212, 0.22), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(94, 234, 212, 0.18), transparent 55%),
        rgba(6, 10, 30, 0.96);
      border: 1px solid rgba(94, 234, 212, 0.7);
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.9);
    }
    .kaito-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .kaito-sub {
      font-size: 12px;
      color: rgba(191, 212, 255, 0.9);
    }
    .kaito-search-row {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .kaito-input {
      flex: 1;
      min-width: 220px;
      padding: 9px 13px;
      border-radius: 999px;
      border: 1px solid rgba(129, 140, 248, 0.85);
      background: rgba(3, 7, 18, 0.9);
      color: #e5e7eb;
      font-size: 13px;
    }
    .kaito-input::placeholder {
      color: rgba(148, 163, 184, 0.95);
    }
    .kaito-btn {
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #4f46e5, #06b6d4);
      color: #f9fafb;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 12px 30px rgba(56, 189, 248, 0.6);
      white-space: nowrap;
    }
    .kaito-btn:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }
    .kaito-note {
      margin-top: 6px;
      font-size: 11px;
      color: rgba(165, 180, 252, 0.96);
    }
    .kaito-source {
      margin-top: 4px;
      font-size: 11px;
      color: rgba(148, 163, 184, 0.96);
    }
    .kaito-source a {
      color: #a5b4fc;
      text-decoration: underline;
    }
    .kaito-result-wrap {
      margin-top: 14px;
      max-width: 1180px;
      margin-left: auto;
      margin-right: auto;
    }
    .kaito-empty {
      font-size: 12px;
      color: rgba(148, 163, 184, 0.96);
      padding: 10px 4px;
      text-align: center;
    }
    @media (max-width: 720px) {
      .kaito-hero {
        padding: 16px 14px 12px;
      }
      .kaito-input {
        min-width: 0;
      }
    }

/* Responsive */
    @media (max-width: 1180px) {
      .sidebar { display: none; }
      .main { padding: 16px; }
      .card-main { border-radius: 18px; }
    }
    @media (max-width: 720px) {
      .card-body-grid { grid-template-columns: 1fr; }
      .top-bar { flex-direction: column; align-items: flex-start; }
      .top-right { width: 100%; justify-content: flex-start; }
      .dash-grid { grid-template-columns: 1fr; }
    }
  
    .csv-range-bar {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-bottom: 6px;
      font-size: 10px;
    }
    .csv-range-btn {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 10px;
      letter-spacing: 0.03em;
      cursor: pointer;
      background: rgba(9, 12, 40, 0.9);
      color: rgba(208, 220, 255, 0.8);
      transition: all 0.15s ease-out;
      white-space: nowrap;
    }
    .csv-score-layout {
      display: flex;
      gap: 16px;
      align-items: stretch;
      margin-top: 4px;
    }
    .csv-score-main {
      flex: 2;
      min-width: 0;
    }
    .csv-score-detail {
      flex: 1;
      min-width: 0;
      font-size: 11px;
      border-radius: 18px;
      padding: 10px 12px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: radial-gradient(circle at top left, rgba(56,189,248,0.12), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(236,72,153,0.18), transparent 55%),
                  rgba(6, 10, 32, 0.92);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.9),
        0 18px 45px rgba(15, 23, 42, 0.85);
      color: rgba(226,232,255,0.9);
    }
    .csv-score-detail-title {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      opacity: 0.9;
      margin-bottom: 6px;
    }
    .csv-score-detail-body {
      font-size: 11px;
      line-height: 1.5;
      max-height: 210px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .csv-score-detail-body p {
      margin-bottom: 4px;
    }
    .csv-score-detail-meta {
      font-size: 10px;
      opacity: 0.85;
      margin-bottom: 4px;
    }
    .csv-score-detail-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      margin-top: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      background: rgba(15,23,42,0.9);
      cursor: pointer;
      text-decoration: none;
      color: rgba(226,232,255,0.95);
    }

    .csv-range-btn.active {
      background: linear-gradient(135deg, #ff4ba7, #5ee0ff);
      color: #050816;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.85), 0 8px 16px rgba(0,0,0,0.7);
    }
    .csv-range-btn:not(.active):hover {
      background: rgba(255,255,255,0.08);
    }

    
    .csv-month-filter-row {
      margin: 4px 0 6px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      color: rgba(248, 250, 252, 0.75);
    }
    .csv-month-filter-label {
      opacity: 0.85;
    }
    .csv-month-filter-select {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 10px;
      outline: none;
      cursor: pointer;
    }
/* 프로필 탭 전용 레이아웃 */
    .profile-page-layout {
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(260px, 1.2fr);
      gap: 24px;
      align-items: flex-start;
    }
    .profile-main-card,
    .profile-history-card {
      background: radial-gradient(circle at top left, rgba(88, 101, 242, 0.16), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(236, 72, 153, 0.2), transparent 55%),
                  rgba(5, 10, 32, 0.96);
      border-radius: 22px;
      padding: 20px 22px 18px;
      box-shadow:
        0 26px 48px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(20, 32, 72, 0.9);
      position: relative;
      overflow: hidden;
    }
    .profile-main-card::before,
    .profile-history-card::before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      padding: 1px;
      background: linear-gradient(120deg, #ff4ba7, #4ae0ff, #4370ff);
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
              mask-composite: exclude;
      opacity: 0.9;
      pointer-events: none;
    }
    .profile-header-row {
      display: flex;
      align-items: center;
      gap: 18px;
      margin-bottom: 18px;
    }
    .profile-avatar-wrap {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      padding: 2px;
      background: linear-gradient(135deg, #f97316, #e11d48);
      box-shadow: 0 0 24px rgba(0,0,0,0.8);
      flex-shrink: 0;
    }
    .profile-avatar-img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      background: #020617;
    }
    .profile-header-text {
      flex: 1;
      min-width: 0;
    }
    .profile-handle-line {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 10px;
      align-items: baseline;
      margin-bottom: 4px;
    }
    .profile-name {
      font-size: 20px;
      font-weight: 700;
      color: #f9fafb;
    }
    .profile-handle {
      font-size: 13px;
      color: rgba(191, 219, 254, 0.86);
    }
    .profile-caption {
      font-size: 12px;
      color: rgba(160, 174, 214, 0.95);
    }
    .profile-pill {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(191, 219, 254, 0.6);
      color: rgba(226, 232, 255, 0.95);
      background: rgba(15, 23, 42, 0.9);
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9);
    }
    .profile-form-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 14px;
      margin-bottom: 16px;
      margin-top: 4px;
    }
    .profile-field label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 2px;
      color: rgba(226, 232, 255, 0.98);
    }
    .profile-field .field-hint {
      font-size: 11px;
      color: rgba(148, 163, 199, 0.96);
      margin-bottom: 6px;
    }
    .profile-field input {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(55, 65, 81, 0.85);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.98));
      padding: 8px 10px;
      color: #e5e7eb;
      font-size: 13px;
      outline: none;
    }
    .profile-field input::placeholder {
      color: rgba(107, 114, 128, 0.9);
    }
    .profile-field input:focus {
      border-color: rgba(96, 165, 250, 0.96);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.85);
    }
    .profile-actions-row {
      display: flex;
      justify-content: flex-start;
      margin-top: 4px;
    }
    .primary-btn {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #4f46e5, #ec4899);
      color: #f9fafb;
      box-shadow: 0 14px 32px rgba(15, 23, 42, 0.9);
    }
    .primary-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.98);
    }
    .profile-history-card {
      min-height: 220px;
    }
    .profile-history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .profile-history-header h3 {
      font-size: 16px;
      font-weight: 700;
      color: #e5e7eb;
    }
    .history-badge {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(191, 219, 254, 0.6);
      color: rgba(226, 232, 255, 0.95);
    }
    .history-description {
      font-size: 11px;
      color: rgba(156, 163, 175, 0.96);
      margin-bottom: 10px;
      line-height: 1.5;
    }
    .profile-history-list {
      margin-top: 6px;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 6px;
    }
    .profile-history-item {
      font-size: 11px;
      color: rgba(203, 213, 225, 0.96);
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(31, 41, 55, 0.9);
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }
    .profile-history-item-time {
      opacity: 0.8;
      min-width: 70px;
      text-align: right;
      white-space: nowrap;
    }
    @media (max-width: 1024px) {
      .profile-page-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }
</style>

  <!-- Supabase + 로그인 오버레이 스타일 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .muddha-login-overlay{
      position:fixed;
      inset:0;
      z-index:999;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      background:radial-gradient(circle at 0% 0%, rgba(255, 75, 175, 0.30), transparent 55%),
                 radial-gradient(circle at 100% 0, rgba(65, 225, 255, 0.30), transparent 55%),
                 radial-gradient(circle at 50% 100%, rgba(94, 92, 255, 0.32), transparent 60%);
      backdrop-filter: blur(14px);
    }
    .muddha-login-card{
      width:100%;
      max-width:420px;
      border-radius:22px;
      padding:22px 22px 18px;
      background:rgba(6, 10, 25, 0.96);
      border:1px solid rgba(148,163,184,0.55);
      box-shadow:0 22px 70px rgba(0,0,0,0.85);
      color:#e5e7eb;
    }
    .muddha-login-logo{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:8px;
    }
    .muddha-login-logo-mark{
      width:26px;height:26px;border-radius:10px;
      background:radial-gradient(circle at 20% 0%, #ff4baf, #5ee0ff);
      box-shadow:0 0 20px rgba(255, 75, 175, 0.75);
    }
    .muddha-login-logo-main{font-size:15px;font-weight:700;}
    .muddha-login-logo-sub{font-size:11px;color:#9ca3af;}
    .muddha-login-tabs{
      display:flex;
      gap:6px;
      padding:3px;
      border-radius:999px;
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(55,65,81,0.9);
      margin-bottom:10px;
      margin-top:6px;
    }
    .muddha-login-tab{
      flex:1;
      border-radius:999px;
      padding:7px 0;
      font-size:12px;
      text-align:center;
      cursor:pointer;
      border:none;
      background:transparent;
      color:#9ca3af;
    }
    .muddha-login-tab.active{
      background:linear-gradient(135deg, rgba(255,75,175,0.28), rgba(65,225,255,0.32));
      color:#f9fafb;
      box-shadow:0 10px 22px rgba(15,23,42,0.95);
    }
    .muddha-login-title{
      font-size:19px;
      font-weight:700;
      margin-bottom:4px;
    }
    .muddha-login-sub{
      font-size:12px;
      color:#9ca3af;
      margin-bottom:10px;
      line-height:1.5;
    }
    .muddha-login-form{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .muddha-login-label{
      font-size:12px;
      color:#9ca3af;
      margin-bottom:4px;
    }
    .muddha-login-input{
      width:100%;
      border-radius:999px;
      border:1px solid rgba(55,65,81,0.9);
      background:rgba(6,10,25,0.98);
      color:#e5e7eb;
      padding:9px 13px;
      font-size:13px;
      outline:none;
    }
    .muddha-login-input::placeholder{color:#6b7280;}
    .muddha-login-input:focus{
      border-color:#5ee0ff;
      box-shadow:0 0 0 1px rgba(94,224,255,0.65);
    }
    .muddha-login-error{
      min-height:14px;
      font-size:11px;
      color:#f97316;
      margin-top:2px;
    }
    .muddha-login-actions{
      margin-top:6px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .muddha-login-button{
      width:100%;
      border:none;
      border-radius:999px;
      padding:9px 0;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      background:linear-gradient(135deg, #ff4baf, #5ee0ff);
      color:#050816;
      box-shadow:0 14px 30px rgba(0,0,0,0.85);
    }
    .muddha-login-button:hover{filter:brightness(1.06);}
    .muddha-login-footer{
      margin-top:10px;
      font-size:11px;
      color:#6b7280;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .muddha-login-footer a{
      color:#e5e7eb;
      text-decoration:none;
    }
    .muddha-login-footer a:hover{text-decoration:underline;}
    @media (max-width:480px){
      .muddha-login-card{padding:18px 16px 16px;border-radius:18px;}
    }
  </style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* KAITO Tier1 슬라이더 (대시보드 전용) */
    .kaito-slider-wrap {
      margin-top: 8px;
      padding-bottom: 8px;
      overflow-x: auto;
      overflow-y: visible;
      scroll-snap-type: x mandatory;
    }
    .kaito-slider-track {
      display: flex;
      flex-wrap: nowrap;
      gap: 10px;
      padding-bottom: 4px;
      min-width: 100%;
    }
    .kaito-slider-card {
      flex: 0 0 240px;
      max-width: 260px;
      border-radius: 18px;
      border: 1px solid rgba(129, 140, 248, 0.9);
      background: linear-gradient(135deg, rgba(15,23,42,0.96), rgba(17,24,39,0.98));
      padding: 10px 10px 8px;
      box-shadow: 0 16px 30px rgba(15,23,42,0.85);
      scroll-snap-align: start;
    }
    .kaito-slider-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .kaito-slider-logo {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 700;
      color: #e5e7eb;
    }
    .kaito-slider-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .kaito-slider-title {
      font-size: 13px;
      font-weight: 700;
      color: #e5e7eb;
    }
    .kaito-slider-meta {
      font-size: 11px;
      color: rgba(148,163,184,0.96);
    }
    .kaito-slider-body {
      margin-top: 4px;
      font-size: 11px;
      color: rgba(191,219,254,0.96);
    }
    .kaito-slider-empty {
      font-size: 12px;
      color: rgba(148,163,184,0.96);
      padding: 4px 2px 10px;
    }
  </style>

  <style>
  /* COOKIE 리더보드 전용 스타일 */
  #tab-cookie .card-main {
    max-width: 1180px;
    background: linear-gradient(145deg, rgba(10, 18, 40, 0.96), rgba(5, 8, 24, 0.98));
    border-radius: 22px;
    padding: 18px 20px 16px;
    position: relative;
    overflow: hidden;
    color: #f6f8ff;
    box-shadow:
      0 26px 48px rgba(0, 0, 0, 0.9),
      0 0 0 1px rgba(15, 25, 60, 0.9);
    margin-bottom: 18px;
  }
  #tab-cookie .card-main::before {
    content: "";
    position: absolute;
    inset: -1px;
    border-radius: inherit;
    padding: 1px;
    background: linear-gradient(120deg, #ff4ba7, #4ae0ff, #4370ff);
    -webkit-mask:
      linear-gradient(#000 0 0) content-box,
      linear-gradient(#000 0 0);
    -webkit-mask-composite: xor;
            mask-composite: exclude;
    opacity: 0.9;
    pointer-events: none;
  }
  #tab-cookie .card-main-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 12px;
  }
  #tab-cookie .section-title {
    font-size: 15px;
    font-weight: 600;
  }
  #tab-cookie .section-sub {
    margin-top: 4px;
    font-size: 12px;
    color: rgba(204, 216, 252, 0.9);
  }

  #tab-cookie .cookie-hero {
    max-width: 960px;
    margin: 0 auto 12px;
    padding: 14px 14px 10px;
    border-radius: 18px;
    background:
      radial-gradient(circle at 0% 0%, rgba(249, 115, 22, 0.20), transparent 55%),
      radial-gradient(circle at 100% 0%, rgba(249, 115, 22, 0.14), transparent 55%),
      rgba(6, 10, 30, 0.96);
    border: 1px solid rgba(251, 146, 60, 0.7);
    box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
  }
  #tab-cookie .cookie-title {
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 4px;
  }
  #tab-cookie .cookie-sub {
    font-size: 12px;
    color: rgba(248, 250, 252, 0.9);
  }
  #tab-cookie .cookie-sub code {
    font-size: 11px;
    background: rgba(15,23,42,0.9);
    padding: 1px 6px;
    border-radius: 999px;
  }
  #tab-cookie .cookie-search-row {
    margin-top: 9px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }
  #tab-cookie .cookie-input {
    flex: 1;
    min-width: 220px;
    padding: 8px 12px;
    border-radius: 999px;
    border: 1px solid rgba(248, 250, 252, 0.75);
    background: rgba(3, 7, 18, 0.9);
    color: #e5e7eb;
    font-size: 13px;
  }
  #tab-cookie .cookie-input::placeholder {
    color: rgba(148, 163, 184, 0.95);
  }
  #tab-cookie .cookie-btn {
    padding: 8px 14px;
    border-radius: 999px;
    border: none;
    background: linear-gradient(135deg, #f97316, #facc15);
    color: #0b1120;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 10px 24px rgba(248, 250, 252, 0.35);
    white-space: nowrap;
  }
  #tab-cookie .cookie-note {
    margin-top: 6px;
    font-size: 11px;
    color: rgba(252, 211, 77, 0.96);
  }
  #tab-cookie .cookie-note a {
    color: #fed7aa;
    text-decoration: underline;
  }

  #tab-cookie .cookie-layout {
    max-width: 1180px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.4fr);
    gap: 12px;
    align-items: flex-start;
  }
  #tab-cookie .cookie-section {
    border-radius: 16px;
    padding: 10px 12px;
    background: rgba(6, 10, 32, 0.96);
    border: 1px solid rgba(148, 163, 184, 0.7);
    box-shadow: 0 18px 40px rgba(0,0,0,0.85);
  }
  #tab-cookie .cookie-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
  }
  #tab-cookie .cookie-section-title {
    font-size: 12px;
    font-weight: 600;
  }
  #tab-cookie .cookie-section-tag {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 999px;
    border: 1px solid rgba(248, 250, 252, 0.7);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    white-space: nowrap;
  }
  #tab-cookie .cookie-section-hint {
    font-size: 10px;
    color: rgba(148, 163, 184, 0.96);
    margin-bottom: 4px;
  }

  #tab-cookie .cards-wrap {
    margin-top: 6px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(230px,1fr));
    gap: 8px;
  }
  #tab-cookie .cookie-card {
    border-radius: 14px;
    border: 1px solid rgba(75,85,99,0.9);
    background: #020617;
    padding: 8px 9px;
    font-size: 11px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  #tab-cookie .cookie-card-header {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  #tab-cookie .cookie-project-logo {
    width: 30px;
    height: 30px;
    border-radius: 999px;
    border: 1px solid rgba(75,85,99,0.95);
    background: #020617;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    color: #9ca3af;
  }
  #tab-cookie .cookie-project-logo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  #tab-cookie .cookie-card-title-main {
    font-weight: 600;
  }
  #tab-cookie .cookie-card-title-sub {
    font-size: 10px;
    color: #9ca3af;
  }

  #tab-cookie .cookie-matrix {
    margin-top: 4px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  #tab-cookie .cookie-matrix-title {
    font-size: 10px;
    font-weight: 600;
    color: #e5e7ff;
    margin-bottom: 1px;
  }
  #tab-cookie .cookie-matrix-row {
    display: grid;
    grid-template-columns: repeat(4, minmax(0,1fr));
    gap: 3px;
  }
  #tab-cookie .cookie-matrix-cell {
    border-radius: 10px;
    border: 1px solid rgba(55,65,81,0.9);
    padding: 3px 5px;
    background: #020617;
  }
  #tab-cookie .metric-label {
    font-size: 9px;
    color: #9ca3af;
  }
  #tab-cookie .metric-value {
    font-size: 11px;
    font-weight: 600;
  }
  #tab-cookie .cookie-matrix-footer {
    margin-top: 3px;
    font-size: 10px;
    color: #9ca3af;
  }

  #tab-cookie .table-wrap {
    margin-top: 6px;
    overflow-x: auto;
  }
  #tab-cookie table.cookie-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
    min-width: 560px;
  }
  #tab-cookie table.cookie-table thead tr {
    border-bottom: 1px solid rgba(75,85,99,0.95);
  }
  #tab-cookie table.cookie-table th,
  #tab-cookie table.cookie-table td {
    padding: 5px 4px;
    text-align: left;
  }
  #tab-cookie table.cookie-table tbody tr {
    border-bottom: 1px solid rgba(31,41,55,0.85);
  }
  #tab-cookie table.cookie-table tbody tr:nth-child(odd) {
    background: rgba(15,23,42,0.6);
  }

  #tab-cookie .cookie-empty {
    font-size: 11px;
    color: rgba(148, 163, 184, 0.96);
    padding: 8px 2px;
  }

  @media (max-width: 900px) {
    #tab-cookie .cookie-layout {
      grid-template-columns: minmax(0,1fr);
    }
  }
  @media (max-width: 720px) {
    #tab-cookie .cookie-hero {
      padding: 12px 12px 9px;
    }
  }
  </style>

  <style>

  /* COMMUNITY tab – DC-style board layout */
  #tab-community .community-shell {
    width: 100%;
    max-width: 1280px;
    margin: 0 auto;
    padding: 8px 24px 24px;
    background: transparent;
    color: #f6f8ff;
}
  #tab-community .community-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    gap: 12px;
  }
  #tab-community .community-header-left {
    display: flex;
    flex-direction: column;
    gap: 3px;
  }
  #tab-community .community-title {
    font-size: 18px;
    font-weight: 700;
    color: #e5edff;
  }
  #tab-community .community-subtitle {
    font-size: 12px;
    color: #9ca3ff;
  }
  #tab-community .community-user {
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid #d1d5db;
    background: #f3f4f6;
    color: #111827;
    white-space: nowrap;
  }
  #tab-community .community-tabs-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
    gap: 8px;
    flex-wrap: wrap;
  }
  #tab-community .community-tabs {
    display: inline-flex;
    gap: 4px;
    padding: 3px;
    border-radius: 999px;
    background: #e5e7eb;
  }
  #tab-community .community-tab-btn {
    border: none;
    border-radius: 999px;
    padding: 5px 12px;
    font-size: 12px;
    cursor: pointer;
    background: transparent;
    color: #4b5563;
    transition: all 0.15s ease-out;
    white-space: nowrap;
  }
  #tab-community .community-tab-btn.active {
    background: #1f2937;
    color: #f9fafb;
  }
  #tab-community .community-tab-btn:not(.active):hover {
    background: rgba(17, 24, 39, 0.06);
  }
  #tab-community .community-write-toggle-row {
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  #tab-community .community-write-toggle-btn {
    border-radius: 4px;
    border: 1px solid #d1d5db;
    background: #111827;
    color: #f9fafb;
    font-size: 12px;
    padding: 5px 10px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  #tab-community .community-write-toggle-btn span.icon {
    font-size: 13px;
  }
  #tab-community .community-write-hint-mini {
    font-size: 11px;
    color: #9ca3af;
  }
  #tab-community .community-main {
    margin-top: 4px;
    border-radius: 14px;
    border: 1px solid rgba(148, 163, 255, 0.5);
    background: rgba(5, 10, 32, 0.95);
    padding: 0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  #tab-community .community-topbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 10px;
    border-bottom: 1px solid rgba(30, 64, 175, 0.9);
    background: rgba(15, 23, 42, 0.98);
    font-size: 12px;
    color: rgba(209, 213, 219, 0.96);
    gap: 8px;
    flex-wrap: wrap;
  }
  #tab-community .community-top-left {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }
  #tab-community .community-badge-board {
    padding: 2px 7px;
    border-radius: 999px;
    background: #f97316;
    color: #111827;
    font-size: 11px;
    font-weight: 600;
  }
  #tab-community .community-board-count-text {
    font-size: 11px;
    color: rgba(156, 163, 175, 0.96);
  }
  #tab-community .community-sort-toggle {
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  #tab-community .community-sort-btn {
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.9);
    background: transparent;
    color: rgba(209, 213, 219, 0.96);
    font-size: 11px;
    padding: 4px 10px;
    cursor: pointer;
  }
  #tab-community .community-sort-btn.active {
    background: rgba(129, 140, 248, 0.95);
    border-color: rgba(129, 140, 248, 1);
    color: #0b1022;
    font-weight: 600;
  }
  #tab-community .community-board-list-wrap {
    flex: 1;
    overflow-y: auto;
  }
  #tab-community .community-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    table-layout: fixed;
  }
  #tab-community .community-table thead {
    background: rgba(15, 23, 42, 0.98);
    position: sticky;
    top: 0;
    z-index: 2;
  }
  #tab-community .community-table th,
  #tab-community .community-table td {
    padding: 5px 6px;
    border-bottom: 1px solid rgba(31, 41, 55, 0.9);
    color: rgba(226, 232, 255, 0.96);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  #tab-community .community-table th {
    font-weight: 600;
    font-size: 11px;
    color: rgba(191, 219, 254, 0.96);
  }
  #tab-community .community-table tbody tr:hover {
    background: rgba(30, 64, 175, 0.45);
    cursor: pointer;
  }
  #tab-community .community-col-no { width: 56px; text-align: center; }
  #tab-community .community-col-title { width: auto; }
  #tab-community .community-col-writer { width: 130px; }
  #tab-community .community-col-date { width: 90px; text-align: center; }
  #tab-community .community-col-views { width: 60px; text-align: right; }
  #tab-community .community-col-likes { width: 60px; text-align: right; }
  #tab-community .community-title-inner {
    display: flex;
    align-items: center;
    gap: 4px;
    overflow: hidden;
  }
  #tab-community .community-title-text {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  #tab-community .community-reply-count {
    color: #ef4444;
    font-size: 11px;
  }
  #tab-community .community-best-mark {
    font-size: 11px;
    color: #f97316;
    font-weight: 700;
  }
  #tab-community .community-empty-row {
    text-align: center;
    color: #9ca3af;
    padding: 16px 0;
  }
  #tab-community .community-write-panel {
    border-top: 1px solid rgba(30, 64, 175, 0.9);
    background: rgba(15, 23, 42, 0.98);
    padding: 10px 10px 10px;
    display: none;
  }
  #tab-community .community-write-panel-inner {
    border-radius: 8px;
    border: 1px solid rgba(148, 163, 255, 0.7);
    background: rgba(15, 23, 42, 0.98);
    padding: 8px 10px 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  #tab-community .community-write-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    font-size: 12px;
  }
  #tab-community .community-write-label {
    font-size: 12px;
    color: #4b5563;
    min-width: 40px;
    padding-top: 6px;
  }
  #tab-community .community-write-input,
  #tab-community .community-write-textarea {
    flex: 1;
    border-radius: 4px;
    border: 1px solid rgba(55, 65, 81, 0.95);
    padding: 6px 7px;
    font-size: 12px;
    outline: none;
    background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.96));
    color: #e5e7eb;
  }
  #tab-community .community-write-textarea {
    resize: vertical;
    min-height: 100px;
    line-height: 1.5;
  }
  #tab-community .community-write-input:focus,
  #tab-community .community-write-textarea:focus {
    border-color: rgba(96, 165, 250, 0.96);
    box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.85);
  }
  #tab-community .community-write-bottom-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 4px;
  }
  #tab-community .community-write-hint {
    font-size: 11px;
    color: rgba(156, 163, 175, 0.96);
  }
  #tab-community .community-write-submit-btn {
    border-radius: 4px;
    border: 1px solid #111827;
    background: #111827;
    color: #f9fafb;
    font-size: 12px;
    padding: 6px 14px;
    cursor: pointer;
    font-weight: 600;
  }
  #tab-community .community-write-submit-btn:disabled {
    opacity: 0.6;
    cursor: default;
  }
  #tab-community .community-footerbar {
    padding: 6px 10px 4px;
    border-top: 1px solid rgba(30, 64, 175, 0.9);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 11px;
    background: rgba(15, 23, 42, 0.98);
    gap: 8px;
    flex-wrap: wrap;
  }
  #tab-community .community-paging-dots {
    display: inline-flex;
    gap: 4px;
    align-items: center;
  }
  #tab-community .community-paging-dot {
    width: 18px;
    height: 18px;
    border-radius: 4px;
    border: 1px solid #d1d5db;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    cursor: pointer;
    background: #ffffff;
  }
  #tab-community .community-paging-dot.active {
    background: #111827;
    color: #f9fafb;
  }
  #tab-community .community-footer-write-btn {
    border-radius: 4px;
    border: 1px solid #d1d5db;
    background: #111827;
    color: #f9fafb;
    font-size: 12px;
    padding: 5px 12px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  @media (max-width: 900px) {
    #tab-community .community-col-writer { display: none; }
  }

  </style>

  <style>
    .guide-card {
      max-width: 1180px;
      margin: 0 auto 18px;
      padding: 18px 20px 16px;
      border-radius: 22px;
      background: linear-gradient(145deg, rgba(10, 18, 40, 0.96), rgba(5, 8, 24, 0.98));
      box-shadow:
        0 26px 48px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(15, 25, 60, 0.9);
      position: relative;
      overflow: hidden;
      color: #f6f8ff;
    }
    .guide-card::before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      padding: 1px;
      background: linear-gradient(120deg, #ff4ba7, #4ae0ff, #4370ff);
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
              mask-composite: exclude;
      opacity: 0.9;
      pointer-events: none;
    }
    .guide-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }
    .guide-tab-btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(150, 170, 220, 0.4);
      background: rgba(255, 255, 255, 0.05);
      color: #dce2ff;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
      transition: all 0.15s ease-out;
    }
    .guide-tab-btn.active {
      background: linear-gradient(135deg, #ff4ba7, #5ee0ff);
      color: #050612;
      font-weight: 600;
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.85);
      border-color: transparent;
    }
    .guide-panel { display: none; }
    .guide-panel.active { display: block; }

    .guide-section-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .guide-section-sub {
      font-size: 13px;
      margin-bottom: 14px;
      color: rgba(200, 208, 240, 0.96);
    }
    .guide-step {
      background: rgba(20, 26, 48, 0.9);
      border: 1px solid rgba(70, 80, 120, 0.55);
      border-radius: 12px;
      padding: 10px 12px;
      margin-bottom: 8px;
    }
    .guide-step-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .guide-step-body {
      font-size: 12px;
      line-height: 1.55;
      color: rgba(211, 219, 255, 0.98);
    }
  </style>
  <style>
#tab-csv .wrap {max-width: 1100px;
      margin: 24px auto 40px;
      padding: 16px 20px 32px;
      border-radius: 24px;
      background: radial-gradient(circle at 10% 0%, rgba(236,72,153,.16), transparent 55%),
                  radial-gradient(circle at 90% 0%, rgba(56,189,248,.12), transparent 55%),
                  rgba(15,23,42,.96);
      box-shadow: 0 24px 60px rgba(15,23,42,.9);}
#tab-csv h1 {margin: 0 0 8px;
      font-size: 24px;
      font-weight: 700;}
#tab-csv .subtitle {font-size: 13px;
      color: #9ca3af;
      margin-bottom: 18px;}
#tab-csv .csv-main-tabs {display: inline-flex;
      border-radius: 999px;
      padding: 4px;
      background: rgba(15,23,42,0.9);
      box-shadow: inset 0 0 0 1px rgba(148,163,184,0.35);
      margin-bottom: 18px;}
#tab-csv .csv-main-btn {border: none;
      background: transparent;
      color: #e5e7eb;
      font-size: 13px;
      padding: 6px 14px;
      border-radius: 999px;
      cursor: pointer;}
#tab-csv .csv-main-btn.active {background: linear-gradient(90deg, #ec4899, #22d3ee);
      color: #0f172a;
      font-weight: 600;
      box-shadow: 0 0 0 1px rgba(15,23,42,0.6);}
#tab-csv .csv-main-panel {display: none;}
#tab-csv .csv-main-panel.active {display: block;}
#tab-csv .card {margin-top: 12px;
      background: rgba(15,23,42,0.96);
      border-radius: 16px;
      padding: 14px 16px 18px;
      box-shadow: 0 14px 38px rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.35);}
#tab-csv .card h2 {margin: 0 0 6px;
      font-size: 16px;}
#tab-csv .card small {font-size: 12px;
      color: #9ca3af;}
#tab-csv .row {display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px dashed rgba(55,65,81,0.9);
      font-size: 13px;}
#tab-csv .row:last-child {border-bottom: none;}
#tab-csv .pill {min-width: 90px;
      text-align: center;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);}
#tab-csv input[type="file"] {font-size: 12px;}
#tab-csv .analyze-btn {cursor: pointer;}
#tab-csv .grid-2 {display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.5fr);
      gap: 14px;
      margin-top: 12px;}
#tab-csv .range-bar {display: flex;
      gap: 6px;
      margin-bottom: 6px;}
#tab-csv .csv-range-btn {font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: transparent;
      color: #e5e7eb;
      cursor: pointer;}
#tab-csv .csv-range-btn.active {background: rgba(56,189,248,0.15);
      border-color: rgba(56,189,248,0.9);}
#tab-csv canvas {width: 100% !important;
      height: 320px !important;}
#tab-csv table {width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 12px;}
#tab-csv th, #tab-csv td {border-bottom: 1px solid rgba(31,41,55,0.9);
      padding: 4px 6px;
      text-align: left;}
#tab-csv th {color: #9ca3af;
      font-weight: 500;
      font-size: 11px;}
#tab-csv .coach-text {white-space: pre-line;
      font-size: 13px;
      line-height: 1.5;}
#tab-csv #csvScoreChart {cursor: pointer;}
  </style>



  <!-- 프로젝트별 마인드쉐어 스타일 -->
<style>
    

    

    

    .page-shell {
      width: 1200px;
      max-width: 100%;
    }

    .top-nav {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 16px;
      margin-bottom: 12px;
    }

    .top-title {
      font-size: 20px;
      font-weight: 700;
    }

    .top-sub {
      font-size: 13px;
      color: var(--text-sub);
      margin-top: 4px;
    }

    .section-note {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .card {
      background: linear-gradient(145deg, rgba(15,23,42,0.96), rgba(15,23,42,0.9));
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      padding: 18px 20px 20px;
    }

    .card-soft {
      background: radial-gradient(circle at top left, rgba(56,189,248,0.08), rgba(15,23,42,0.96));
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .section-sub {
      font-size: 12px;
      color: var(--text-sub);
    }

    .project-charts-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 16px;
      margin-bottom: 18px;
    }

    .project-chart-single {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 16px;
      padding: 12px 12px 4px;
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .project-chart-title {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 4px;
    }

    .table-wrap {
      margin-top: 8px;
      background: rgba(15, 23, 42, 0.85);
      border-radius: 14px;
      border: 1px solid rgba(30, 64, 175, 0.6);
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: rgba(15, 23, 42, 0.95);
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid rgba(30, 64, 175, 0.45);
      text-align: left;
      color: var(--text-main);
    }

    th {
      font-weight: 600;
      font-size: 11px;
      color: var(--text-sub);
    }

    tr:nth-child(even) td {
      background: rgba(15,23,42,0.92);
    }

    .empty {
      padding: 16px 14px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .project-detail-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-top: 16px;
      font-size: 12px;
      color: var(--text-sub);
    }

    .project-select {
      min-width: 220px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      font-size: 12px;
      outline: none;
    }

    .tier-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 22px;
      height: 22px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      padding: 0 8px;
      background: var(--chip-bg);
      border: 1px solid rgba(148,163,184,0.6);
    }

    .tier-S { background: radial-gradient(circle at top, #facc15, #b45309); color:#111827; }
    .tier-A { background: radial-gradient(circle at top, #22c55e, #15803d); }
    .tier-B { background: radial-gradient(circle at top, #38bdf8, #0369a1); }
    .tier-C { background: radial-gradient(circle at top, #a855f7, #6b21a8); }

    .tweet-text {
      max-width: 620px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .metric-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.5);
      color: var(--text-sub);
      gap: 4px;
    }

    .link-btn {
      font-size: 11px;
      padding: 4px 11px;
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,0.9);
      background: rgba(15,23,42,0.95);
      color: #e0f2fe;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 4px; /* 오른쪽 잘림 방지 여백 */
      box-sizing: border-box;
    }

    .link-btn:hover {
      background: rgba(56,189,248,0.15);
    }

    .pill-hint {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px dashed rgba(148,163,184,0.6);
      color: var(--text-muted);
    }

    @media (max-width: 960px) {
      .project-charts-row {
        grid-template-columns: minmax(0, 1fr);
      }
      #tab-project {
        padding: 16px;
      }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
  <div class="muddha-login-overlay" id="muddhaLoginOverlay">
    <div class="muddha-login-card">
      <div class="muddha-login-logo">
        <div class="muddha-login-logo-mark"></div>
        <div>
          <div class="muddha-login-logo-main">MUDDHA Mindshare</div>
          <div class="muddha-login-logo-sub">네온 대시보드에 들어가기 전에 로그인해요</div>
        </div>
      </div>
      <div class="muddha-login-tabs">
        <button class="muddha-login-tab active" id="muddhaTabLogin">로그인</button>
        <button class="muddha-login-tab" id="muddhaTabSignup">회원가입</button>
      </div>
      <div class="muddha-login-title" id="muddhaLoginTitle">MUDDHA 로그인</div>
      <div class="muddha-login-sub" id="muddhaLoginDesc">
        아이디는 이메일 형식이 아니어도 돼요. 내부적으로 <b>@muddha-id.com</b>이 자동으로 붙어서 Supabase에 저장됩니다.
      </div>
      <div class="muddha-login-form">
        <div id="muddhaLoginFields">
          <div>
            <div class="muddha-login-label">아이디</div>
            <input class="muddha-login-input" id="loginId" placeholder="예: buddha" autocomplete="username"/>
          </div>
          <div>
            <div class="muddha-login-label">비밀번호</div>
            <input class="muddha-login-input" id="loginPassword" type="password" placeholder="비밀번호" autocomplete="current-password"/>
          </div>
        </div>
        <div id="muddhaSignupFields" style="display:none;">
          <div>
            <div class="muddha-login-label">아이디</div>
            <input class="muddha-login-input" id="signupId" placeholder="예: buddha" autocomplete="username"/>
          </div>
          <div>
            <div class="muddha-login-label">비밀번호</div>
            <input class="muddha-login-input" id="signupPassword" type="password" placeholder="8자 이상" autocomplete="new-password"/>
          </div>
          <div>
            <div class="muddha-login-label">비밀번호 확인</div>
            <input class="muddha-login-input" id="signupPasswordConfirm" type="password" placeholder="다시 한 번 입력" autocomplete="new-password"/>
          </div>
          <div>
            <div class="muddha-login-label">닉네임</div>
            <input class="muddha-login-input" id="signupNickname" placeholder="예: Buddha, 부처님 등"/>
          </div>
          <div>
            <div class="muddha-login-label">트위터 핸들 (@ 없이, 필수)</div>
            <input class="muddha-login-input" id="signupHandle" placeholder="예: bud_dha__"/>
          </div>
        </div>
        <div class="muddha-login-error" id="muddhaLoginError"></div>
        <div class="muddha-login-actions">
          <button class="muddha-login-button" id="muddhaLoginButton">로그인</button>
          <button class="muddha-login-button" id="muddhaSignupButton" style="display:none;">회원가입 완료하기</button>
        </div>
      </div>
      <div class="muddha-login-footer">
        <span>로그인 후 이 네온 대시보드를 그대로 사용하게 될 거예요.</span>
        <a href="https://x.com/bud_dha__" target="_blank">문의 / 피드백</a>
      </div>
    </div>
  </div>

  <div class="app-shell">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo-block">
        <div class="logo-title">MUDDHA</div>
        <div class="logo-sub">Mindshare Analyzer</div>
        <div class="live-pill">
          <span class="live-dot"></span>
          <span>LIVE</span>
        </div>
      </div>

      <!-- OVERVIEW -->
      <div>
        <div class="sidebar-section-title">Overview</div>
        <div class="nav-list">
          <button class="nav-item active" data-target="tab-dashboard">
            <span class="icon">📊</span>
            <span>대시보드</span>
          </button>
          <button class="nav-item" data-target="tab-guide">
            <span class="icon">📘</span>
            <span>사용방법</span>
          </button>
        </div>
      </div>

      <!-- ANALYZER -->
      <div>
        <div class="sidebar-section-title">Analyzer</div>
        <div class="nav-list">
          <button class="nav-item" data-target="tab-csv">
            <span class="icon">📂</span>
            <span>CSV 분석</span>
          </button>
          <button class="nav-item" data-target="tab-project">
            <span class="icon">📌</span>
            <span>프로젝트별 마인드쉐어</span>
          </button>
          <button class="nav-item" data-target="tab-planner">
            <span class="icon">🗓</span>
            <span>야핑 플래너</span>
          </button>
        </div>
      </div>

      <!-- KAITO -->
      <div>
        <div class="sidebar-section-title">KAITO</div>
        <div class="nav-list">
          <button class="nav-item" data-target="tab-kaito">
            <span class="icon">🧠</span>
            <span>KAITO 리더보드</span>
          </button>
          <button class="nav-item" data-target="tab-yap">
            <span class="icon">📈</span>
            <span>YAPS +</span>
          </button>
        </div>
      </div>

      <!-- COOKIE -->
      <div>
        <div class="sidebar-section-title">COOKIE</div>
        <div class="nav-list">
          <button class="nav-item" data-target="tab-cookie">
            <span class="icon">🍪</span>
            <span>Cookie 리더보드</span>
          </button>
        </div>
      </div>

      <!-- COMMUNITY & PROFILE -->
      <div>
        <div class="sidebar-section-title">Me & Community</div>
        <div class="nav-list">
          <button class="nav-item" data-target="tab-community">
            <span class="icon">💬</span>
            <span>커뮤니티</span>
          </button>
          <button class="nav-item" data-target="tab-profile">
            <span class="icon">👤</span>
            <span>내 프로필</span>
          </button>
        </div>
      </div>

      <div class="sidebar-footer">
        현재 로그인: <b>buddha</b><br />
        이 아이디 기준으로 KAIT0 / COOKIE / CSV 데이터를<br />
        하나의 마인드쉐어로 묶어볼 수 있어요.
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <header class="top-bar">
        <div class="top-left">
          <div class="top-title">대시보드</div>
          <div class="top-subtitle">로그인 후 한 눈에 보는 내 Mindshare 요약</div>
        </div>
        <div class="top-right">
          <button class="pill-btn">최근 30일 기준</button>
          <button class="pill-btn secondary">로그아웃</button>
        </div>
      </header>

      <section class="content-scroll" id="scrollContainer">
        <!-- Dashboard -->
        <section class="tab-panel active" id="tab-dashboard">
          <!-- 메인 Mindshare 카드 -->
          <article class="card-main">
            <div class="card-header-line">
              <div>
                <div class="card-title-main">나의 크리에이터 마인드쉐어</div>
                <div class="card-title-sub">트림드 점수 · YAP 추정치 · 활동 분포를 종합한 핵심 스냅샷</div>
              </div>
              <div class="card-chip">+12.4% · 지난 주 대비</div>
            </div>
            <div class="card-body-grid">
              <div>
                <div class="score-main">72.3</div>
                <div class="score-range">예상 YAP 밴드 · 68 – 76 구간</div>
                <div class="score-caption">
                  최근 30일 동안의 야핑 중 가치 있는 신호만 추려낸
                  <b>Trimmed Score</b> 흐름을 기반으로 InfoFi 스타일의
                  평판 궤적을 추정한 점수야.
                </div>
              </div>
              <div class="metric-list">
                <div class="metric-row">
                  <span class="metric-label">트림드 점수</span>
                  <span class="metric-value-pill">64점</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">인너 서클 비율</span>
                  <span class="metric-value-pill">38.2%</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">아웃터 서클 확장</span>
                  <span class="metric-value-pill">+21 월드</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">실제 Kaito YAP</span>
                  <span class="metric-value-pill" id="dashboardYapReal">-</span>
                </div>
              </div>
            </div>
          </article>

          <!-- 2x2 대시보드 카드 프리뷰 -->
          <div class="dash-grid">
            <!-- 카이토/쿠키 프로젝트 리더보드 요약 -->
            <article class="dash-card">
              <div class="dash-card-header">
                <div class="dash-card-title">내 프로젝트 리더보드 포지션</div>
                <div class="dash-card-tag">KAITO · Tier1 Creator</div>
              </div>
              <div class="dash-card-body">
                <div id="kaito-dashboard-slider" class="kaito-slider-wrap">
                  <div class="kaito-slider-empty">
                    로그인 후 KAITO 리더보드 데이터가 연결되면,
                    이 영역에 네가 속한 Tier1(크리에이터) 프로젝트들이
                    가로 슬라이더 카드로 자동으로 나타날 거야.
                  </div>
                </div>
              </div>
            </article>

            <!-- 평균점수 / 트림드 점수 카드 -->
            <article class="dash-card">
              <div class="dash-card-header">
                <div class="dash-card-title">내 점수 스냅샷</div>
                <div class="dash-card-tag">Score · Trimmed</div>
              </div>
              <div class="dash-card-body">
                최근 기준 평균 점수와 트림드 점수를 빠르게 보는 카드.
                <div class="kpi-row">
                  <div class="kpi-pill">평균 Score · 58.4</div>
                  <div class="kpi-pill">Trimmed · 64.0</div>
                  <div class="kpi-pill">변동폭 · +7.2</div>
                </div>
              </div>
            </article>

            
            <!-- 야핑 타임라인 위젯 (주간/월간) -->
            <section class="dash-yap-section">
              <header class="dash-yap-header">
                <div>
                  <div class="dash-yap-title">야핑 타임라인</div>
                  <div class="dash-yap-sub">
                    이번 주와 이번 달에 예정된 야핑 계획을 한 번에 정리해서 보여주는 뷰.
                  </div>
                </div>
                <div class="dash-yap-controls">
                  <div class="dash-yap-tabs">
                    <button class="dash-yap-tab active" data-view="week">주간 보드</button>
                    <button class="dash-yap-tab" data-view="month">월간 캘린더</button>
                  </div>
                  <div class="dash-yap-nav-wrap">
                    <button class="dash-yap-nav" data-dir="prev">◀</button>
                    <span id="dashYapLabel" class="dash-yap-range"></span>
                    <button class="dash-yap-nav" data-dir="next">▶</button>
                  </div>
                </div>
              </header>

              <div class="dash-yap-body">
                <div id="dashYapWeekView">
                  <div id="dashYapEmptyWeek" class="dash-yap-empty">
                    아직 이번 주에 남아있는 야핑 계획이 없어요.<br/>
                    왼쪽 사이드탭의 야핑 플래너에서 새 계획을 추가하면 이곳에 자동으로 나타납니다.
                  </div>
                  <div id="dashYapWeekGrid" class="dash-yap-week-grid"></div>
                </div>

                <div id="dashYapMonthView" style="display:none;">
                  <div id="dashYapEmptyMonth" class="dash-yap-empty">
                    이번 달 기준으로 남아있는 야핑 계획이 아직 없어요.
                  </div>
                  <div id="dashYapMonthGrid" class="dash-yap-month-grid"></div>
                </div>
              </div>
            </section>

          </div>
        </section>

        <!-- 다른 탭들은 예전과 같은 placeholder -->
        
        <section class="tab-panel" id="tab-guide">
          <div class="guide-card">
            <div class="guide-tabs">
              <button class="guide-tab-btn active" data-guide="g1">전체 흐름</button>
              <button class="guide-tab-btn" data-guide="g2">CSV 분석기</button>
              <button class="guide-tab-btn" data-guide="g3">야핑 플래너</button>
              <button class="guide-tab-btn" data-guide="g4">리더보드</button>
              <button class="guide-tab-btn" data-guide="g5">FAQ</button>
            </div>

            <div class="guide-panel active" id="g1">
              <div class="guide-section-title">전체 흐름 안내</div>
              <div class="guide-section-sub">MUDDHA는 활동 데이터와 외부 평가 지표를 기반으로 사용자 활동의 흐름을 파악할 수 있는 분석 도구입니다.</div>

              <div class="guide-step">
                <div class="guide-step-title">1) 대시보드 확인</div>
                <div class="guide-step-body">로그인 후 표시되는 대시보드에서 최근 활동 지표와 전체적인 변화 흐름을 확인할 수 있습니다.</div>
              </div>

              <div class="guide-step">
                <div class="guide-step-title">2) CSV 파일 분석</div>
                <div class="guide-step-body">CSV 파일을 업로드하면 게시글이 자동 분석되며 활동패턴, 점수 그래프, 티어 분류 등이 생성됩니다.</div>
              </div>

              <div class="guide-step">
                <div class="guide-step-title">3) 야핑 플래너 활용</div>
                <div class="guide-step-body">프로젝트별로 향후 활동 계획을 정리하고 관리할 수 있습니다.</div>
              </div>

              <div class="guide-step">
                <div class="guide-step-title">4) 리더보드 비교</div>
                <div class="guide-step-body">외부 서비스의 평가 지표와 내부 분석 결과를 함께 참고할 수 있습니다.</div>
              </div>
            </div>

            <div class="guide-panel" id="g2">
              <div class="guide-section-title">CSV 분석기 사용 방법</div>
              <div class="guide-section-sub">업로드된 게시글 데이터를 분석하여 점수, 패턴, 티어 정보를 제공합니다.</div>

              <div class="guide-step">
                <div class="guide-step-title">1) CSV 업로드</div>
                <div class="guide-step-body">트윗 데이터를 포함한 CSV 파일을 업로드하면 필드가 자동 매핑됩니다.</div>
              </div>

              <div class="guide-step">
                <div class="guide-step-title">2) 분석하기 실행</div>
                <div class="guide-step-body">‘분석하기’를 선택하면 점수 계산과 패턴 분석이 진행됩니다.</div>
              </div>

              <div class="guide-step">
                <div class="guide-step-title">3) 분석 결과 확인</div>
                <div class="guide-step-body">활동패턴, 티어 분류, 대표 게시글 Top10 등 다양한 분석 결과를 확인할 수 있습니다.</div>
              </div>
            </div>

            <div class="guide-panel" id="g3">
              <div class="guide-section-title">야핑 플래너 사용 방법</div>
              <div class="guide-section-sub">프로젝트별 향후 활동 계획을 정리하는 기능입니다.</div>

              <div class="guide-step">
                <div class="guide-step-title">1) 프로젝트 등록</div>
                <div class="guide-step-body">프로젝트 정보를 입력하여 리스트에 추가합니다.</div>
              </div>

              <div class="guide-step">
                <div class="guide-step-title">2) 목표 설정</div>
                <div class="guide-step-body">프로젝트별 활동 목표를 설정하여 계획을 구성할 수 있습니다.</div>
              </div>

              <div class="guide-step">
                <div class="guide-step-title">3) 일정 확인</div>
                <div class="guide-step-body">월간 그리드를 통해 남은 계획을 확인할 수 있습니다.</div>
              </div>
            </div>

            <div class="guide-panel" id="g4">
              <div class="guide-section-title">리더보드 안내</div>
              <div class="guide-section-sub">외부 InfoFi 서비스 데이터를 조회하여 개인 평가를 확인할 수 있습니다.</div>

              <div class="guide-step">
                <div class="guide-step-title">1) 핸들 조회</div>
                <div class="guide-step-body">X 계정 아이디를 입력하면 KAITO, COOKIE, 곰투 등의 데이터를 조회할 수 있습니다.</div>
              </div>

              <div class="guide-step">
                <div class="guide-step-title">2) 지표 확인</div>
                <div class="guide-step-body">점수, 티어, 순위 등 다양한 지표를 확인할 수 있습니다.</div>
              </div>

              <div class="guide-step">
                <div class="guide-step-title">3) 데이터 비교</div>
                <div class="guide-step-body">CSV 분석 결과와 외부 평가를 함께 참고하여 전략을 조정할 수 있습니다.</div>
              </div>
            </div>

            <div class="guide-panel" id="g5">
              <div class="guide-section-title">FAQ</div>
              <div class="guide-section-sub">자주 묻는 질문을 정리했습니다.</div>

              <div class="guide-step">
                <div class="guide-step-title">CSV 업로드 후 변화가 없습니다.</div>
                <div class="guide-step-body">분석하기 버튼을 다시 실행합니다. 필요 시 브라우저 저장소 초기화를 권장합니다.</div>
              </div>

              <div class="guide-step">
                <div class="guide-step-title">데이터는 저장되나요?</div>
                <div class="guide-step-body">CSV 분석은 브라우저에서 처리되며 서버에 자동 저장되지 않습니다.</div>
              </div>

              <div class="guide-step">
                <div class="guide-step-title">점수 기준은 무엇인가요?</div>
                <div class="guide-step-body">좋아요, 인용, 답글 등의 데이터를 기반으로 가중치를 적용하여 계산됩니다.</div>
              </div>
            </div>
          </div>
        </section>


        
                <section class="tab-panel" id="tab-csv">
          <div class="wrap">
              <h1>CSV 분석 · 최소 안정 버전</h1>
              <div class="subtitle">X/Twitter CSV를 업로드해서 SCORE/패턴/티어/코치봇을 확인하는 테스트 빌드.</div>

              <div class="csv-main-tabs">
                <button class="csv-main-btn active" data-csv-main="upload">CSV 업로드</button>
                <button class="csv-main-btn" data-csv-main="score">SCORE 그래프</button>
                <button class="csv-main-btn" data-csv-main="tier">티어별 분류</button>
                <button class="csv-main-btn" data-csv-main="coach">코치봇</button>
              </div>

              <!-- 업로드 -->
              <div class="csv-main-panel active" id="csv-main-upload">
                <div class="card">
                  <h2>STEP 1 · CSV 업로드</h2>
                  <small>콘텐츠 탭에서 받은 CSV 파일을 선택하고 분석을 실행합니다.</small>
                  <div class="row">
                    <span>CSV 파일 선택</span>
                    <span class="pill"><input id="csvFileInput" type="file" accept=".csv"></span>
                  </div>
                  <div class="row">
                    <span>분석 모드</span>
                    <span class="pill">
                      <select id="csvModeSelect" class="csv-mode-select">
                        <option value="MY">내 계정 분석 (저장)</option>
                        <option value="TEMP">임시 분석 (저장 안함)</option>
                      </select>
                    </span>
                  </div>
                  <div class="row">
                    <span>분석 시작</span>
                    <span class="pill analyze-btn" id="csvAnalyzeButton">분석하기</span>
                  </div>
                  <div class="row">
                    <span>최근 저장</span>
                    <span class="pill" id="csvLastSaveSummary">저장된 분석 없음</span>
                  </div>
                </div>

                <div class="grid-2">
                  <div class="card">
                    <h2>기본 통계 요약</h2>
                    <small>CSV에서 감지한 기본 정보</small>
                    <div id="csvSummaryBox" style="margin-top:8px; font-size:13px;">
                      아직 CSV를 업로드하지 않았어요.<br>
                      파일을 선택하고 <b>분석하기</b>를 누르면<br>
                      · 총 행 수<br>
                      · 헤더 컬럼 수<br>
                      · 날짜 컬럼 이름<br>
                      같은 기본 정보부터 보여줄게요.
                    </div>
                  </div>
                  <div class="card">
                    <h2>SCORE 개요</h2>
                    <small>날짜별 Trimmed Score 흐름의 요약</small>
                    <div id="csvScoreInfo" style="margin-top:8px; font-size:13px;">
                      아직 분석 결과가 없습니다.
                    </div>
                  </div>
                </div>
              </div>

              <!-- SCORE -->
              <div class="csv-main-panel" id="csv-main-score">
                <div class="card">
                  <h2>STEP 2 · SCORE 그래프</h2>
                  <small>날짜별 평균 Trimmed Score와 대표 트윗</small>
                  <div class="range-bar" style="margin-top:10px;">
                    <button class="csv-range-btn" data-range="7">7D</button>
                    <button class="csv-range-btn" data-range="30">30D</button>
                    <button class="csv-range-btn" data-range="60">60D</button>
                    <button class="csv-range-btn" data-range="90">90D</button>
                    <button class="csv-range-btn active" data-range="all">TOTAL</button>
                  </div>
                  <div class="month-filter" style="margin-top:6px; display:flex; align-items:center; gap:6px; font-size:11px;">
                    <span style="opacity:0.7;">월별 필터</span>
                    <select id="csvMonthFilter" style="font-size:11px; padding:2px 6px; border-radius:4px; background:#020617; color:#e5e7eb; border:1px solid #1f2937;">
                      <option value="ALL">전체</option>
                    </select>
                  </div>
                  <canvas id="csvScoreChart" height="320"></canvas>
                  <div class="card" style="margin-top:14px; padding:10px 12px;">
                    <div style="font-size:13px; font-weight:600; margin-bottom:4px;">선택된 트윗</div>
                    <div id="csvScoreDetailBody" style="font-size:13px;">
                      그래프 위의 점을 클릭하면, 해당 날짜에서 가장 대표적인 트윗이 여기에 표시됩니다.
                    </div>
                  </div>
                </div>
              </div>

              <!-- 티어 -->
              <div class="csv-main-panel" id="csv-main-tier">
                <div class="card">
                  <h2>STEP 4 · 티어 분석</h2>
                  <small>마인드쉐어 폭발 Top 10과 등급별 상위 게시글을 한 번에 보는 뷰</small>

                  <!-- 마인드쉐어 폭발 Top 10 -->
                  <div style="margin-top:16px;">
                    <h3 style="font-size:14px; margin-bottom:4px;">
                      ⭐ 마인드쉐어 폭발 Top 10
                      <span id="tierExplosionCountLabel" style="font-weight:400; font-size:12px; opacity:0.9;">(0 / 0)</span>
                    </h3>
                    <small>각 트윗의 SCORE 기준 상위 10개 대표 트윗 리스트입니다.</small>
                    <table class="tier-table" style="margin-top:8px;">
                      <thead>
                        <tr>
                          <th style="width:40px;">#</th>
                          <th style="width:50px;">등급</th>
                          <th>본문</th>
                          <th style="width:70px;">점수</th>
                          <th style="width:130px;">반응</th>
                          <th style="width:90px;">날짜</th>
                          <th style="width:90px;">링크</th>
                        </tr>
                      </thead>
                      <tbody id="tierExplosionBody">
                        <tr><td colspan="7">CSV 분석 후 상위 10일이 자동으로 계산됩니다.</td></tr>
                      </tbody>
                    </table>
                  </div>

                  <!-- 등급별 상위 게시글 -->
                  <div style="margin-top:24px;">
                    <h3 style="font-size:14px; margin-bottom:4px;">📊 등급별 상위 게시글 (S~D)</h3>
                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
                      <div style="margin:6px 0;">
                        <button class="csv-main-btn tier-filter-btn active" data-tier-filter="ALL">전체</button>
                        <button class="csv-main-btn tier-filter-btn" data-tier-filter="S">S 등급</button>
                        <button class="csv-main-btn tier-filter-btn" data-tier-filter="A">A 등급</button>
                        <button class="csv-main-btn tier-filter-btn" data-tier-filter="B">B 등급</button>
                        <button class="csv-main-btn tier-filter-btn" data-tier-filter="C">C 등급</button>
                        <button class="csv-main-btn tier-filter-btn" data-tier-filter="D">D 등급</button>
                      </div>
                      <small style="opacity:0.8;">S 상위 5% · A 상위 20% · B 상위 40% · C 상위 60% · D 그 외</small>
                    </div>
                    <table class="tier-table" style="margin-top:8px;">
                      <thead>
                        <tr>
                          <th style="width:40px;">#</th>
                          <th style="width:50px;">등급</th>
                          <th>본문</th>
                          <th style="width:70px;">점수</th>
                          <th style="width:130px;">반응</th>
                          <th style="width:90px;">날짜</th>
                          <th style="width:90px;">링크</th>
                        </tr>
                      </thead>
                      <tbody id="tierGradeBody">
                        <tr><td colspan="6">CSV 분석 후 티어별 상위 게시글이 여기에 표시됩니다.</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- 코치봇 -->
              <div class="csv-main-panel" id="csv-main-coach">
                <div class="card">
                  <h2>STEP 5 · 코치봇</h2>
                  <small>CSV 분석 결과를 요약해서 말해주는 피드백 영역</small>
                  <div id="csvCoachText" class="coach-text" style="margin-top:10px;">
                    CSV를 업로드하고 분석을 실행하면, 이곳에 활동 요약과 강점/약점, 다음 액션이 자동으로 채워집니다.
                  </div>
                </div>
              </div>

            </div>

            <script>

          // === 점수/등급 계산: 옛날 분석기와 동일한 로직 ===
          var TRIM_RATIO = 0.1;
          window.csvAllPosts = [];

          function assignGrades(list) {
            if (!list || !list.length) return;
            list.sort(function(a, b){ return b.score - a.score; });
            var N = list.length || 1;
            for (var i = 0; i < list.length; i++) {
              var p = list[i];
              var pct = N > 1 ? 1 - i / (N - 1) : 1;
              p.percentile = Math.round(pct * 100);
              var g =
                pct >= 0.95 ? "S" :
                pct >= 0.80 ? "A" :
                pct >= 0.60 ? "B" :
                pct >= 0.40 ? "C" : "D";
              p.grade = g;
              p.tier = g; // 기존 티어 필드와 호환
            }
          }

          function computeTrimmedAverage(list, ratio) {
            if (!list || !list.length) return 0;
            var scores = list.map(function(p){ return p.score; })
                             .sort(function(a, b){ return a - b; });
            var n = scores.length;
            var k = Math.floor(n * ratio);
            if (k * 2 >= n) k = 0;
            var trimmed = scores.slice(k, n - k);
            var sum = trimmed.reduce(function(s, v){ return s + v; }, 0);
            return trimmed.length ? (sum / trimmed.length) : 0;
          }

          // 전체 포스트 기준으로 등급/티어를 다시 계산해서 티어 테이블에 반영
          function recomputeTierFromPosts() {
            var posts = (window.csvAllPosts || []).slice();
            var summaryCounts = { S:0, A:0, B:0, C:0, D:0 };

            if (!posts.length) {
              window.csvTierSummary = { counts: summaryCounts, rows: [] };
              if (typeof renderTierExplosionTop === "function") renderTierExplosionTop();
              if (typeof renderTierFilterList === "function") renderTierFilterList("ALL");
              return;
            }

            assignGrades(posts);

            for (var i = 0; i < posts.length; i++) {
              var g = posts[i].grade;
              if (summaryCounts[g] != null) summaryCounts[g] += 1;
            }

            window.csvTierSummary = {
              counts: summaryCounts,
              rows: posts
            };

            if (typeof renderTierExplosionTop === "function") renderTierExplosionTop();
            if (typeof renderTierFilterList === "function") renderTierFilterList("ALL");
          }

          // CSV 분석: 업로드 + 기본 통계 + 저장 + 상단 탭 전환 (간소화 버전)
              document.addEventListener("DOMContentLoaded", function () {
                // ---- CSV 상단 서브탭 전환 ----

                const monthFilterSelect = document.getElementById("csvMonthFilter");
                if (monthFilterSelect) {
                  monthFilterSelect.addEventListener("change", function () {
                    var v = monthFilterSelect.value || "ALL";
                    rebuildCsvViewForMonth(v);
                  });
                }

                const csvPanels = document.querySelectorAll(".csv-main-panel");
                const csvButtons = document.querySelectorAll(".csv-main-btn");

                const tierFilterButtons = document.querySelectorAll(".tier-filter-btn");
                function setupTierFilterButtons() {
                  if (!tierFilterButtons || !tierFilterButtons.length) return;
                  tierFilterButtons.forEach(function (btn) {
                    btn.addEventListener("click", function () {
                      tierFilterButtons.forEach(function (b) { b.classList.remove("active"); });
                      btn.classList.add("active");
                      var t = btn.getAttribute("data-tier-filter") || "ALL";
                      if (typeof renderTierFilterList === "function") {
                        renderTierFilterList(t);
                      }
                    });
                  });
                }
                setupTierFilterButtons();



                function showCsvPanel(name) {
                  csvPanels.forEach(function (panel) {
                    if (panel.id === "csv-main-" + name) {
                      panel.classList.add("active");
                    } else {
                      panel.classList.remove("active");
                    }
                  });
                  csvButtons.forEach(function (btn) {
                    if (btn.dataset.csvMain === name) {
                      btn.classList.add("active");
                    } else {
                      btn.classList.remove("active");
                    }
                  });
                }

                csvButtons.forEach(function (btn) {
                  btn.addEventListener("click", function () {
                    var name = btn.dataset.csvMain;
                    if (name) showCsvPanel(name);
                  });
                });

                // 기본은 업로드 패널
                showCsvPanel("upload");

                // ---- CSV 업로드 & 그래프 ----
                var fileInput = document.getElementById("csvFileInput");
                var analyzeBtn = document.getElementById("csvAnalyzeButton");
                var summaryBox = document.getElementById("csvSummaryBox");
                var lastSaveSummary = document.getElementById("csvLastSaveSummary");
                var modeSelect = document.getElementById("csvModeSelect");
                if (modeSelect) {
                  // 이전에 선택한 분석 모드 복원 (기본값: MY)
                  try {
                    if (window.localStorage) {
                      var savedMode = localStorage.getItem("muddha_csv_mode");
                      if (savedMode === "TEMP" || savedMode === "MY") {
                        csvMode = savedMode;
                        modeSelect.value = savedMode;
                      }
                    }
                  } catch (e) {
                    console.warn("csv mode restore error", e);
                  }

                  modeSelect.addEventListener("change", function () {
                    csvMode = modeSelect.value || "MY";
                    try {
                      if (window.localStorage) {
                        localStorage.setItem("muddha_csv_mode", csvMode);
                      }
                    } catch (e2) {
                      console.warn("csv mode save error", e2);
                    }
                    if (typeof updateCsvLastSaveSummary === "function") {
                      updateCsvLastSaveSummary();
                    }
                  });
                }

                var scoreInfo = document.getElementById("csvScoreInfo");
                var chartCanvas = document.getElementById("csvScoreChart");
                var csvScoreChartInstance = null;

                function toNumber(v) {
                  if (v === null || v === undefined) return 0;
                  if (typeof v === "number") return v;
                  var cleaned = String(v).replace(/,/g, "").trim();
                  var n = parseFloat(cleaned);
                  return isNaN(n) ? 0 : n;
                }

                function findColumn(columns, candidates) {
                  if (!columns || !columns.length) return null;
                  var lower = columns.map(function (c) { return String(c).toLowerCase(); });

                  // 1) 완전 일치 우선
                  for (var i = 0; i < candidates.length; i++) {
                    var target = String(candidates[i]).toLowerCase();
                    for (var j = 0; j < lower.length; j++) {
                      if (lower[j] === target) return columns[j];
                    }
                  }
                  // 2) 부분 일치 허용 (예: "tweet text", "트윗 내용")
                  for (var i2 = 0; i2 < candidates.length; i2++) {
                    var target2 = String(candidates[i2]).toLowerCase();
                    for (var k = 0; k < lower.length; k++) {
                      if (lower[k].indexOf(target2) !== -1) return columns[k];
                    }
                  }
                  return null;
                }

                // CSV 날짜 파싱 (행 + 날짜 컬럼명을 받아서 YYYY-MM-DD 문자열로 변환)
                function parseDateStr(row, dateKey) {
                  if (!row || !dateKey) return null;
                  var raw = row[dateKey];
                  if (!raw) return null;
                  var s = String(raw).trim();
                  if (!s) return null;

                  // 1) YYYY-MM-DD / YYYY/MM/DD / YYYY.MM.DD 형태 우선 처리
                  var m = s.match(/(\d{4})[^\d]?(\d{1,2})[^\d]?(\d{1,2})/);
                  var d = null;
                  if (m) {
                    var y = parseInt(m[1], 10);
                    var mo = parseInt(m[2], 10);
                    var da = parseInt(m[3], 10);
                    if (y && mo && da) {
                      d = new Date(y, mo - 1, da);
                    }
                  }

                  // 2) 위에서 못 잡았으면 Date.parse로 한 번 더 시도
                  if (!d || isNaN(d.getTime())) {
                    var parsed = Date.parse(s);
                    if (!isNaN(parsed)) {
                      d = new Date(parsed);
                    }
                  }

                  if (!d || isNaN(d.getTime())) return null;

                  var yy = d.getFullYear();
                  var mm = d.getMonth() + 1;
                  var dd = d.getDate();
                  var mmStr = (mm < 10 ? "0" + mm : String(mm));
                  var ddStr = (dd < 10 ? "0" + dd : String(dd));
                  return yy + "-" + mmStr + "-" + ddStr;
                }





                // ---- 월별 필터용 헬퍼 함수 ----
                function populateMonthFilterFromRows(rows) {
                  var select = document.getElementById("csvMonthFilter");
                  if (!select || !rows || !rows.length) return;

                  // 기본 옵션(전체)만 남기고 초기화
                  select.innerHTML = '<option value="ALL">전체</option>';

                  var columns = Object.keys(rows[0] || {});
                  var dateKey = findColumn(columns, ["time", "date", "날짜", "작성일"]);
                  if (!dateKey) return;

                  var monthSet = {};
                  rows.forEach(function (row) {
                    var d = parseDateStr(row, dateKey);
                    if (!d) return;
                    var monthKey = d.slice(0, 7); // "YYYY-MM"
                    monthSet[monthKey] = true;
                  });

                  var months = Object.keys(monthSet).sort(); // 오래된 달부터
                  months.forEach(function (m) {
                    var label = m;
                    // 보기 좋게 "YYYY-MM" -> "YYYY년 MM월"로 변환
                    var parts = m.split("-");
                    if (parts.length === 2) {
                      var yy = parts[0];
                      var mm = parts[1].replace(/^0/, "");
                      label = yy + "년 " + mm + "월";
                    }
                    var opt = document.createElement("option");
                    opt.value = m;
                    opt.textContent = label;
                    select.appendChild(opt);
                  });
                }

                function rebuildCsvViewForMonth(monthKey) {
                  monthKey = monthKey || "ALL";
                  window.csvMonthFilterValue = monthKey;

                  if (!window.csvAccumRows || !window.csvAccumRows.length) return;

                  var baseRows = window.csvAccumRows;
                  if (monthKey === "ALL") {
                    buildChartFromRows(baseRows);
                    return;
                  }

                  var columns = Object.keys(baseRows[0] || {});
                  var dateKey = findColumn(columns, ["time", "date", "날짜", "작성일"]);
                  if (!dateKey) {
                    buildChartFromRows(baseRows);
                    return;
                  }

                  var filtered = baseRows.filter(function (row) {
                    var d = parseDateStr(row, dateKey);
                    if (!d) return false;
                    return d.slice(0, 7) === monthKey;
                  });

                  buildChartFromRows(filtered);
                }


                // CSV 활동 패턴 / 티어 / 코치봇 업데이트

                // CSV 활동 패턴 / 티어 / 코치봇 업데이트 (ES5 호환 버전)

          function updateCsvPatternAndTier(info) {
                  // 최대한 단순하게: 날짜 배열(rawDates) + 일자별 Trimmed 점수(trimmedDailyScores)만 사용
                  info = info || {};
                  var rawDates = info.rawDates || [];
                  var dates    = info.dates || [];
                  var trimmed  = info.trimmedDailyScores || [];
                  var byDate   = info.byDate || {};

                  // 아무 데이터도 없으면 그냥 리턴
                  if (!rawDates || !rawDates.length || !trimmed || !trimmed.length) {
                    return;
                  }

                  // ---- 요일 패턴 계산 ----
                  var dowNames = ["일", "월", "화", "수", "목", "금", "토"];
                  var dowCount = [0,0,0,0,0,0,0];
                  var dowScore = [0,0,0,0,0,0,0];

                  for (var i = 0; i < rawDates.length; i++) {
                    var dKey = rawDates[i];          // "YYYY-MM-DD"
                    var scoreVal = trimmed[i];
                    if (typeof scoreVal !== "number" || isNaN(scoreVal)) continue;

                    var parts = (dKey || "").split("-");
                    if (parts.length < 3) continue;
                    var y = parseInt(parts[0], 10);
                    var m = parseInt(parts[1], 10) - 1;
                    var d = parseInt(parts[2], 10);
                    if (!y || isNaN(m) || !d) continue;

                    var dt = new Date(y, m, d);
                    if (!dt || isNaN(dt.getTime())) continue;
                    var dow = dt.getDay(); // 0~6

                    dowCount[dow] += 1;
                    dowScore[dow] += scoreVal;
                  }

                  // 요일별 평균
                  var dowAvg = [];
                  for (var di = 0; di < dowScore.length; di++) {
                    if (dowCount[di] > 0) {
                      dowAvg.push(dowScore[di] / dowCount[di]);
                    } else {
                      dowAvg.push(0);
                    }
                  }

                  // ---- 시간대 패턴은 일단 전체 Trimmed 평균을 그대로 사용 (시간 정보가 없으므로) ----
                  var hourAvg = [];
                  var sumTrim = 0, cntTrim = 0;
                  for (var ti = 0; ti < trimmed.length; ti++) {
                    var tv = trimmed[ti];
                    if (typeof tv === "number" && !isNaN(tv)) {
                      sumTrim += tv;
                      cntTrim += 1;
                    }
                  }
                  var globalAvg = cntTrim ? (sumTrim / cntTrim) : 0;
                  for (var h = 0; h < 24; h++) {
                    hourAvg.push(globalAvg);
                  }

                  // ---- 차트 렌더링 ----
                  if (window.csvPatternDowChart) {
                    window.csvPatternDowChart.destroy();
                  }
                  if (window.csvPatternHourChart) {
                    window.csvPatternHourChart.destroy();
                  }

                  var elDow = document.getElementById("csvPatternDowChart");
                  if (elDow && window.Chart) {
                    var ctxDow = elDow.getContext("2d");
                    window.csvPatternDowChart = new Chart(ctxDow, {
                      type: "bar",
                      data: {
                        labels: ["일요일","월요일","화요일","수요일","목요일","금요일","토요일"],
                        datasets: [{
                          label: "요일별 평균 Trimmed Score",
                          data: dowAvg,
                          borderWidth: 1
                        }]
                      },
                      options: {
                        responsive: true,
                        maintainAspectRatio: false
                      }
                    });
                  }

                  var elHour = document.getElementById("csvPatternHourChart");
                  if (elHour && window.Chart) {
                    var labelsHour = [];
                    for (var lh = 0; lh < 24; lh++) labelsHour.push(lh + "시");
                    var ctxHour = elHour.getContext("2d");
                    window.csvPatternHourChart = new Chart(ctxHour, {
                      type: "line",
                      data: {
                        labels: labelsHour,
                        datasets: [{
                          label: "시간대별 평균 Trimmed Score",
                          data: hourAvg,
                          borderWidth: 2
                        }]
                      },
                      options: {
                        responsive: true,
                        maintainAspectRatio: false
                      }
                    });
                  }

                  // ---- 요약 텍스트 및 최적 요일/시간대 ----
                  function pickTop(arr) {
                    var bestIdx = 0;
                    var bestVal = -Infinity;
                    for (var pi = 0; pi < arr.length; pi++) {
                      if (arr[pi] > bestVal) {
                        bestVal = arr[pi];
                        bestIdx = pi;
                      }
                    }
                    return { idx: bestIdx, value: bestVal };
                  }

                  var topDowPost = pickTop(dowCount);
                  var topDowScore = pickTop(dowAvg);
                  var labelTopPostDow = dowNames[topDowPost.idx] + "요일";
                  var labelTopScoreDow = dowNames[topDowScore.idx] + "요일";
                  var labelTopPostHour = "전체 시간대"; // 시간 정보가 없어서 간단 처리
                  var labelTopScoreHour = "전체 시간대";

                  var el1 = document.getElementById("patternTopPostDow");
                  var el2 = document.getElementById("patternTopScoreDow");
                  var el3 = document.getElementById("patternTopPostHour");
                  var el4 = document.getElementById("patternTopScoreHour");
                  var elSummary = document.getElementById("patternSummaryText");

                  if (el1) el1.textContent = labelTopPostDow;
                  if (el2) el2.textContent = labelTopScoreDow;
                  if (el3) el3.textContent = labelTopPostHour;
                  if (el4) el4.textContent = labelTopScoreHour;
                  if (elSummary) {
                    elSummary.textContent =
                      labelTopScoreDow + "에 올린 글의 반응이 상대적으로 좋게 나타납니다. 시간대는 아직 세부 데이터가 없어서 전체 평균 기준으로만 보여줍니다.";
                  }


                  // ---- 티어 계산 ----
                  // Trimmed Score 분포 기준으로 S/A/B/C 경계를 잡는다 (상위 5%/20%/40%)
                  var validTrim = [];
                  for (var ti = 0; ti < trimmed.length; ti++) {
                    var tv = trimmed[ti];
                    if (typeof tv === "number" && !isNaN(tv)) validTrim.push(tv);
                  }
                  validTrim.sort(function(a, b) { return b - a; }); // 내림차순
                  var nTrim = validTrim.length;
                  var thrS = Infinity, thrA = Infinity, thrB = Infinity;
                  if (nTrim > 0) {
                    var idxS = Math.max(0, Math.floor(nTrim * 0.05) - 1);
                    var idxA = Math.max(0, Math.floor(nTrim * 0.20) - 1);
                    var idxB = Math.max(0, Math.floor(nTrim * 0.40) - 1);
                    thrS = validTrim[idxS];
                    thrA = validTrim[idxA];
                    thrB = validTrim[idxB];
                  }

                  var tierCounts = { S:0, A:0, B:0, C:0 };
                  var tierRows = [];

                  // SCORE 그래프에서 계산된 날짜별 대표 트윗 메타 데이터 재사용
                  var metaArr = (window.csvScoreChartInstance && csvScoreChartInstance.$dateTweetMeta)
                    ? csvScoreChartInstance.$dateTweetMeta
                    : null;

                  for (var idx = 0; idx < trimmed.length; idx++) {
                    var v = trimmed[idx];
                    if (typeof v !== "number" || isNaN(v)) continue;

                    var labelDate = dates[idx] || "";
                    // 분포 기반 티어 매핑
                    var t = "C";
                    if (nTrim > 0) {
                      if (v >= thrS) t = "S";
                      else if (v >= thrA) t = "A";
                      else if (v >= thrB) t = "B";
                    }
                    tierCounts[t] += 1;

                    var meta = metaArr && metaArr[idx] ? metaArr[idx] : null;
                    if (!meta) {
                      // fallback: byDate에서 해당 날짜의 가장 높은 스코어 트윗 찾기
                      var rawKey = rawDates[idx];
                      var dayInfo = byDate && rawKey && byDate[rawKey] ? byDate[rawKey] : null;
                      if (dayInfo && dayInfo.tweets && dayInfo.tweets.length) {
                        var best = dayInfo.tweets[0];
                        for (var di = 1; di < dayInfo.tweets.length; di++) {
                          var cand = dayInfo.tweets[di];
                          if (!cand) continue;
                          if (typeof cand.score === "number" && typeof best.score === "number") {
                            if (cand.score > best.score) best = cand;
                          }
                        }
                        meta = best;
                      } else {
                        meta = {};
                      }
                    }
                    var snippet = meta && meta.text ? String(meta.text) : "";
                    var url = meta && meta.url ? String(meta.url) : "";

                    var likes   = (meta && typeof meta.likes === "number") ? meta.likes : null;
                    var replies = (meta && typeof meta.replies === "number") ? meta.replies : null;
                    var rts     = (meta && typeof meta.retweets === "number") ? meta.retweets : null;
                    var quotes  = (meta && typeof meta.quotes === "number") ? meta.quotes : null;

                    tierRows.push({
                      date: labelDate,
                      tier: t,
                      score: v,
                      snippet: snippet,
                      url: url,
                      likes: likes,
                      replies: replies,
                      retweets: rts,
                      quotes: quotes
                    });
                  }

                  window.csvTierSummary = {
                    counts: tierCounts,
                    rows: tierRows
                  };


                  if (typeof renderTierExplosionTop === "function") {
                    renderTierExplosionTop();
                  }
                  if (typeof renderTierFilterList === "function") {
                    renderTierFilterList("ALL");
                  }


          // ---- 코치봇 텍스트 ----
                  var coachEl = document.getElementById("csvCoachText");
                  if (coachEl) {
                    var sum = 0, cnt = 0;
                    for (var ci = 0; ci < trimmed.length; ci++) {
                      var vv = trimmed[ci];
                      if (typeof vv === "number" && !isNaN(vv)) {
                        sum += vv;
                        cnt += 1;
                      }
                    }
                    var avgTrim = cnt ? (sum / cnt) : 0;

                    var sum7 = 0, cnt7 = 0;
                    var start7 = Math.max(0, trimmed.length - 7);
                    for (var i7 = start7; i7 < trimmed.length; i7++) {
                      var vv7 = trimmed[i7];
                      if (typeof vv7 === "number" && !isNaN(vv7)) {
                        sum7 += vv7;
                        cnt7 += 1;
                      }
                    }
                    var avgLast7 = cnt7 ? (sum7 / cnt7) : avgTrim;

                    var trendText = "";
                    if (avgLast7 > avgTrim + 0.5) {
                      trendText = "최근 7일의 점수가 전체 평균보다 높아서 계정 컨디션이 올라오는 구간입니다.";
                    } else if (avgLast7 < avgTrim - 0.5) {
                      trendText = "최근 7일의 점수가 전체 평균보다 낮아서 잠시 쉬어가거나 방향 점검이 필요한 타이밍입니다.";
                    } else {
                      trendText = "최근 7일의 점수가 전체 평균과 비슷한 안정 구간입니다.";
                    }

                    var text = "";
                    text += "① 전체 기간 평균 Trimmed Score는 약 " + avgTrim.toFixed(2) + "점입니다.\n";
                    text += "② 최근 7일 평균은 약 " + avgLast7.toFixed(2) + "점으로, " + trendText + "\n";
                    text += "③ 활동량 기준으로는 " + labelTopPostDow + "에 글을 가장 많이 올렸고, 반응이 좋은 요일은 " + labelTopScoreDow + "입니다.\n";
                    text += "④ 시간대 데이터는 현재 CSV에서 충분하지 않아, 우선 요일 패턴 중심으로 업로드 타이밍을 맞추는 것을 추천합니다.\n";
                    text += "⑤ 점수에만 매달리기보다는, 다양한 형식의 포스트를 실험하면서 패턴을 유지해보세요.";

                    coachEl.textContent = text;
                  }
                }


              // 티어 이모지 매핑
              var tierEmojiMap = { S: "💎", A: "⭐", B: "📈", C: "📘" };

              function buildTierLabel(tier) {
                var base = tier || "";
                var emoji = tierEmojiMap[base] || "";
                return emoji ? (emoji + " " + base) : base;
              }

              function buildReactionSummary(row) {
                if (!row) return "-";
                var parts = [];
                if (typeof row.likes === "number" && !isNaN(row.likes)) {
                  parts.push("❤️ " + row.likes);
                }
                if (typeof row.replies === "number" && !isNaN(row.replies)) {
                  parts.push("💬 " + row.replies);
                }
                if (typeof row.retweets === "number" && !isNaN(row.retweets)) {
                  parts.push("🔁 " + row.retweets);
                }
                if (typeof row.quotes === "number" && !isNaN(row.quotes)) {
                  parts.push("🧾 " + row.quotes);
                }
                return parts.length ? parts.join(" · ") : "-";
              }

              // 티어 탭용 헬퍼 함수들
              function getTierRows() {
                var summary = window.csvTierSummary || {};
                return summary.rows || [];
              }

              // 마인드쉐어 폭발 Top10 렌더링
              function renderTierExplosionTop() {
                // 마인드쉐어 폭발 Top 10은 날짜별 대표 트윗이나 요약본이 아니라
                // csvAllPosts(= CSV에서 추출된 모든 원글/게시글)의 SCORE 기준 상위 10개로만 계산한다.
                var allRows = (window.csvAllPosts || []).slice();
                var tbody = document.getElementById("tierExplosionBody");
                var countEl = document.getElementById("tierExplosionCountLabel");
                if (!tbody) return;
                tbody.innerHTML = "";

                var total = allRows.length;
                // SCORE 기준 내림차순 정렬
                allRows.sort(function(a, b) { return b.score - a.score; });
                // 상위 10개만 추출
                var top = allRows.slice(0, 10);

                if (countEl) {
                  countEl.textContent = "(" + top.length + " / " + total + ")";
                }

                if (!top.length) {
                  var trEmpty = document.createElement("tr");
                  var tdEmpty = document.createElement("td");
                  tdEmpty.colSpan = 7;
                  tdEmpty.textContent = "티어를 계산할 수 있는 데이터가 없습니다.";
                  trEmpty.appendChild(tdEmpty);
                  tbody.appendChild(trEmpty);
                  return;
                }

                for (var i = 0; i < top.length; i++) {
                  var row = top[i];
                  var tr = document.createElement("tr");

                  var tdRank = document.createElement("td");
                  tdRank.textContent = (i + 1);

                  var tdTier = document.createElement("td");
                  tdTier.textContent = buildTierLabel(row.tier);

                  var tdText = document.createElement("td");
                  var safeText = (row.snippet || "").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                  tdText.textContent = safeText || "(대표 트윗 텍스트 없음)";

                  var tdScore = document.createElement("td");
                  tdScore.textContent = row.score.toFixed(2);

                  var tdReact = document.createElement("td");
                  tdReact.textContent = buildReactionSummary(row);

                  var tdDate = document.createElement("td");
                  tdDate.textContent = row.date || "-";

                  var tdLink = document.createElement("td");
                  if (row.url) {
                    var a = document.createElement("a");
                    a.href = row.url;
                    a.target = "_blank";
                    a.rel = "noopener noreferrer";
                    a.textContent = "트윗 보기";
                    tdLink.appendChild(a);
                  } else {
                    tdLink.textContent = "-";
                  }

                  tr.appendChild(tdRank);
                  tr.appendChild(tdTier);
                  tr.appendChild(tdText);
                  tr.appendChild(tdScore);
                  tr.appendChild(tdReact);
                  tr.appendChild(tdDate);
                  tr.appendChild(tdLink);
                  tbody.appendChild(tr);
                }
              }


              // 티어별 상위 게시글 렌더링
              function renderTierFilterList(filterTier) {
                if (!filterTier) filterTier = "ALL";
                window.csvTierCurrentFilter = filterTier;

                var allRows = getTierRows().slice();
                if (filterTier !== "ALL") {
                  allRows = allRows.filter(function(r) { return r.tier === filterTier; });
                }
                allRows.sort(function(a, b) { return b.score - a.score; });

                var tbody = document.getElementById("tierGradeBody");
                if (!tbody) return;
                tbody.innerHTML = "";

                if (!allRows.length) {
                  var trEmpty = document.createElement("tr");
                  var tdEmpty = document.createElement("td");
                  tdEmpty.colSpan = 6;
                  tdEmpty.textContent = "해당 티어에서 보여줄 수 있는 게시글이 없습니다.";
                  trEmpty.appendChild(tdEmpty);
                  tbody.appendChild(trEmpty);
                  return;
                }

                for (var i = 0; i < allRows.length; i++) {
                  var row = allRows[i];
                  var tr = document.createElement("tr");

                  var tdRank = document.createElement("td");
                  tdRank.textContent = (i + 1);

                  var tdTier = document.createElement("td");
                  tdTier.textContent = buildTierLabel(row.tier);

                  var tdText = document.createElement("td");
                  var safeText = (row.snippet || "").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                  tdText.textContent = safeText || "(대표 트윗 텍스트 없음)";

                  var tdScore = document.createElement("td");
                  tdScore.textContent = row.score.toFixed(2);

                  var tdReact = document.createElement("td");
                  tdReact.textContent = buildReactionSummary(row);

                  var tdDate = document.createElement("td");
                  tdDate.textContent = row.date || "-";

                  var tdLink = document.createElement("td");
                  if (row.url) {
                    var a = document.createElement("a");
                    a.href = row.url;
                    a.target = "_blank";
                    a.rel = "noopener noreferrer";
                    a.textContent = "트윗 보기";
                    tdLink.appendChild(a);
                  } else {
                    tdLink.textContent = "-";
                  }

                  tr.appendChild(tdRank);
                  tr.appendChild(tdTier);
                  tr.appendChild(tdText);
                  tr.appendChild(tdScore);
                  tr.appendChild(tdReact);
                  tr.appendChild(tdDate);
                  tr.appendChild(tdLink);
                  tbody.appendChild(tr);
                }
              }

          function formatKoreanDateKey(dKey) {
                if (!dKey) return "";
                var parts = String(dKey).split("-");
                if (parts.length !== 3) return dKey;
                var m = parts[1];
                var d = parts[2];
                if (m.length === 2 && m.charAt(0) === "0") m = m.slice(1);
                if (d.length === 2 && d.charAt(0) === "0") d = d.slice(1);
                return m + "월 " + d + "일";
              }

              function computeScore(p){
            var impres = p.impressions || 0;
            var raw =
                (p.engagements || 0) +
                (p.bookmarks || 0) * 3 +
                (p.newFollows || 0) * 10 +
                (p.profileClicks || 0) * 0.7 +
                (p.urlClicks || 0) * 0.8 +
                (p.uniqueClicks || 0) * 1.2 +
                (p.likes || 0) * 1.2 +
                (p.retweets || 0) * 2 +
                (p.replies || 0) * 1.5 +
                (p.shares || 0) * 1.8;
            return raw / Math.log10(impres + 10);
          }

          function buildChartFromRows(rows) {
                  if (!rows || !rows.length) return;

                  // 원글 단위 점수/티어 계산용 리스트 초기화
                  window.csvAllPosts = [];

                  var columns = Object.keys(rows[0] || {});
                  if (!columns.length) return;

                  var dateKey = findColumn(columns, ["time", "date", "날짜", "작성일"]);
                  var impKey = findColumn(columns, ["impression", "노출", "조회수"]);
                  var likeKey = findColumn(columns, ["like", "좋아요"]);
                  var rtKey = findColumn(columns, ["retweet", "리트윗"]);
                  var engagementKey = findColumn(columns, ["engagement", "engagements", "참여수"]);
                  var replyKey = findColumn(columns, ["reply", "댓글"]);
                  var quoteKey = findColumn(columns, ["quote", "인용", "quoted", "quote_count"]);
                  var bookmarkKey = findColumn(columns, ["bookmark", "북마크"]);
                  // 트윗 유형/답글 여부 컬럼(있으면) 탐색
                  var tweetTypeKey = findColumn(columns, ["tweet_type", "tweet type", "트윗 유형", "트윗 타입", "유형"]);
                  var inReplyIdKey = findColumn(columns, ["in_reply_to_tweet_id", "in_reply_to_status_id", "답글 대상 트윗 id"]);

                  var tweetUrlKey = findColumn(columns, ["permalink", "tweet_permalink", "url", "tweet url", "링크", "트윗 링크"]);
                  var tweetIdKey = findColumn(columns, ["tweet_id", "status_id", "id", "트윗id"]);

                  // 업로드 요약 정보 박스 업데이트
                  if (summaryBox) {
                    var rowCount = rows.length;
                    var colCount = columns.length;
                    var dateColLabel = dateKey || "감지 실패";
                    summaryBox.innerHTML =
                      "총 <b>" + rowCount + "</b>행 / 컬럼 <b>" + colCount + "</b>개<br>" +
                      "날짜 컬럼: <b>" + dateColLabel + "</b>";
                  }

                  var textKey = findColumn(columns, [
                    "full_text", "full text", "tweet_text", "tweet text",
                    "text", "내용", "본문", "트윗", "트윗 내용", "tweet"
                  ]);

                  var byDate = {};

                  rows.forEach(function (row) {
                    // 옛날 분석기와 동일하게: 내용이 없거나 @로 시작하는 글(멘션)은 제외
                    var tweetText = textKey ? String(row[textKey] || "").trim() : "";
                    if (!tweetText || tweetText.charAt(0) === "@"){ return; }

                    // CSV에 트윗 유형/답글 ID 컬럼이 있으면 답글은 추가로 한 번 더 걸러준다.
                    var isReplyRow = false;
                    if (tweetTypeKey) {
                      var tt = String(row[tweetTypeKey] || "").toLowerCase();
                      if (tt.indexOf("reply") !== -1 || tt.indexOf("답글") !== -1) {
                        isReplyRow = true;
                      }
                    }
                    if (!isReplyRow && inReplyIdKey) {
                      var rv = row[inReplyIdKey];
                      if (rv !== null && rv !== undefined && String(rv).trim() !== "") {
                        isReplyRow = true;
                      }
                    }
                    if (isReplyRow) { return; }



                    var d = parseDateStr(row, dateKey) || "unknown";
                    if (!byDate[d]) {
                      byDate[d] = { scores: [], tweets: [] };
                    }

                    var impVal      = impKey      ? toNumber(row[impKey])      : 0;
                    var likeVal     = likeKey     ? toNumber(row[likeKey])     : 0;
                    var rtVal       = rtKey       ? toNumber(row[rtKey])       : 0;
                    var replyVal    = replyKey    ? toNumber(row[replyKey])    : 0;
                    var quoteVal    = quoteKey    ? toNumber(row[quoteKey])    : 0;
                    var bookmarkVal = bookmarkKey ? toNumber(row[bookmarkKey]) : 0;

                    var engagementsVal;
                    if (engagementKey) {
                      engagementsVal = toNumber(row[engagementKey]);
                    } else {
                      engagementsVal = likeVal + rtVal + replyVal + quoteVal + bookmarkVal;
                    }

                    var base = computeScore({
                      impressions: impVal,
                      engagements: engagementsVal,
                      bookmarks: bookmarkVal,
                      newFollows: 0,
                      profileClicks: 0,
                      urlClicks: 0,
                      uniqueClicks: 0,
                      likes: likeVal,
                      retweets: rtVal,
                      replies: replyVal,
                      shares: quoteVal
                    });

                    byDate[d].scores.push(base);

                    // 트윗 링크 또는 트윗 ID를 이용해 상세보기용 메타데이터 저장
                    // tweetText는 상단에서 이미 계산됨
                    var finalLink = null;

                    if (tweetUrlKey) {
                      var rawLink = row[tweetUrlKey];
                      if (rawLink) {
                        var link = String(rawLink).trim();
                        if (link) {
                          // 이미 http/https로 시작하면 그대로 사용
                          if (/^https?:\/\//i.test(link)) {
                            finalLink = link;
                          } else {
                            // 프로토콜이 없고, 도메인 형태라면 https를 붙여준다.
                            if (/^(x\.com|twitter\.com|t\.co)/i.test(link)) {
                              finalLink = "https://" + link;
                            }
                            // 그 외의 값(숫자 등)은 유효한 URL이 아니라고 보고 무시하고,
                            // 아래의 텍스트/ID 기반 링크 추출 로직으로 넘긴다.
                          }
                        }
                      }
                    }

                    // URL 컬럼이 없거나 비어 있으면, 텍스트 안에서 첫 번째 링크를 추출해 사용
                    if (!finalLink && tweetText) {
                      var match = tweetText.match(/https?:\/\/\S+/);
                      if (match && match[0]) {
                        finalLink = match[0];
                      }
                    }

                    if (!finalLink && tweetIdKey) {
                      var idRaw = row[tweetIdKey];
                      if (idRaw) {
                        var idStr = String(idRaw).trim();
                        if (/^https?:\/\//i.test(idStr)) {
                          finalLink = idStr;
                        } else if (idStr) {
                          finalLink = "https://x.com/i/status/" + idStr;
                        }
                      }
                    }

                    // 좋아요/답글/재게시/인용/노출 등 메타 정보도 함께 저장
                    var impVal      = impKey      ? toNumber(row[impKey])      : 0;
                    var likeVal     = likeKey     ? toNumber(row[likeKey])     : 0;
                    var rtVal       = rtKey       ? toNumber(row[rtKey])       : 0;
                    var replyVal    = replyKey    ? toNumber(row[replyKey])    : 0;
                    var quoteVal    = quoteKey    ? toNumber(row[quoteKey])    : 0;
                    var bookmarkVal = bookmarkKey ? toNumber(row[bookmarkKey]) : 0;

                    if (finalLink || tweetText) {
                      var postObj = {
                        dateKey: d,
                        date: formatKoreanDateKey(d),
                        score: base,
                        url: finalLink,
                        snippet: tweetText,
                        impressions: impVal,
                        likes: likeVal,
                        retweets: rtVal,
                        replies: replyVal,
                        quotes: quoteVal,
                        bookmarks: bookmarkVal
                      };
                      window.csvAllPosts.push(postObj);

                      byDate[d].tweets.push({
                        score: base,
                        url: finalLink,
                        text: tweetText,
                        impressions: impVal,
                        likes: likeVal,
                        retweets: rtVal,
                        replies: replyVal,
                        quotes: quoteVal,
                        bookmarks: bookmarkVal
                      });
                    }
                  });

                  var rawDates = Object.keys(byDate).sort();
                  if (!rawDates.length) return;

          // === 전체 기간 기준 트림드 컷 계산 ===
                  var allScores = (window.csvAllPosts || []).map(function (p) {
                    return p && typeof p.score === "number" ? p.score : null;
                  }).filter(function (v) {
                    return v !== null && !isNaN(v);
                  }).sort(function (a, b) { return a - b; });

                  var globalLow = null;
                  var globalHigh = null;
                  if (allScores.length) {
                    var nAll = allScores.length;
                    var kAll = Math.floor(nAll * 0.1);
                    if (kAll * 2 >= nAll) {
                      kAll = 0;
                    }
                    var trimmedGlobal = allScores.slice(kAll, nAll - kAll);
                    if (!trimmedGlobal.length) {
                      trimmedGlobal = allScores.slice();
                    }
                    globalLow = trimmedGlobal[0];
                    globalHigh = trimmedGlobal[trimmedGlobal.length - 1];
                  }
                  window.csvGlobalTrimBounds = { low: globalLow, high: globalHigh };

                  var dates = [];
                  var avgScores = [];
                  var trimmedDailyScores = [];
                  var dateTweetMeta = [];

                  rawDates.forEach(function (dKey) {
                    var info = byDate[dKey];
                    var scores = info.scores || [];
                    if (!scores.length) {
                      dates.push(formatKoreanDateKey(dKey));
                      avgScores.push(0);
                      trimmedDailyScores.push(0);
                      dateTweetMeta.push(null);
                      return;
                    }

                    // 일자별 평균
                    var sum = scores.reduce(function (s, v) { return s + v; }, 0);
                    var avg = sum / scores.length;
                    avgScores.push(avg);

                    // 전체 기간 기준 트림드 평균 (상/하위 10%를 전체 분포에서 한 번만 잘라서 사용)
                    var trimmedArrForDay = scores;
                    if (globalLow !== null && globalHigh !== null &&
                        !isNaN(globalLow) && !isNaN(globalHigh)) {
                      trimmedArrForDay = scores.filter(function (v) {
                        return v >= globalLow && v <= globalHigh;
                      });
                    }
                    var trimmed =
                      trimmedArrForDay.length
                        ? trimmedArrForDay.reduce(function (s, v) { return s + v; }, 0) / trimmedArrForDay.length
                        : avg;
                    trimmedDailyScores.push(trimmed);

                    // 차트 라벨용 날짜
                    dates.push(formatKoreanDateKey(dKey));

                    // 해당 날짜에서 가장 점수가 높은 트윗 저장
                    var bestTweet = null;
                    if (info.tweets && info.tweets.length) {
                      var best = null;
                      info.tweets.forEach(function (t) {
                        if (!t) return;
                        if (!best) {
                          best = t;
                        } else if (typeof t.score === "number" && typeof best.score === "number") {
                          if (t.score > best.score) best = t;
                        }
                      });
                      if (best) bestTweet = best;
                    }
                    dateTweetMeta.push(bestTweet);
                  });

                  if (!chartCanvas) return;
                  var ctx = chartCanvas.getContext("2d");
                  if (csvScoreChartInstance) {
                    csvScoreChartInstance.destroy();
                  }

                  // 트림드 > 평균 돌파 포인트
                  var crossingPoints = dates.map(function (_, idx) {
                    var a = avgScores[idx];
                    var t = trimmedDailyScores[idx];
                    if (t != null && a != null && !isNaN(t) && !isNaN(a) && t > a) {
                      return t;
                    }
                    return null;
                  });

                  // 트림드 신 고점 포인트
                  var highPoints = [];
                  var runningHigh = -Infinity;
                  trimmedDailyScores.forEach(function (t, idx) {
                    if (t != null && !isNaN(t)) {
                      if (t > runningHigh) {
                        runningHigh = t;
                        highPoints[idx] = t;
                      } else {
                        highPoints[idx] = null;
                      }
                    } else {
                      highPoints[idx] = null;
                    }
                  });

                  csvScoreChartInstance = new Chart(ctx, {
                    type: "line",
                    data: {
                      labels: dates,
                      datasets: [
                        {
                          label: "일자별 평균 스코어",
                          data: avgScores,
                          borderWidth: 2,
                          tension: 0.25,
                          pointRadius: 3,
                          borderColor: "#3b82f6",
                          backgroundColor: "#3b82f6"
                        },
                        {
                          label: "일자별 트림드 스코어",
                          data: trimmedDailyScores,
                          borderWidth: 2,
                          tension: 0.25,
                          pointRadius: 3,
                          borderColor: "#ec4899",
                          backgroundColor: "#ec4899"
                        },
                        {
                          label: "트림드 > 평균 돌파",
                          data: crossingPoints,
                          borderWidth: 0,
                          pointRadius: 6,
                          pointHoverRadius: 7,
                          showLine: false,
                          borderColor: "#facc15",
                          backgroundColor: "#facc15"
                        },
                        {
                          label: "트림드 신 고점",
                          data: highPoints,
                          borderWidth: 0,
                          pointRadius: 6,
                          pointHoverRadius: 7,
                          showLine: false,
                          borderColor: "#a855f7",
                          backgroundColor: "#a855f7"
                        }
                      ]
                    },
                    options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      scales: {
                        x: {
                          ticks: {
                            maxRotation: 60,
                            minRotation: 45,
                            autoSkip: true
                          }
                        },
                        y: {
                          beginAtZero: true
                        }
                      },
                      interaction: {
                        mode: "index",
                        intersect: false,
                        axis: "x"
                      },
                      plugins: {
                        legend: {
                          labels: {
                            font: { size: 11 }
                          }
                        },
                        tooltip: {
                          callbacks: {
                            label: function (ctx) {
                              var v = ctx.parsed.y;
                              return ctx.dataset.label + ": " + (v != null ? v.toFixed(2) : "-");
                            }
                          }
                        }
                      },
                      onClick: function (evt, activeEls) {
                        var points = csvScoreChartInstance.getElementsAtEventForMode(
                          evt,
                          "index",
                          { intersect: false },
                          false
                        );
                        if (!points || !points.length) return;
                        var first = points[0];
                        var index = first.index;
                        if (!csvScoreChartInstance.$dateTweetMeta) return;
                        var metaArr = csvScoreChartInstance.$dateTweetMeta;
                        var meta = metaArr[index];
                        var detailBox = document.getElementById("csvScoreDetailBody");
                        if (!detailBox) return;

                        if (!meta || (!meta.url && !meta.text)) {
                          detailBox.innerHTML = "<p class=\"csv-score-detail-meta\">선택된 날짜의 대표 트윗 데이터를 찾을 수 없습니다.</p>";
                          return;
                        }

                        var labelDate = csvScoreChartInstance.data.labels[index] || "";
                        var scoreVal = null;
                        if (csvScoreChartInstance.data.datasets[0] &&
                            csvScoreChartInstance.data.datasets[0].data &&
                            typeof csvScoreChartInstance.data.datasets[0].data[index] === "number") {
                          scoreVal = csvScoreChartInstance.data.datasets[0].data[index];
                        }

                        var safeText = (meta.text || "").replace(/</g, "&lt;").replace(/>/g, "&gt;");

                        var html = "";
                        html += "<div class=\"csv-score-detail-meta\">" + labelDate;
                        if (scoreVal != null) {
                          html += " · 평균 스코어 " + scoreVal.toFixed(2);
                        }
                        html += "</div>";
                        if (safeText) {
                          html += "<p>" + safeText + "</p>";
                        } else {
                          html += "<p>이 날짜의 대표 트윗 텍스트를 불러오지 못했습니다.</p>";
                        }
                        if (meta.url) {
                          html += "<a class=\"csv-score-detail-link\" href=\"" + meta.url + "\" target=\"_blank\" rel=\"noopener noreferrer\">X에서 트윗 보기</a>";
                        }
                        detailBox.innerHTML = html;
                      }
                    }
                  });

                  // 차트 전체 데이터 저장 (기간 필터용)
                  csvScoreChartInstance.$allDates = dates.slice();
                  csvScoreChartInstance.$allAvgScores = avgScores.slice();
                  csvScoreChartInstance.$allTrimmedScores = trimmedDailyScores.slice();
                  csvScoreChartInstance.$allCrossing = crossingPoints.slice();
                  csvScoreChartInstance.$allHighs = highPoints.slice();
                  csvScoreChartInstance.$allTweetMeta = dateTweetMeta.slice();
                  csvScoreChartInstance.$dateTweetMeta = dateTweetMeta.slice();

                  // === 활동 패턴 / 티어 / 코치봇용 추가 분석 ===
                  try {
                    updateCsvPatternAndTier({
                      rawDates: rawDates,
                      byDate: byDate,
                      dates: dates,
                      avgScores: avgScores,
                      trimmedDailyScores: trimmedDailyScores
                    });
                  } catch (e) {
                    console.warn("CSV 패턴/티어 분석 실패", e);
                  }

                  // 등급/티어를 원글 기준으로 다시 계산 (옛날 분석기와 동일)
                  recomputeTierFromPosts();


                  function applyRange(range) {
                    var total = csvScoreChartInstance.$allDates.length;
                    var count;
                    if (range === "7") count = 7;
                    else if (range === "30") count = 30;
                    else if (range === "60") count = 60;
                    else if (range === "90") count = 90;
                    else count = total;

                    count = Math.min(count, total);
                    var start = total - count;

                    var labels = csvScoreChartInstance.$allDates.slice(start);
                    var avg = csvScoreChartInstance.$allAvgScores.slice(start);
                    var trimmed = csvScoreChartInstance.$allTrimmedScores.slice(start);
                    var cross = csvScoreChartInstance.$allCrossing.slice(start);
                    var highs = csvScoreChartInstance.$allHighs.slice(start);
                    var meta = csvScoreChartInstance.$allTweetMeta.slice(start);

                    csvScoreChartInstance.data.labels = labels;
                    csvScoreChartInstance.data.datasets[0].data = avg;
                    csvScoreChartInstance.data.datasets[1].data = trimmed;
                    csvScoreChartInstance.data.datasets[2].data = cross;
                    csvScoreChartInstance.data.datasets[3].data = highs;
                    csvScoreChartInstance.$dateTweetMeta = meta;
                    csvScoreChartInstance.update();
                  }

                  // 범위 버튼 처리
                  var rangeButtons = document.querySelectorAll(".csv-range-btn");
                  rangeButtons.forEach(function (btn) {
                    btn.onclick = function () {
                      var r = btn.getAttribute("data-range");
                      rangeButtons.forEach(function (b) { b.classList.remove("active"); });
                      btn.classList.add("active");
                      applyRange(r);
                    };
                  });

                  // 기본 TOTAL
                  applyRange("all");

                  // SCORE 그래프 탭으로 자동 전환
                  showCsvPanel("score");
                }
          function handleCsvFile(file) {
                  if (!file) return;
                  if (!window.Papa) {
                    alert("CSV 파서를 불러오지 못했어요. 잠시 후 다시 시도해 주세요.");
                    return;
                  }
                  Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function (results) {
                      var rows = results.data || [];
                      if (!rows.length) {
                        alert("CSV에서 유효한 데이터 행을 찾지 못했어요.");
                        return;
                      }

                      // --- 여러 CSV를 누적해서 사용하는 통합 모드 ---
                      // 기존에 누적된 원본 행 리스트가 있으면 가져오고, 없으면 새로 만든다.
                      window.csvAccumRows = window.csvAccumRows || [];

                      // 행에서 고유 키를 뽑는 헬퍼 (ID > URL > 텍스트+날짜)
                      function getRowKey(row) {
                        if (!row) return "";
                        var id =
                          row.tweet_id ||
                          row["tweet_id"] ||
                          row["트윗 ID"] ||
                          row["트윗id"] ||
                          row["id"] ||
                          row["ID"];
                        var url =
                          row["url"] ||
                          row["URL"] ||
                          row["링크"] ||
                          row["트윗 링크"] ||
                          row["Tweet permalink"] ||
                          row["permalink"];
                        var text =
                          row["게시물 본문"] ||
                          row["Post text"] ||
                          row["Tweet text"] ||
                          row["ツイートテキスト"];
                        var date =
                          row["날짜"] ||
                          row["작성일"] ||
                          row["time"] ||
                          row["Time"] ||
                          row["date"];
                        if (id) return "id:" + String(id).trim();
                        if (url) return "url:" + String(url).trim();
                        return "txt:" + String(text || "").trim() + "|d:" + String(date || "").trim();
                      }

                      var existingKeys = {};
                      window.csvAccumRows.forEach(function (r) {
                        var k = r.__muddhaKey || getRowKey(r);
                        r.__muddhaKey = k;
                        existingKeys[k] = true;
                      });

                      rows.forEach(function (r) {
                        var k = getRowKey(r);
                        if (!k) return;
                        if (!existingKeys[k]) {
                          existingKeys[k] = true;
                          r.__muddhaKey = k;
                          window.csvAccumRows.push(r);
                        }
                      });

                      // localStorage에 통합 데이터 저장
                      try {
                        localStorage.setItem(
                          "muddhaCsvAccumRows",
                          JSON.stringify(window.csvAccumRows)
                        );
                      } catch (e) {
                        console.error("CSV 데이터를 localStorage에 저장하지 못했습니다.", e);
                      }

                      // 누적된 전체 데이터를 기준으로 다시 분석 + 월별 필터 옵션 갱신
                      populateMonthFilterFromRows(window.csvAccumRows);
                      rebuildCsvViewForMonth(window.csvMonthFilterValue || "ALL");
                    },
                    error: function (err) {
                      console.error("CSV parse error:", err);
                      alert("CSV를 읽는 중 오류가 발생했어요.");
                    }
                  });
                }


                if (analyzeBtn) {
                  analyzeBtn.addEventListener("click", function () {
                    if (!fileInput || !fileInput.files || !fileInput.files[0]) {
                      if (fileInput) fileInput.click();
                      else alert("CSV 파일 입력 요소를 찾지 못했어요.");
                      return;
                    }
                    handleCsvFile(fileInput.files[0]);
                  });
                }

                if (fileInput) {
                  fileInput.addEventListener("change", function () {
                    if (fileInput.files && fileInput.files[0]) {
                      // 파일을 선택하면 바로 분석하기
                      handleCsvFile(fileInput.files[0]);
                    }
                  });
                }

                // 페이지 로드시 localStorage에 저장된 CSV 통합 데이터를 자동 복원
                try {
                  var saved = localStorage.getItem("muddhaCsvAccumRows");
                  if (saved) {
                    var parsed = JSON.parse(saved);
                    if (Array.isArray(parsed) && parsed.length) {
                      window.csvAccumRows = parsed;
                      populateMonthFilterFromRows(window.csvAccumRows);
                      rebuildCsvViewForMonth(window.csvMonthFilterValue || "ALL");
                    }
                  }
                } catch (e) {
                  console.error("CSV 데이터를 localStorage에서 불러오지 못했습니다.", e);
                }
              });
            </script>

            <script>

            </script>
        </section>


                <section class="tab-panel" id="tab-project">
          <section class="card card-soft">
                <div class="section-header">
                  <div class="section-title" id="project-summary-title">📚 프로젝트 요약 + 원형 그래프</div>
                  <div class="section-sub" id="project-summary-sub">
                    나중에 전체뼈대.html로 이식 시 CSV 분석 결과를 기반으로 자동으로 채워질 영역입니다.
                  </div>
                </div>

                <div class="project-charts-row">
                  <div class="project-chart-single">
                    <div class="project-chart-title" id="proj-chart-title-1">프로젝트별 게시글 비율</div>
                    <canvas id="project-pie"></canvas>
                  </div>
                  <div class="project-chart-single">
                    <div class="project-chart-title" id="proj-chart-title-2">프로젝트별 평균 점수 (Trimmed 기준)</div>
                    <canvas id="project-score-pie"></canvas>
                  </div>
                  <div class="project-chart-single">
                    <div class="project-chart-title" id="proj-chart-title-3">선택 프로젝트 S~D 등급 분포</div>
                    <canvas id="project-grade-pie"></canvas>
                  </div>
                </div>

                <div class="table-wrap" id="project-summary-wrap">
                  <div class="empty">MOCK 데이터를 불러오는 중입니다...</div>
                </div>

                <div class="project-detail-controls">
                  <span>🔍 프로젝트별 게시글 보기</span>
                  <select class="project-select" id="project-select">
                    <option value="">MOCK 데이터 기준 · 프로젝트 선택</option>
                  </select>
                </div>

                <div class="table-wrap" id="project-detail-wrap">
                  <div class="empty">프로젝트를 선택하면 해당 프로젝트의 게시글과 등급이 여기에 표시됩니다.</div>
                </div>
              </section>
        </section>

        
        <section class="tab-panel" id="tab-planner">
          <div class="planner-page">
            <div class="planner-layout">
              <!-- Left : form + saved list -->
              <div class="planner-left">
                <article class="planner-card">
                  <header class="planner-card-header">
                    <div>
                      <div class="planner-card-title">새 야핑 계획 추가</div>
                      <div class="planner-card-sub">
                        날짜·주제·타입·회수를 정하고, 간단한 메모까지 같이 남겨둘 수 있습니다
                      </div>
                    </div>
                    <div class="planner-auto-save">
                      브라우저 localStorage에 자동 저장돼요.
                    </div>
                  </header>

                  <div class="planner-form-grid">
                    <div class="planner-field">
                      <label for="planDate">날짜</label>
                      <input type="date" id="planDate" />
                    </div>
                    <div class="planner-field">
                      <label for="planCount">회수</label>
                      <input type="number" id="planCount" min="1" value="1" />
                    </div>
                    <div class="planner-field wide">
                      <label for="planTitle">한글명</label>
                      <input type="text" id="planTitle" placeholder="예: KAITO,MEMEMAX" />
                    </div>
                    <div class="planner-field">
                      <label for="planType">야핑 타입</label>
                      <select id="planType">
                        <option value="스레드 / 롱폼">스레드 / 롱폼</option>
                        <option value="실시간 야핑">실시간 야핑</option>
                        <option value="리서치 정리">리서치 정리</option>
                        <option value="커뮤니티 / 밈">커뮤니티 / 밈</option>
                        <option value="기타">기타</option>
                      </select>
                    </div>
                    <div class="planner-field">
                      <label for="planProject">프로젝트 / 태그</label>
                      <input type="text" id="planProject" placeholder="예: RIVER, MEMEMAX, TEN" />
                    </div>
                    <div class="planner-field">
                      <label>필수 / 보조</label>
                      <div class="planner-chip-row" id="planImportanceGroup">
                        <button type="button" class="planner-chip active" data-value="필수">필수</button>
                        <button type="button" class="planner-chip" data-value="보조">보조</button>
                      </div>
                    </div>
                    <div class="planner-field">
                      <label>단기 / 장기</label>
                      <div class="planner-chip-row" id="planHorizonGroup">
                        <button type="button" class="planner-chip active" data-value="단기">단기</button>
                        <button type="button" class="planner-chip" data-value="장기">장기</button>
                      </div>
                    </div>
                    <div class="planner-field full">
                      <label for="planMemo">짧은 메모</label>
                      <textarea id="planMemo" rows="3" placeholder="예: 쿠키 리더보드 상위 10% 노리는 날, RWA 내러티브 강조."></textarea>
                    </div>
                  </div>

                  <div class="planner-actions-row">
                    <button id="plannerAddButton" class="planner-primary-btn">+ 야핑 계획 추가</button>
                    <button id="plannerClearButton" class="planner-secondary-btn">전체 삭제</button>
                  </div>
                </article>

                <article class="planner-card">
                  <header class="planner-card-header">
                    <div>
                      <div class="planner-card-title">저장된 야핑 리스트</div>
                      <div class="planner-card-sub">
                        완료 표시/삭제는 여기서 관리하면 돼. (날짜 기준 자동 정렬)
                      </div>
                    </div>
                    <div class="planner-filter-row">
                      <button class="planner-filter-btn active" data-filter="upcoming">다가올 일정</button>
                      <button class="planner-filter-btn" data-filter="all">전체</button>
                      <button class="planner-filter-btn" data-filter="done">완료만</button>
                    </div>
                  </header>

                  <div class="planner-saved-summary" id="plannerSavedSummary">총 0개 · 앞으로 남은 일정 0개</div>
                  <div class="planner-saved-list" id="plannerSavedList">
                    <!-- JS로 채움 -->
                  </div>
                </article>
              </div>

              <!-- Right : week/month board -->
              <div class="planner-right">
                <article class="planner-card">
                  <header class="planner-card-header">
                    <div>
                      <div class="planner-card-title">야핑 타임라인</div>
                      <div class="planner-card-sub">
                        주간 보드와 월간 캘린더를 오가면서 한 눈에 일정을 정리할 수 있어.
                      </div>
                    </div>
                    <div class="planner-calendar-controls">
                      <div class="planner-calendar-tabs">
                        <button class="planner-calendar-tab active" data-view="week">주간 보드</button>
                        <button class="planner-calendar-tab" data-view="month">월간 캘린더</button>
                      </div>
                      <div class="planner-calendar-nav">
                        <button class="planner-nav-btn" data-dir="prev">◀</button>
                        <span id="plannerRangeLabel" class="planner-range-label"></span>
                        <button class="planner-nav-btn" data-dir="next">▶</button>
                      </div>
                    </div>
                  </header>

                  <div class="planner-calendar-body">
                    <div id="plannerWeekView">
                      <div id="plannerEmptyWeek" class="planner-empty">
                        아직 이번 주에 등록된 야핑 계획이 없어요.<br/>
                        위에서 새 계획을 추가하면 이곳에 자동으로 보입니다.
                      </div>
                      <div id="plannerWeekGrid" class="planner-week-grid"></div>
                    </div>

                    <div id="plannerMonthView" style="display:none;">
                      <div id="plannerEmptyMonth" class="planner-empty">
                        이번 달에는 아직 등록된 야핑 계획이 없어요.
                      </div>
                      <div id="plannerMonthGrid" class="planner-month-grid"></div>
                    </div>
                  </div>
                </article>
              </div>
            </div>
          </div>
        </section>


        
        <section class="tab-panel" id="tab-kaito">
          <article class="card-main">
            <div class="card-main-header">
              <div>
                <div class="section-title"></div>
                <div class="section-sub">
                                  </div>
              </div>
            </div>

            <div class="kaito-hero">
              <div class="kaito-title">내 핸들로 Kaito 프로젝트 순위 보기</div>
              <div class="kaito-sub">
                예: <code>@bud_dha__</code> 처럼 입력하면, 해당 계정이 속한 InfoFi 프로젝트들의 순위를 한 번에 볼 수 있습니다
              </div>
              <div class="kaito-search-row">
                <input id="kaito-handle-input"
                       class="kaito-input"
                       placeholder="@핸들 입력 (예: @bud_dha__)" />
                <button type="button"
                        class="kaito-btn"
                        onclick="fetchKaitoLeaderboard()">
                  검색
                </button>
              </div>
              <div class="kaito-note">
                
              </div>
              <div class="kaito-source">
                데이터 출처:
                <a href="https://gomtu.xyz/kaito-leaderboard" target="_blank" rel="noopener">
                  Gomtu · Kaito Leaderboard
                </a>
                
              </div>
            </div>

            <div id="kaito-result" class="kaito-result-wrap">
              <div class="kaito-empty">
                먼저 위에서 @핸들을 입력하고 <b>검색</b>을 눌러주세요
              </div>
            </div>
          </article>
        </section>


                <section class="tab-panel" id="tab-yap">
          <article class="card-main">
            <div class="card-header-line">
              <div>
                <div class="card-title-main">YAPS+</div>
                <div class="card-title-sub">Kaito API에서 직접 불러온 실제 YAP 점수를 빠르게 확인하는 탭입니다.</div>
              </div>
            </div>

            <div class="card-body-grid">
              <!-- 입력 영역 -->
              <div style="display:flex; flex-direction:column; gap:10px;">
                <div style="display:flex; gap:8px; align-items:center;">
                  <input id="yapsplus-handle" 
                         placeholder="@핸들 입력 (예: bud_dha__)" 
                         style="flex:1; padding:10px 16px; border-radius:999px; border:1px solid rgba(255,255,255,0.14); background:rgba(8,10,25,0.8); color:#fff; font-size:13px; backdrop-filter:blur(10px);" />
                  <button id="yapsplus-btn" class="pill-btn">조회</button>
                </div>
                <div class="small-hint"></div>
              </div>

              <!-- 결과 카드 영역 -->
              <div style="display:flex; gap:14px; align-items:flex-start; margin-top:4px;">
                <!-- 메인 점수 카드 -->
                <div style="
                  flex:0 0 220px;
                  background:rgba(255,255,255,0.05);
                  border:1px solid rgba(255,255,255,0.08);
                  border-radius:16px;
                  padding:18px 20px;
                  backdrop-filter:blur(14px);
                ">
                  <div style="font-size:12px; opacity:0.8; margin-bottom:6px;">실시간 YAP 점수</div>
                  <div id="yapsplus-value" style="font-size:30px; font-weight:700; letter-spacing:-0.5px; line-height:1;">
                    -
                  </div>
                </div>

                <!-- 원본 값 / 설명 카드 -->
                <div style="
                  flex:1;
                  background:rgba(255,255,255,0.03);
                  border:1px solid rgba(255,255,255,0.06);
                  border-radius:16px;
                  padding:14px 18px;
                  font-size:13px;
                  line-height:1.6;
                  backdrop-filter:blur(14px);
                ">
                  <div id="yapsplus-meta" style="opacity:0.9;">
                    트위터(X) 핸들을 입력한 뒤 조회 버튼을 누르면 해당 계정의 YAP 원본 값을 확인할 수 있습니다.
                  </div>
                </div>
              </div>
            </div>
          </article>
        </section>


        
        <section class="tab-panel" id="tab-cookie">
          <article class="card-main">
            <div class="card-main-header">
              <div>
                <div class="section-title">🍪 Cookie 프로젝트 리더보드</div>
                <div class="section-sub">
                  Cookie가 수집한 Mindshare / Capital 랭킹을 한 카드에서, 7D·14D·30D·Total 기준으로 정리해서 보여주는 탭입니다.
                </div>
              </div>
            </div>

            <div class="cookie-hero">
              <div class="cookie-title">내 핸들 기준 프로젝트 요약 보기</div>
              <div class="cookie-sub">
                예: <code>@bud_dha__</code> 처럼 입력하면, 해당 계정이 Cookie 랭킹에 잡힌 프로젝트들의 <b>Mindshare / Capital</b> 랭킹을 한 번에 볼 수 있습니다
              </div>
              <div class="cookie-search-row">
                <input id="cookie-handle-input"
                       class="cookie-input"
                       placeholder="@핸들 입력 (예: @bud_dha__)" />
                <button type="button"
                        class="cookie-btn"
                        onclick="renderCookieLeaderboard()">
                  검색
                </button>
              </div>
              <div class="cookie-note">
               <code></code>
              </div>
            </div>

            <div class="cookie-layout">
              <section class="cookie-section">
                <div class="cookie-section-header">
                  <div class="cookie-section-title">프로젝트별 Mindshare / Capital </div>
                  <div class="cookie-section-tag">Projects × Period</div>
                </div>
                <div class="cookie-section-hint">
                  한 프로젝트 안에서 <b>Mindshare / Capital × 7D·14D·30D·Total</b> 기준으로 가장 좋은 랭킹을 골라서 카드 하나에 정리해줘요.
                </div>
                <div id="cookie-project-cards" class="cards-wrap">
                  <div class="cookie-empty">먼저 위에서 @핸들을 입력하고 <b>검색</b>을 눌러줘.</div>
                </div>
              </section>

              <section class="cookie-section">
                <div class="cookie-section-header">
                  <div class="cookie-section-title">세부 랭킹 테이블</div>
                  <div class="cookie-section-tag">Raw Entries</div>
                </div>
                <div class="cookie-section-hint">
                  Cookie에서 내려온 원본 랭킹(프로젝트 / 타입 / 기간 / 랭크 / 퍼센트)을 그대로 테이블로 정리한 영역이에요.
                </div>
                <div class="table-wrap">
                  <table class="cookie-table">
                    <thead>
                      <tr>
                        <th>Project</th>
                        <th>Type</th>
                        <th>Period</th>
                        <th>Rank</th>
                        <th>%</th>
                        <th>Lang</th>
                      </tr>
                    </thead>
                    <tbody id="cookie-raw-tbody">
                      <tr>
                        <td colspan="6" class="cookie-empty">
                          위에서 @핸들을 입력하면, 이 영역에 Cookie에서 가져온 세부 랭킹이 뜹니다.
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </section>
            </div>
          </article>
        </section>


        <section class="tab-panel" id="tab-community">
          <div class="community-shell">
            <header class="community-header">
              <div class="community-header-left">
                <div class="community-title">MUDDHA 커뮤니티</div>
              </div>
              <div class="community-user" id="communityUserBadge">로그인 상태를 불러오는 중...</div>
            </header>

            <div class="community-tabs-row">
              <div class="community-tabs">
                <button class="community-tab-btn active" data-board="free">자유게시판</button>
                <button class="community-tab-btn" data-board="request">상호요청</button>
              </div>
              <div class="community-write-toggle-row">
                <button class="community-write-toggle-btn" id="communityWriteToggleTop">
                  <span class="icon">✏️</span>
                  <span>글쓰기</span>
                </button>
                <span class="community-write-hint-mini">글쓰기 버튼을 누르면 아래 입력창이 펼쳐져요.</span>
              </div>
            </div>

            <section class="community-main">
              <div class="community-topbar">
                <div class="community-top-left">
                  <span class="community-badge-board" id="communityBoardLabel">자유게시판</span>
                  <span class="community-board-count-text" id="communityBoardCountText">총 0개 글</span>
                </div>
                <div class="community-top-right">
                  <div class="community-sort-toggle">
                    <button class="community-sort-btn active" data-sort="latest">최신</button>
                    <button class="community-sort-btn" data-sort="popular">인기</button>
                  </div>
                </div>
              </div>

              <div class="community-board-list-wrap">
                <table class="community-table">
                  <thead>
                    <tr>
                      <th class="community-col-no">번호</th>
                      <th class="community-col-title">제목</th>
                      <th class="community-col-writer">글쓴이</th>
                      <th class="community-col-date">작성일</th>
                      <th class="community-col-views">조회</th>
                      <th class="community-col-likes">추천</th>
                    </tr>
                  </thead>
                  <tbody id="communityBoardBody">
                    <tr>
                      <td colspan="6" class="community-empty-row">아직 글이 없습니다. 하단 글쓰기 버튼으로 첫 글을 남겨보세요.</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="community-write-panel" id="communityWritePanel">
                <div class="community-write-panel-inner">
                  <div class="community-write-row">
                    <div class="community-write-label">제목</div>
                    <input id="communityPostTitle" class="community-write-input" type="text" maxlength="80" placeholder="제목을 입력해 주세요" />
                  </div>
                  <div class="community-write-row">
                    <div class="community-write-label">내용</div>
                    <textarea id="communityPostContent" class="community-write-textarea" placeholder="마인드쉐어, 얍핑, 크립토 이야기 아무거나 적어도 됩니다 🙂"></textarea>
                  </div>
                  <div class="community-write-bottom-row">
                    <div class="community-write-hint">
                      Supabase <code>community_posts</code> 테이블에 저장됩니다.<br/>
                      (board / title / body / user_id / nickname / handle / created_at ...)
                    </div>
                    <button class="community-write-submit-btn" id="communityPostSubmitBtn">작성하기</button>
                  </div>
                </div>
              </div>

              <div class="community-footerbar">
                <div class="community-paging-dots">
                  <div class="community-paging-dot active">1</div>
                  <div class="community-paging-dot">2</div>
                  <div class="community-paging-dot">3</div>
                  <div class="community-paging-dot">▶</div>
                </div>
                <button class="community-footer-write-btn" id="communityWriteToggleBottom">
                  <span>✏️</span>
                  <span>글쓰기</span>
                </button>
              </div>
            </section>
          </div>
        </section>

        <section class="tab-panel" id="tab-profile">
          <div class="profile-page-layout">
            <div class="profile-main-card">
              <div class="profile-header-row">
                <div class="profile-avatar-wrap">
                  <img id="profileAvatar" class="profile-avatar-img" src="https://unavatar.io/twitter/bud_dha__" alt="프로필 아바타" />
                </div>
                <div class="profile-header-text">
                  <div class="profile-handle-line">
                    <span class="profile-name" id="profileNamePreview">붓다</span>
                    <span class="profile-handle" id="profileHandlePreview">@bud_dha__</span>
                  </div>
                  <p class="profile-caption">분석기 화면 상단과 여러 카드에 표시될 기본 프로필 정보예요.</p>
                </div>
                <div class="profile-pill">
                  내 프로필
                </div>
              </div>

              <div class="profile-form-grid">
                <div class="profile-field">
                  <label for="profileDisplayName">표시 닉네임</label>
                  <p class="field-hint">분석기 화면 상단과 여러 카드에서 표시될 이름이에요.</p>
                  <input id="profileDisplayName" type="text" placeholder="예: 붓다" />
                </div>

                <div class="profile-field">
                  <label for="profileMuddhaId">MUDDHA 아이디</label>
                  <p class="field-hint">
                    로그인에 쓰는 이메일의 앞부분이에요. <b>@muddha-id.com</b> 으로 자동으로 붙습니다.
                  </p>
                  <input id="profileMuddhaId" type="text" placeholder="예: buddha" />
                </div>

                <div class="profile-field">
                  <label for="profileTwitterHandle">트위터(X) 핸들</label>
                  <p class="field-hint">
                    핸들을 저장하면 <code>https://unavatar.io/twitter/핸들</code> 을 기반으로 프로필 이미지를 불러옵니다.
                  </p>
                  <input id="profileTwitterHandle" type="text" placeholder="예: bud_dha__" />
                </div>
              </div>

              <div class="profile-actions-row">
                <button id="profileSaveButton" class="primary-btn">프로필 저장</button>
              </div>
            </div>

            <div class="profile-history-card">
              <div class="profile-history-header">
                <h3>내 히스토리</h3>
                <span class="history-badge">내 프로필</span>
              </div>
              <p class="history-description">
                이 브라우저에서 프로필을 수정할 때마다 간단한 기록을 남겨둡니다.<br />
                (나중에 Supabase에 연결해서 계정 단위 히스토리로 확장할 수 있어요.)
              </p>
              <div id="profileHistoryList" class="profile-history-list">
                <!-- 자바스크립트로 최근 히스토리가 들어갑니다 -->
              </div>
            </div>
          </div>
        </section>
      </section>
    </main>
  </div>

  <script>
    const navItems = document.querySelectorAll(".nav-item");
    const panels = document.querySelectorAll(".tab-panel");
    const scrollContainer = document.getElementById("scrollContainer");
    const topTitle = document.querySelector(".top-title");
    const topSubtitle = document.querySelector(".top-subtitle");

    const titles = {
      "tab-dashboard": [" "],
      "tab-guide": ["사용방법", "MUDDHA Mindshare를 어떻게 활용할지에 대한 안내"],
      "tab-csv": ["CSV 분석", "X/Twitter CSV를 업로드해서 내 활동을 정제하고 분석하는 화면"],
      "tab-project": ["프로젝트별 마인드쉐어", "내가 자주 언급하는 프로젝트들의 Mindshare 비교"],
      "tab-planner": ["야핑 플래너", "앞으로의 야핑 계획을 세우는 플래너"],
      "tab-kaito": ["KAITO 리더보드", "KAITO 기반 YAP 리더보드 및 관련 실험"],
      "tab-yap": ["YAPS +", "YAP 곡선, 히스토리, 실험 기능 모음"],
      "tab-cookie": ["Cookie 리더보드", "Cookie 생태계에서의 랭킹과 포지션"],
      "tab-community": ["커뮤니티", "메모, 초안, 링크를 모아두는 공간"],
      "tab-profile": ["내 프로필", "프로필 정보와 활동 히스토리를 한 번에 보는 화면"]
    };

    navItems.forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-target");

        navItems.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        panels.forEach(panel => {
          if (panel.id === target) {
            panel.classList.add("active");
          } else {
            panel.classList.remove("active");
          }
        });

        if (scrollContainer) scrollContainer.scrollTop = 0;

        if (titles[target]) {
          topTitle.textContent = titles[target][0];
          topSubtitle.textContent = titles[target][1];
        }
      });
    });
  </script>

  <script>
    const SUPABASE_URL = "https://ajzgeshowxalnnmemowv.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFqemdlc2hvd3hhbG5ubWVtb3d2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNDM1NjEsImV4cCI6MjA3OTkxOTU2MX0.6VrDH1RPT_TTwkN2hwOsEsP8xnv2fZIsFXvWkvy_qm4";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function muddhaIdToEmail(idRaw){
      const id = (idRaw || "").trim();
      if(!id) return "";
      if(id.includes("@")) return id;
      return id + "@muddha-id.com";
    }

    async function muddhaHandleLogin(){
      const idInput = document.getElementById("loginId");
      const pwInput = document.getElementById("loginPassword");
      const errorEl = document.getElementById("muddhaLoginError");
      if(errorEl) errorEl.textContent = "";

      const rawId = idInput ? idInput.value.trim() : "";
      const pw = pwInput ? pwInput.value : "";

      if(!rawId || !pw){
        if(errorEl) errorEl.textContent = "아이디와 비밀번호를 모두 입력해 주세요.";
        return;
      }

      const email = muddhaIdToEmail(rawId);
      if(!email){
        if(errorEl) errorEl.textContent = "아이디 형식이 이상해요. 다시 확인해 주세요.";
        return;
      }

      try{
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email,
          password: pw
        });
        if(error){
          console.warn(error);
          if(errorEl) errorEl.textContent = "아이디 또는 비밀번호가 잘못되었습니다.";
          return;
        }
        if(data && data.session){
          const overlay = document.getElementById("muddhaLoginOverlay");
          if(overlay) overlay.style.display = "none";
          try{
            if(typeof tryAutoLoadKaitoForCurrentUser === "function"){
              tryAutoLoadKaitoForCurrentUser();
            }
            if (typeof window !== "undefined" && typeof window.muddhaProfileReload === "function") {
              window.muddhaProfileReload();
            }
          }catch(e){
            console.warn("auto KAITO after login error:", e);
          }
        }else if(errorEl){
          errorEl.textContent = "로그인 세션을 만들지 못했어요.";
        }
      }catch(e){
        console.warn("muddhaHandleLogin error:", e);
        const errorEl = document.getElementById("muddhaLoginError");
        if(errorEl) errorEl.textContent = "알 수 없는 오류가 발생했어요.";
      }
    }

    async function muddhaHandleSignup(){
      const idInput = document.getElementById("signupId");
      const pwInput = document.getElementById("signupPassword");
      const pw2Input = document.getElementById("signupPasswordConfirm");
      const nickInput = document.getElementById("signupNickname");
      const handleInput = document.getElementById("signupHandle");
      const errorEl = document.getElementById("muddhaLoginError");
      if(errorEl) errorEl.textContent = "";

      const rawId = idInput ? idInput.value.trim() : "";
      const pw = pwInput ? pwInput.value : "";
      const pw2 = pw2Input ? pw2Input.value : "";
      const nickname = nickInput ? nickInput.value.trim() : "";
      const handle = handleInput ? handleInput.value.trim() : "";

      if(!rawId || !pw || !pw2){
        if(errorEl) errorEl.textContent = "아이디, 비밀번호, 비밀번호 확인을 모두 입력해 주세요.";
        return;
      }
      if(pw.length < 8){
        if(errorEl) errorEl.textContent = "비밀번호는 최소 8자 이상이어야 합니다.";
        return;
      }
      if(pw !== pw2){
        if(errorEl) errorEl.textContent = "비밀번호가 서로 다릅니다.";
        return;
      }
      if(!handle){
        if(errorEl) errorEl.textContent = "트위터 핸들은 필수입니다.";
        return;
      }

      const email = muddhaIdToEmail(rawId);
      if(!email){
        if(errorEl) errorEl.textContent = "아이디 형식이 이상해요. 다시 확인해 주세요.";
        return;
      }

      try{
        const { data, error } = await supabaseClient.auth.signUp({
          email,
          password: pw
        });
        if(error){
          console.warn(error);
          if(errorEl) errorEl.textContent = "회원가입 중 오류가 발생했어요.";
          return;
        }
        if(data && data.user){
          // profiles 테이블에 nickname / handle 저장 (있으면)
          try{
            await supabaseClient
              .from("profiles")
              .upsert({
                id: data.user.id,
                user_id: data.user.id,
                muddah_id: rawId || null,
                nickname,
                handle,
                x_handle: handle
              }, { onConflict: "id" });
          }catch(e){ console.warn("profiles upsert error:", e); }

          if(errorEl) errorEl.textContent = "회원가입 완료! 이제 로그인 탭에서 로그인해 주세요.";
        }else if(errorEl){
          errorEl.textContent = "회원가입은 되었는데 세션을 만들지 못했어요. 로그인 탭에서 다시 시도해 주세요.";
        }
      }catch(e){
        console.warn("muddhaHandleSignup error:", e);
        const errorEl = document.getElementById("muddhaLoginError");
        if(errorEl) errorEl.textContent = "알 수 없는 오류가 발생했어요.";
      }
    }

    document.addEventListener("DOMContentLoaded", async function(){
      const overlay = document.getElementById("muddhaLoginOverlay");
      const tabLogin = document.getElementById("muddhaTabLogin");
      const tabSignup = document.getElementById("muddhaTabSignup");
      const loginFields = document.getElementById("muddhaLoginFields");
      const signupFields = document.getElementById("muddhaSignupFields");
      const loginBtn = document.getElementById("muddhaLoginButton");
      const signupBtn = document.getElementById("muddhaSignupButton");
      const logoutBtn = document.querySelector(".pill-btn.secondary");


      function setMode(mode){
        const titleEl = document.getElementById("muddhaLoginTitle");
        const descEl = document.getElementById("muddhaLoginDesc");
        const errEl = document.getElementById("muddhaLoginError");
        if(errEl) errEl.textContent = "";

        if(mode === "login"){
          if(tabLogin) tabLogin.classList.add("active");
          if(tabSignup) tabSignup.classList.remove("active");
          if(loginFields) loginFields.style.display = "block";
          if(signupFields) signupFields.style.display = "none";
          if(loginBtn) loginBtn.style.display = "block";
          if(signupBtn) signupBtn.style.display = "none";
          if(titleEl) titleEl.textContent = "MUDDHA 로그인";
          if(descEl) descEl.innerHTML = "아이디와 비밀번호를 입력하면 돼요. 내부적으로 <b>@muddha-id.com</b>이 자동으로 붙습니다.";
        }else{
          if(tabSignup) tabSignup.classList.add("active");
          if(tabLogin) tabLogin.classList.remove("active");
          if(loginFields) loginFields.style.display = "none";
          if(signupFields) signupFields.style.display = "block";
          if(signupBtn) signupBtn.style.display = "block";
          if(loginBtn) loginBtn.style.display = "none";
          if(titleEl) titleEl.textContent = "MUDDHA 회원가입";
          if(descEl) descEl.innerHTML = "아이디 + 비밀번호 + 트위터 핸들을 설정하면 돼요. 아이디는 내부적으로 <b>@muddha-id.com</b> 이메일로 변환됩니다.";
        }
      }

      if(tabLogin) tabLogin.addEventListener("click", function(){ setMode("login"); });
      if(tabSignup) tabSignup.addEventListener("click", function(){ setMode("signup"); });
      if(loginBtn) loginBtn.addEventListener("click", function(e){ e.preventDefault(); muddhaHandleLogin(); });
      if(signupBtn) signupBtn.addEventListener("click", function(e){ e.preventDefault(); muddhaHandleSignup(); });
      if(logoutBtn) logoutBtn.addEventListener("click", async function(e){
        e.preventDefault();
        try{
          const { error } = await supabaseClient.auth.signOut();
          if(error){
            console.warn("logout error:", error);
          }
        }catch(err){
          console.warn("logout exception:", err);
        }
        if(overlay) overlay.style.display = "flex";
      });

      setMode("login");

      try{
        const { data, error } = await supabaseClient.auth.getSession();
        if(!error && data && data.session){
          if(overlay) overlay.style.display = "none";
          try{
            if(typeof tryAutoLoadKaitoForCurrentUser === "function"){
              tryAutoLoadKaitoForCurrentUser();
            }
            if (typeof window !== "undefined" && typeof window.muddhaProfileReload === "function") {
              window.muddhaProfileReload();
            }
          }catch(e){
            console.warn("auto KAITO after session restore error:", e);
          }
        }else{
          if(overlay) overlay.style.display = "flex";
        }
      }catch(e){
        console.warn("getSession error:", e);
        if(overlay) overlay.style.display = "flex";
      }
    });
  </script>

<!-- Supabase Login Integration -->



  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  

  
<script>
  // ===== Kaito / InfoFi 리더보드 (Supabase Edge Function) =====
  const KAITOPROXY_URL = "https://kaito-proxy.wnehdrla8382.workers.dev/kaito";

  const KAITO_TOPIC_TWITTER_HANDLES = {
  "Aptos": "Aptos",
  "Beldex": "BeldexCoin",
  "Berachain": "berachain",
  "Camp Network": "campnetworkxyz",
  "Ethereum": "ethereum",
  "Fogo": "fogo",
  "Injective": "injective",
  "Irys": "irys_xyz",
  "Kaia": "KaiaChain",
  "MANTRA": "MANTRA_Chain",
  "Mavryk": "MavrykNetwork",
  "Mitosis": "MitosisOrg",
  "Monad": "monad",
  "Movement": "movementlabsxyz",
  "Near": "NEARProtocol",
  "PEAQ": "peaq",
  "Polkadot": "Polkadot",
  "Sei": "SeiNetwork",
  "Somnia": "Somnia_Network",
  "Sonic": "SonicLabs",
  "S": "SonicLabs",
  "Story": "StoryProtocol",
  "XION": "burnt_xion",
  "CreatorBid": "CreatorBid",
  "INFINIT": "Infinit_Labs",
  "Newton": "MagicNewton",
  "Surf": "SurfAI",
  "Symphony": "symphonyio",
  "Talus": "Talus_Labs",
  "Theoriq": "TheoriqAI",
  "Virtuals Protocol": "virtuals_io",
  "Warden Protocol": "wardenprotocol",
  "Wayfinder": "AIWayfinder",
  "ANIME": "animecoin",
  "Boop": "boopdotfun",
  "Doodles": "doodles",
  "MemeX": "MemeX_MRC20",
  "Moonbirds": "moonbirds",
  "PENGU": "pudgypenguins",
  "Corn": "use_corn",
  "GOAT Network": "GOATRollup",
  "Lombard": "Lombard_Finance",
  "Portal to BTC": "PortaltoBitcoin",
  "SatLayer": "satlayer",
  "Openmind": "openmind_agi",
  "Arbitrum": "arbitrum",
  "Katana": "katana",
  "Mantle": "0xMantle",
  "MegaETH": "megaeth",
  "Polygon": "0xPolygon",
  "SOON": "soon_svm",
  "Falcon Finance": "FalconStable",
  "Frax": "fraxfinance",
  "Huma": "humafinance",
  "MoreMarkets": "moremarketsxyz",
  "Multipli": "multiplifi",
  "Noble": "noble_xyz",
  "Orderly": "OrderlyNetwork",
  "Pyth": "PythNetwork",
  "Soul Protocol": "0xSoulProtocol",
  "STBL": "stbl_official",
  "Turtle Club": "turtleclubhouse",
  "Walrus": "WalrusProtocol",
  "Boundless": "boundless_xyz",
  "Brevis": "brevis_zk",
  "Cysic": "cysic_xyz",
  "Miden": "0xMiden",
  "Starknet": "Starknet",
  "Succinct": "SuccinctLabs",
  "Zcash": "Zcash",
  "zkPass": "zkPass",
  "Anoma": "anoma",
  "Bless": "theblessnetwork",
  "Bybit TradFi": "Bybit_Official",
  "Humanity Protocol": "Humanityprot",
  "Integra": "integra_layer",
  "Multibank": "multibank_io",
  "Thrive Protocol": "thriveprotocol",
  "ApeX": "OfficialApeXdex",
  "Bluefin": "bluefinapp",
  "dYdX": "dYdX",
  "Flipster": "flipster_io",
  "MemeMax": "MemeMax_Fi",
  "Momentum": "MMTFinance",
  "PARADEX": "paradex",
  "Kaito": "KaitoAI",
  "OG": "0G_labs",
  "Allora": "AlloraNetwork",
  "Billions Network": "billions_ntwk",
  "Edgen": "EdgenTech",
  "EverlynAI": "everlyn_ai",
  "IQ": "IQAIcom",
  "Kindred": "Kindred_AI",
  "Mira Network": "miranetwork",
  "Novastro": "Novastro_xyz",
  "NYT": "Novastro_xyz",
  "Noya.ai": "NetworkNoya",
  "OpenLedger": "OpenledgerHQ",
  "PiP World": "pip_world",
  "PlayAI": "playAInetwork",
  "Sapien": "JoinSapien",
  "Sentient": "SentientAGI",
  "UXLINK": "UXLINKofficial",
  "Tria": "useTria",
  "Anichess": "AnichessGame",
  "Bitdealer": "bitdealernet",
  "Defi App": "defiapp",
  "Hana": "HanaNetwork",
  "InfineX": "infinex",
  "Lumiterra": "LumiterraGame",
  "MapleStory Universe": "MaplestoryU",
  "Metawin": "MetaWin",
  "Parti": "jointheparti",
  "Puffpaw": "puffpaw",
  "Rainbow": "rainbowdotme",
  "Sidekick": "Sidekick_Labs",
  "SIXR Cricket": "SIXR_cricket",
  "Sophon": "Sophon",
  "Vultisig": "vultisig",
  "YEET": "yeet",
  "Caldera": "Calderaxyz",
  "Initia": "initia",
  "Skate": "skate_chain",
  "Union": "union_build",
  "KAIO": "KAIO_xyz",
  "Theo": "Theo_Network",
  "THEOTHEO": "Theo_Network"
};

  async function fetchKaitoLeaderboard() {
    const input = document.getElementById("kaito-handle-input");
    const resultDiv = document.getElementById("kaito-result");

    if (!input || !resultDiv) {
      alert("KAITO 리더보드 입력 영역을 찾을 수 없습니다.");
      return;
    }

    let handle = (input.value || "").trim();
    if (!handle) {
      resultDiv.innerHTML = '<div class="kaito-empty">먼저 @핸들을 입력해 주세요</div>';
      return;
    }
    if (handle.startsWith("@")) {
      handle = handle.slice(1);
    }

    resultDiv.innerHTML = '<div class="kaito-empty">곰투(Kaito)에서 데이터를 불러오는 중...</div>';

    try {
      const resp = await fetch(
        KAITOPROXY_URL + "?username=" + encodeURIComponent(handle),
        { method: "GET" }
      );

      if (!resp.ok) {
        resultDiv.innerHTML = '<div class="kaito-empty">API 응답 오류: ' + resp.status + '</div>';
        return;
      }

      const json = await resp.json();
      console.log("Kaito summary raw:", json);

      const rawList = json && Array.isArray(json.data) ? json.data : [];
      if (!rawList.length) {
        resultDiv.innerHTML = '<div class="kaito-empty">리더보드 데이터를 찾지 못했어.</div>';
        return;
      }

      const byTopic = {};
      rawList.forEach(item => {
        const topic = item.topic_id || item.topic || "UNKNOWN";
        if (!byTopic[topic]) byTopic[topic] = [];
        byTopic[topic].push(item);
      });

      const topicNames = Object.keys(byTopic);
      if (!topicNames.length) {
        resultDiv.innerHTML = '<div class="kaito-empty">7D / 30D / 3M 데이터가 없습니다.</div>';
        return;
      }

      function findHandleForTopic(topic) {
        const t = (topic || "").toLowerCase();
        for (const key in KAITO_TOPIC_TWITTER_HANDLES) {
          if (key.toLowerCase() === t) return KAITO_TOPIC_TWITTER_HANDLES[key];
        }
        return "";
      }

      const durationOrder = ["7D", "30D", "3M"];
      function durationIndex(d) {
        const i = durationOrder.indexOf(d);
        return i === -1 ? 999 : i;
      }
      function rankValue(r) {
        if (typeof r === "number") return r;
        const n = parseInt(r, 10);
        return isNaN(n) ? 999999 : n;
      }

      const PROJECT_DISPLAY_NAME_OVERRIDES = {
        "S": "Sonic",
        "THEOTHEO": "Theo",
        "NYT": "Novastro"
      };

      const cardsHtml = topicNames.map(topic => {
        const displayTopic = PROJECT_DISPLAY_NAME_OVERRIDES[topic] || topic;
        const rows = byTopic[topic].slice().sort((a, b) => {
          const d = durationIndex(a.duration) - durationIndex(b.duration);
          if (d !== 0) return d;
          return rankValue(a.rank) - rankValue(b.rank);
        });

        const topicHandle = findHandleForTopic(topic);
        let logoUrl = "";
        if (topicHandle) {
          logoUrl = "https://unavatar.io/twitter/" + encodeURIComponent(topicHandle);
        }
        const initial = (topic || "?").charAt(0).toUpperCase();
        const logoHtml = logoUrl
          ? '<div style="width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#020617;margin-right:10px;overflow:hidden;">'
              + '<img src="' + logoUrl + '" alt="' + displayTopic + ' logo" style="width:100%;height:100%;object-fit:cover;">'
            + '</div>'
          : '<div style="width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#020617;margin-right:10px;color:#e5e7eb;font-size:14px;font-weight:700;">'
              + initial +
            '</div>';

        const rowsHtml = rows.map(item => {
          const dur = item.duration || "-";
          const rank = (item.rank ?? "-");
          const rawTier = item.tier || "-";
          const tierLower = String(rawTier || "").toLowerCase();
          const tier =
            tierLower === "tier2" ? "Wider Community" :
            tierLower === "tier1" ? "Creator" :
            rawTier;
          const mindshare = (item.mindshare ?? "-");
          return `
            <tr>
              <td style="padding:6px 8px;border-bottom:1px solid rgba(55,65,81,0.7);text-align:center;">${dur}</td>
              <td style="padding:6px 8px;border-bottom:1px solid rgba(55,65,81,0.7);text-align:center;">#${rank}</td>
              <td style="padding:6px 8px;border-bottom:1px solid rgba(55,65,81,0.7);text-align:center;">${tier}</td>
              <td style="padding:6px 8px;border-bottom:1px solid rgba(55,65,81,0.7);text-align:right;">${mindshare}</td>
            </tr>
          `;
        }).join("");

        return `
          <div style="
            margin-top:10px;
            margin-bottom:10px;
            border-radius:18px;
            border:1px solid rgba(129, 140, 248, 0.9);
            background:linear-gradient(135deg,rgba(15,23,42,0.96),rgba(17,24,39,0.98));
            padding:14px 14px 12px;
            box-shadow:0 18px 35px rgba(15,23,42,0.9);
          ">
            <div style="
              font-size:13px;
              line-height:1.6;
              color:#e5e7eb;
            ">
              <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px;">
                <div style="display:flex;align-items:center;">
                  ${logoHtml}
                  <div>
                    <div style="font-weight:700;font-size:13px;">${displayTopic}</div>
                    <div style="font-size:12px;opacity:0.8;">@${handle}</div>
                  </div>
                </div>
              </div>
              <div style="border-radius:12px;overflow:hidden;border:1px solid rgba(55,65,81,0.9);">
                <table style="width:100%;border-collapse:collapse;font-size:12px;">
                  <thead>
                    <tr style="background:rgba(31,41,55,0.95);">
                      <th style="padding:6px 8px;border-bottom:1px solid rgba(55,65,81,1);text-align:center;">기간</th>
                      <th style="padding:6px 8px;border-bottom:1px solid rgba(55,65,81,1);text-align:center;">Rank</th>
                      <th style="padding:6px 8px;border-bottom:1px solid rgba(55,65,81,1);text-align:center;">Tier</th>
                      <th style="padding:6px 8px;border-bottom:1px solid rgba(55,65,81,1);text-align:right;">Mindshare</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${rowsHtml}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;
      }).join("");

      resultDiv.innerHTML = cardsHtml;
    } catch (err) {
      console.error("fetchKaitoLeaderboard error:", err);
      const msg = (err && err.message) ? err.message : err;
      resultDiv.innerHTML = '<div class="kaito-empty">데이터 불러오기 실패: ' + msg + '</div>';
    }
  }
</script>
<script>
  // 대시보드용 KAITO Tier1(크리에이터) 슬라이더 렌더링
  console.log('KAITO dashboard auto script loaded');
  function renderKaitoDashboardSlider(rawList, handle) {
    try {
      const wrap = document.getElementById("kaito-dashboard-slider");
      if (!wrap) return;

      if (!rawList || !rawList.length) {
        wrap.innerHTML =
          '<div class="kaito-slider-empty">KAITO 데이터가 없어서 크리에이터 랭킹을 만들 수 없어.</div>';
        return;
      }

      // 모든 티어 포함: 주어진 rawList 전체 사용
      const allRows = rawList.slice();

      if (!allRows.length) {
        wrap.innerHTML =
          '<div class="kaito-slider-empty">이 계정은 아직 KAITO 랭킹이 없어.</div>';
        return;
      }

      // 토픽별로 대표 행 1개씩만 선택 (랭킹, 기간 우선순위 기준)
      const byTopic = {};
      allRows.forEach(function (item) {
        const topic = item.topic_id || item.topic || "UNKNOWN";
        if (!byTopic[topic]) byTopic[topic] = [];
        byTopic[topic].push(item);
      });

      const durationOrder = ["7D", "30D", "3M"];
      function durationIndex(d) {
        const i = durationOrder.indexOf(d);
        return i === -1 ? 999 : i;
      }
      function rankValue(r) {
        if (typeof r === "number") return r;
        const n = parseInt(r, 10);
        return isNaN(n) ? 999999 : n;
      }

      const topics = Object.keys(byTopic);
      const cards = topics.map(function (topic) {
        const rows = byTopic[topic].slice().sort(function (a, b) {
          const d = durationIndex(a.duration) - durationIndex(b.duration);
          if (d !== 0) return d;
          return rankValue(a.rank) - rankValue(b.rank);
        });
        const best = rows[0];

        const projectName = best.topic || best.topic_id || topic;
        const duration = best.duration || "-";
        const rank = best.rank != null ? best.rank : "-";
        const mindshare = best.mindshare != null ? best.mindshare : "-";
        const cleanHandle = (handle || "").replace(/^@/, "");

        // KAITO 탭에서 사용하는 findHandleForTopic 재활용 (있으면)
        let topicHandle = "";
        if (typeof findHandleForTopic === "function") {
          topicHandle = findHandleForTopic(projectName);
        } else if (typeof KAITO_TOPIC_TWITTER_HANDLES !== "undefined") {
          const t = String(projectName || "").toLowerCase();
          for (const key in KAITO_TOPIC_TWITTER_HANDLES) {
            if (key.toLowerCase() === t) {
              topicHandle = KAITO_TOPIC_TWITTER_HANDLES[key];
              break;
            }
          }
        }

        let logoUrl = "";
        if (topicHandle) {
          logoUrl = "https://unavatar.io/twitter/" + encodeURIComponent(topicHandle);
        }
        const initial = (projectName || "?").charAt(0).toUpperCase();
        const logoHtml = logoUrl
          ? '<div class="kaito-slider-logo"><img src="' + logoUrl + '" alt="' + projectName + ' logo"></div>'
          : '<div class="kaito-slider-logo">' + initial + "</div>";

        return {
          rankValue: rankValue(rank),
          html:
            '<div class="kaito-slider-card">' +
              '<div class="kaito-slider-header">' +
                logoHtml +
                '<div>' +
                  '<div class="kaito-slider-title">' + projectName + '</div>' +
                  '<div class="kaito-slider-meta">@' + cleanHandle + ' · Tier1 Creator</div>' +
                '</div>' +
              '</div>' +
              '<div class="kaito-slider-body">' +
                '<div>📆 기준: <b>' + duration + '</b></div>' +
                '<div>🏆 랭킹: <b>#' + rank + '</b></div>' +
                '<div>✨ Mindshare: <b>' + mindshare + '</b></div>' +
              '</div>' +
            '</div>'
        };
      }).sort(function (a, b) {
        return a.rankValue - b.rankValue;
      });

      const trackHtml =
        '<div class="kaito-slider-track">' +
          cards.map(function (c) { return c.html; }).join("") +
        '</div>';

      wrap.innerHTML = trackHtml;
    } catch (e) {
      console.warn("renderKaitoDashboardSlider error:", e);
    }
  }

  // 로그인된 사용자의 handle 기준으로 KAITO 자동 로드 (대시보드 전용)
  
  
async function refreshDashboardKaitoForCurrentUser() {
  try {
    const wrap = document.getElementById("kaito-dashboard-slider");
    if (!wrap) return;

    if (typeof supabaseClient === "undefined" || typeof KAITOPROXY_URL === "undefined") {
      wrap.innerHTML = '<div class="kaito-slider-empty">로그인 또는 KAITO 설정을 찾을 수 없어.</div>';
      return;
    }

    const { data: userData, error: userError } = await supabaseClient.auth.getUser();
    if (userError || !userData || !userData.user) {
      console.warn("KAITO auto dashboard: auth.getUser error or empty user", userError, userData);
      wrap.innerHTML = '<div class="kaito-slider-empty">로그인 정보를 불러오지 못했어.</div>';
      return;
    }

    const userId = userData.user.id;
    console.log("KAITO auto dashboard: current user id =", userId);

    const { data: profile, error: profErr } = await supabaseClient
      .from("profiles")
      .select("id, user_id, handle, x_handle")
      .eq("user_id", userId)
      .maybeSingle();

    console.log("KAITO auto dashboard: loaded profile =", profile, "error =", profErr);

    if (profErr) {
      wrap.innerHTML = '<div class="kaito-slider-empty">프로필 정보를 불러오지 못했어.</div>';
      return;
    }

    if (!profile) {
      wrap.innerHTML = '<div class="kaito-slider-empty">프로필이 아직 생성되지 않았어.</div>';
      return;
    }

    let handle = (profile.handle || profile.x_handle || "").trim();
    if (!handle) {
      wrap.innerHTML = '<div class="kaito-slider-empty">프로필에 Twitter 핸들이 저장되어 있지 않아.</div>';
      return;
    }

    const cleanHandle = handle.replace(/^@+/, "");
    console.log("KAITO auto dashboard: using handle =", cleanHandle);

    // 실제 API 호출
    wrap.innerHTML = '<div class="kaito-slider-empty">KAITO Tier1 리더보드 데이터를 불러오는 중...</div>';

    const resp = await fetch(
      KAITOPROXY_URL + "?username=" + encodeURIComponent(cleanHandle),
      { method: "GET" }
    );

    if (!resp.ok) {
      console.error("KAITO auto dashboard: worker fetch failed", resp.status, resp.statusText);
      wrap.innerHTML = '<div class="kaito-slider-empty">KAITO 데이터를 불러오지 못했어. 잠시 후 다시 시도해 줘.</div>';
      return;
    }

    const json = await resp.json();
    const rawList = Array.isArray(json.data) ? json.data : [];
    console.log("KAITO auto dashboard: received project count =", rawList.length);

    renderKaitoDashboardSlider(rawList, cleanHandle);
  } catch (e) {
    console.error("KAITO auto dashboard unexpected error:", e);
  }
}
async function refreshDashboardYapForCurrentUser() {
  const yapEl = document.getElementById("dashboardYapReal");
  if (!yapEl) return;

  yapEl.textContent = "불러오는 중...";

  try {
    if (typeof supabaseClient === "undefined") {
      yapEl.textContent = "-";
      return;
    }

    const { data: userData, error: userError } = await supabaseClient.auth.getUser();
    if (userError || !userData || !userData.user) {
      console.warn("YAP dashboard: auth.getUser error or empty user", userError, userData);
      yapEl.textContent = "-";
      return;
    }

    const userId = userData.user.id;

    const { data: profile, error: profErr } = await supabaseClient
      .from("profiles")
      .select("handle, x_handle")
      .eq("user_id", userId)
      .maybeSingle();

    if (profErr) {
      console.warn("YAP dashboard: profiles load error:", profErr);
    }

    if (!profile) {
      yapEl.textContent = "-";
      return;
    }

    let handle = (profile.handle || profile.x_handle || "").trim();
    if (!handle) {
      yapEl.textContent = "-";
      return;
    }

    const cleanHandle = handle.replace(/^@+/, "");
    console.log("YAP dashboard: using handle =", cleanHandle);

    const resp = await fetch(
      "https://kaito-yap-proxy.wnehdrla8382.workers.dev/?username=" + encodeURIComponent(cleanHandle),
      { method: "GET" }
    );

    if (!resp.ok) {
      console.error("YAP dashboard: fetch failed", resp.status, resp.statusText);
      yapEl.textContent = "-";
      return;
    }

    const text = await resp.text();
    console.log("YAP dashboard raw text:", text);

    let json;
    try {
      json = JSON.parse(text);
    } catch (parseErr) {
      console.error("YAP dashboard JSON parse error:", parseErr);
      yapEl.textContent = "parse error";
      return;
    }

    console.log("YAP dashboard json parsed:", json);

    let val = null;
    if (typeof json === "number") {
      val = json;
    } else if (json && typeof json.yaps_all !== "undefined") {
      val = json.yaps_all;
    } else if (json && json.data && typeof json.data.yaps_all !== "undefined") {
      val = json.data.yaps_all;
    }

    const num = Number(val);
    if (!isFinite(num)) {
      yapEl.textContent = "-";
      return;
    }

    yapEl.textContent = num.toFixed(4);
  } catch (e) {
    console.error("YAP dashboard unexpected error:", e);
    yapEl.textContent = "error";
  }
}

function tryAutoLoadKaitoForCurrentUser() {
    try {
      refreshDashboardKaitoForCurrentUser();
    } catch (e) {
      console.warn("auto kaito load error:", e);
    }
    try {
      if (typeof refreshDashboardYapForCurrentUser === "function") {
        refreshDashboardYapForCurrentUser();
      }
    } catch (e) {
      console.warn("auto yap load error:", e);
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    try {
      tryAutoLoadKaitoForCurrentUser();
    } catch (e) {
      console.warn("auto load kaito on DOMContentLoaded error:", e);
    }
  });
</script>


<script>
    
// 프로필 탭: Supabase 기반 프로필 & 히스토리
    (function () {
      const nameInput = document.getElementById("profileDisplayName");
      const idInput = document.getElementById("profileMuddhaId");
      const handleInput = document.getElementById("profileTwitterHandle");
      const saveBtn = document.getElementById("profileSaveButton");
      const avatar = document.getElementById("profileAvatar");
      const namePreview = document.getElementById("profileNamePreview");
      const handlePreview = document.getElementById("profileHandlePreview");
      const historyList = document.getElementById("profileHistoryList");

      if (!nameInput || !idInput || !handleInput || !saveBtn) return;

      function applyPreview() {
        const dn = nameInput.value.trim() || "붓다";
        const handle = handleInput.value.trim() || "bud_dha__";
        if (namePreview) namePreview.textContent = dn;
        if (handlePreview) handlePreview.textContent = "@" + handle;
        if (avatar) {
          avatar.src = "https://unavatar.io/twitter/" + handle;
        }
      }

      function renderHistory(history) {
        if (!historyList) return;
        historyList.innerHTML = "";
        if (!history || !history.length) {
          const empty = document.createElement("div");
          empty.className = "profile-history-item";
          empty.innerHTML = '<span>아직 기록이 없습니다.</span><span class="profile-history-item-time">-</span>';
          historyList.appendChild(empty);
          return;
        }
        history.slice().reverse().forEach(item => {
          const row = document.createElement("div");
          row.className = "profile-history-item";
          const text = document.createElement("span");
          text.textContent = item.message || "프로필을 수정했습니다.";
          const time = document.createElement("span");
          time.className = "profile-history-item-time";
          time.textContent = item.time || "";
          row.appendChild(text);
          row.appendChild(time);
          historyList.appendChild(row);
        });
      }

      function formatTime(date) {
        const m = date.getMonth() + 1;
        const d = date.getDate();
        const hh = String(date.getHours()).padStart(2, "0");
        const mm = String(date.getMinutes()).padStart(2, "0");
        return `${m}. ${d}. ${hh}:${mm}`;
      }

      async function loadProfileFromSupabase() {
        try {
          if (typeof supabaseClient === "undefined") return;
          const { data: { user } } = await supabaseClient.auth.getUser();
          if (!user) {
            // 로그인 안 된 상태: 기본 프리뷰만 적용
            nameInput.value = "붓다";
            idInput.value = "";
            handleInput.value = "bud_dha__";
            applyPreview();
            renderHistory([]);
            return;
          }

          // muddha 아이디는 이메일 앞부분에서 유도
          const email = user.email || "";
          const muddahId = email.includes("@") ? email.split("@")[0] : "";
          idInput.value = muddahId;

          const { data: profile, error } = await supabaseClient
            .from("profiles")
            .select("nickname, handle, x_handle, muddah_id")
            .eq("user_id", user.id)
            .maybeSingle();

          if (error) {
            console.warn("profiles load error:", error);
          }

          const nickname = (profile && profile.nickname) || "";
          const handle =
            (profile && profile.handle) ||
            (profile && profile.x_handle) ||
            "bud_dha__";

          nameInput.value = nickname || "붓다";
          handleInput.value = handle;
          if (!profile || !profile.muddah_id) {
            // 기존 행이 없거나 muddah_id가 비어 있으면 한번 동기화
            try {
              await supabaseClient
                .from("profiles")
                .upsert(
                  {
                    id: user.id,
                    user_id: user.id,
                    muddah_id: muddahId || null,
                    nickname: nickname || "붓다",
                    handle: handle,
                    x_handle: handle
                  },
                  { onConflict: "id" }
                );
            } catch (e) {
              console.warn("profiles auto-sync error:", e);
            }
          }

          applyPreview();
          const history = [{
            time: formatTime(new Date()),
            message: "프로필 정보를 불러왔습니다."
          }];
          renderHistory(history);
        } catch (e) {
          console.error("프로필 로드 오류", e);
        }
      }

      async function saveProfileToSupabase() {
        try {
          if (typeof supabaseClient === "undefined") return;
          const { data: { user } } = await supabaseClient.auth.getUser();
          if (!user) {
            alert("먼저 로그인해 주세요.");
            return;
          }

          const displayName = nameInput.value.trim() || "붓다";
          const muddahId = idInput.value.trim();
          const twitterHandle = handleInput.value.trim() || "bud_dha__";

          await supabaseClient
            .from("profiles")
            .upsert(
              {
                id: user.id,
                user_id: user.id,
                muddah_id: muddahId || null,
                nickname: displayName,
                handle: twitterHandle,
                x_handle: twitterHandle
              },
              { onConflict: "id" }
            );

          applyPreview();
          const now = new Date();
          const history = [{
            time: formatTime(now),
            message: "프로필 정보를 저장했습니다."
          }];
          renderHistory(history);
        } catch (e) {
          console.error("프로필 저장 오류", e);
        }

      if (typeof window !== "undefined") {
        window.muddhaProfileReload = loadProfileFromSupabase;
      }
      }

      saveBtn.addEventListener("click", function () {
        saveProfileToSupabase();
      });

      nameInput.addEventListener("input", applyPreview);
      handleInput.addEventListener("input", applyPreview);

      loadProfileFromSupabase();
    })()
;
  </script>

  
  <script>
    (function () {
      var COOKIE_ZIP_URL = "cookie_all_bundle.zip";
      var COOKIE_JSON_INSIDE_ZIP = "cookie_all_bundle.json";
      var cookieCache = null;

      function normalizeHandle(raw) {
        if (!raw) return "";
        var h = String(raw).trim();
        if (!h) return "";
        if (h[0] === "@") h = h.slice(1);
        return h.toLowerCase();
      }

      // ZIP 안에 있는 cookie_all_bundle.json을 읽어서 파싱하는 헬퍼
      function loadCookieBundleFromZip() {
        return fetch(COOKIE_ZIP_URL)
          .then(function (res) {
            if (!res.ok) {
              throw new Error("ZIP load failed: " + res.status);
            }
            return res.arrayBuffer();
          })
          .then(function (buffer) {
            return JSZip.loadAsync(buffer);
          })
          .then(function (zip) {
            var jsonFile = zip.file(COOKIE_JSON_INSIDE_ZIP);
            if (!jsonFile) {
              throw new Error("JSON file not found inside ZIP: " + COOKIE_JSON_INSIDE_ZIP);
            }
            return jsonFile.async("string");
          })
          .then(function (text) {
            return JSON.parse(text);
          });
      }

      function ensureLoadedCookieData(callback) {
        if (cookieCache) {
          callback(cookieCache);
          return;
        }
        loadCookieBundleFromZip()
          .then(function (data) {
            cookieCache = data;
            callback(cookieCache);
          })
          .catch(function (err) {
            console.error("Cookie JSON load error:", err);
            var cards = document.getElementById("cookie-project-cards");
            var tbody = document.getElementById("cookie-raw-tbody");
            if (cards) {
              cards.innerHTML = '<div class="cookie-empty">cookie_all_bundle.json을 불러오지 못했어요. 파일이 같은 폴더에 있는지 확인해줘.</div>';
            }
            if (tbody) {
              tbody.innerHTML = '<tr><td colspan="6" class="cookie-empty">cookie_all_bundle.json을 불러오지 못했어요.</td></tr>';
            }
          });
      }

      
      var COOKIE_PROJECT_LOGOS = {
        veera: "https://pbs.twimg.com/profile_images/1990352139168923648/PfeXQsSl_400x400.jpg",
        spaace: "https://pbs.twimg.com/profile_images/1651202265405898753/6PanR3uY_400x400.jpg",
        superform: "https://pbs.twimg.com/profile_images/1937588443166416896/4S5X6QSi_400x400.png",
        glint: "https://pbs.twimg.com/profile_images/1825445059375816705/th4KzmWL_400x400.jpg",
        "glint-analytics": "https://pbs.twimg.com/profile_images/1825445059375816705/th4KzmWL_400x400.jpg",
        solv: "https://pbs.twimg.com/profile_images/1971489442235092992/njLUqgMN_400x400.jpg",
        "solv-protocol": "https://pbs.twimg.com/profile_images/1971489442235092992/njLUqgMN_400x400.jpg",
        pacifica: "https://pbs.twimg.com/profile_images/1911022804159389696/THxMFj50_400x400.jpg",
        layerbank: "https://pbs.twimg.com/profile_images/1874059175967547396/p25s8fYo_400x400.jpg",
        tria: "https://pbs.twimg.com/profile_images/1947271337057079296/_smOX_4e_400x400.jpg",
        rayls: "https://pbs.twimg.com/profile_images/1787938574702116864/W_-vmST3_400x400.png",
        almanak: "https://pbs.twimg.com/profile_images/1933390399005208578/tBlaw9Jj_400x400.png",
        ten: "https://pbs.twimg.com/profile_images/1948670923596234752/CjzIhnby_400x400.jpg",
        vooi: "https://pbs.twimg.com/profile_images/1938271243876155393/fXAC9P_h_400x400.jpg"
      };

      function projectLogo(project) {
        if (!project) return null;
        var key = String(project).toLowerCase();
        var url = COOKIE_PROJECT_LOGOS[key];
        if (url) return { url: url };
        return null;
      }

      function pickBestByPeriod(entries) {
        var periods = ["7d", "14d", "30d", "total"];
        var result = {
          mindshare: { "7d": null, "14d": null, "30d": null, "total": null },
          capital:   { "7d": null, "14d": null, "30d": null, "total": null }
        };
        entries.forEach(function (row) {
          var type = (row.type || "").toLowerCase(); // mindshare / capital
          var period = (row.period || "").toLowerCase(); // 7d / 14d / 30d / total
          if (periods.indexOf(period) === -1) return;
          var bucket = (type.indexOf("cap") !== -1) ? result.capital : result.mindshare;
          var current = bucket[period];
          if (!current || (row.rank != null && row.rank < current.rank)) {
            bucket[period] = row;
          }
        });
        return result;
      }

      function safePercent(val) {
        if (val == null || val === "" || isNaN(Number(val))) return "-";
        var num = Number(val);
        return num.toFixed(2) + "%";
      }

      
      function buildCookieRows(allData) {
        // allData is an object whose keys are filenames like
        // "vooi_global_Total_2025-12-02-03-20-10.json"
        // Each value has result.data.json.snaps / cSnaps arrays.
        var rows = [];
        if (!allData || typeof allData !== "object") return rows;

        Object.keys(allData).forEach(function (fileKey) {
          var entry = allData[fileKey];
          if (!entry || !entry.result || !entry.result.data || !entry.result.data.json) return;
          var json = entry.result.data.json || {};
          var snaps = json.snaps || [];
          var cSnaps = json.cSnaps || [];

          // Parse project / period from filename
          var name = String(fileKey).replace(/\.json$/i, "");
          var lowerName = name.toLowerCase();
          var parts = name.split("_");
          var project = parts[0] || "Unknown";

          var period = "TOTAL";
          if (lowerName.indexOf("7daysago") !== -1) {
            period = "7D";
          } else if (lowerName.indexOf("14daysago") !== -1) {
            period = "14D";
          } else if (lowerName.indexOf("30daysago") !== -1) {
            period = "30D";
          } else if (lowerName.indexOf("total") !== -1) {
            period = "TOTAL";
          }

          // Helper to push a record
          function pushRow(base, kind) {
            if (!base) return;
            var handle = base.username || base.handle || base.account || "";
            var lang = base.primaryLanguage || base.lang || base.language || "";
            var rank = null;
            var percent = null;

            if (kind === "Mindshare") {
              rank = base.snapsPercentTotalRank != null ? base.snapsPercentTotalRank : base.snapsRank;
              percent = base.snapsPercentTotal != null ? base.snapsPercentTotal : base.snapsPercent;
            } else {
              rank = base.cSnapsPercentTotalRank != null ? base.cSnapsPercentTotalRank : base.cSnapsRank;
              percent = base.cSnapsPercentTotal != null ? base.cSnapsPercentTotal : base.cSnapsPercent;
            }

            rows.push({
              project: project,
              type: kind,
              period: period,
              rank: rank,
              percent: percent,
              lang: lang,
              handle: handle
            });
          }

          snaps.forEach(function (s) { pushRow(s, "Mindshare"); });
          cSnaps.forEach(function (c) { pushRow(c, "Capital"); });
        });

        return rows;
      }

      function fillMatrixRow(container, label, set) {
        var title = document.createElement("div");
        title.className = "cookie-matrix-title";
        title.textContent = label;

        var row = document.createElement("div");
        row.className = "cookie-matrix-row";

        ["7d", "14d", "30d", "total"].forEach(function (p) {
          var cell = document.createElement("div");
          cell.className = "cookie-matrix-cell";
          var rowData = set[p];
          var rankText = "-";
          var pctText = "-";
          if (rowData) {
            if (rowData.rank != null) rankText = "#" + rowData.rank;
            if (rowData.percent != null) pctText = safePercent(rowData.percent);
          }
          var labelEl = document.createElement("div");
          labelEl.className = "metric-label";
          labelEl.textContent = p.toUpperCase();
          var valEl = document.createElement("div");
          valEl.className = "metric-value";
          valEl.textContent = rankText + " · " + pctText;
          cell.appendChild(labelEl);
          cell.appendChild(valEl);
          row.appendChild(cell);
        });

        container.appendChild(title);
        container.appendChild(row);
      }

      function renderCookieLeaderboard() {
        var input = document.getElementById("cookie-handle-input");
        if (!input) return;
        var norm = normalizeHandle(input.value);
        var cardsContainer = document.getElementById("cookie-project-cards");
        var tbody = document.getElementById("cookie-raw-tbody");
        if (!norm) {
          if (cardsContainer) {
            cardsContainer.innerHTML = '<div class="cookie-empty">먼저 위에서 @핸들을 입력하고 <b>검색</b>을 눌러줘.</div>';
          }
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="6" class="cookie-empty">핸들을 입력하면, 여기 Cookie 세부 랭킹이 나와요.</td></tr>';
          }
          return;
        }

        ensureLoadedCookieData(function (allData) {
          var rows = buildCookieRows(allData);
          var filtered = rows.filter(function (row) {
            var h = normalizeHandle(row.handle || row.account || row.owner);
            return h === norm;
          });

          if (!cardsContainer || !tbody) return;

          if (!filtered.length) {
            cardsContainer.innerHTML = '<div class="cookie-empty">@' + norm + ' 로 검색된 Cookie 랭킹이 없어요.</div>';
            tbody.innerHTML =
              '<tr><td colspan="6" class="cookie-empty">@' + norm + ' 로 검색된 세부 랭킹이 없어요.</td></tr>';
            return;
          }

          // 프로젝트별로 묶기
          var byProject = {};
          filtered.forEach(function (row) {
            var proj = row.project || row.token || row.symbol || "Unknown";
            if (!byProject[proj]) byProject[proj] = [];
            byProject[proj].push(row);
          });

          // 카드 렌더
          cardsContainer.innerHTML = "";
          Object.keys(byProject).forEach(function (proj) {
            var entries = byProject[proj];
            var best = pickBestByPeriod(entries);
            var first = entries[0] || {};
            // Cookie JSON 안에 있는 profileImageUrl 우선 사용, 없으면 프로젝트 맵 fallback
            var avatarUrl = null;
            for (var i = 0; i < entries.length; i++) {
              if (entries[i] && entries[i].profileImageUrl) {
                avatarUrl = entries[i].profileImageUrl;
                break;
              }
            }
            var logoMeta = projectLogo(proj);

            var card = document.createElement("div");
            card.className = "cookie-card";

            var header = document.createElement("div");
            header.className = "cookie-card-header";

            var logoBox = document.createElement("div");
            logoBox.className = "cookie-project-logo";
            var logoUrl = (logoMeta && logoMeta.url) ? logoMeta.url : avatarUrl;
            if (logoUrl) {
              var img = document.createElement("img");
              img.src = logoUrl;
              img.alt = proj;
              logoBox.appendChild(img);
            } else {
              logoBox.textContent = proj.charAt(0).toUpperCase();
            }

            var titleBox = document.createElement("div");
            var tMain = document.createElement("div");
            tMain.className = "cookie-card-title-main";
            tMain.textContent = proj;
            var tSub = document.createElement("div");
            tSub.className = "cookie-card-title-sub";
            var lang = first.lang || first.language || "";
            tSub.textContent = "@" + norm + (lang ? " · " + lang : "");
            titleBox.appendChild(tMain);
            titleBox.appendChild(tSub);

            header.appendChild(logoBox);
            header.appendChild(titleBox);
            card.appendChild(header);

            var matrix = document.createElement("div");
            matrix.className = "cookie-matrix";
            fillMatrixRow(matrix, "Mindshare", best.mindshare);
            fillMatrixRow(matrix, "Capital", best.capital);
            card.appendChild(matrix);

            var footer = document.createElement("div");
            footer.className = "cookie-matrix-footer";
            footer.textContent = "엔트리 수: " + entries.length;
            card.appendChild(footer);

            cardsContainer.appendChild(card);
          });

          // 테이블 렌더
          var rowsHtml = filtered
            .sort(function (a, b) {
              var pa = String(a.period || "").toLowerCase();
              var pb = String(b.period || "").toLowerCase();
              if (pa === pb) {
                return (a.rank || 999999) - (b.rank || 999999);
              }
              return pa < pb ? -1 : 1;
            })
            .map(function (row) {
              var proj = row.project || row.token || row.symbol || "Unknown";
              var type = row.type || row.category || "";
              var period = row.period || row.window || "";
              var rank = (row.rank != null) ? row.rank : "-";
              var pct = safePercent(row.percent != null ? row.percent : row.share);
              var lang = row.lang || row.language || "";
              return (
                "<tr>" +
                  "<td>" + proj + "</td>" +
                  "<td>" + type + "</td>" +
                  "<td>" + String(period).toUpperCase() + "</td>" +
                  "<td>" + rank + "</td>" +
                  "<td>" + pct + "</td>" +
                  "<td>" + lang + "</td>" +
                "</tr>"
              );
            })
            .join("");
          tbody.innerHTML = rowsHtml || '<tr><td colspan="6" class="cookie-empty">표시할 랭킹이 없습니다.</td></tr>';
        });
      }

      window.renderCookieLeaderboard = renderCookieLeaderboard;

      document.addEventListener("DOMContentLoaded", function () {
        var input = document.getElementById("cookie-handle-input");
        if (input) {
          input.addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
              renderCookieLeaderboard();
            }
          });
        }
      });
    })();
  </script>
<script>
    (function () {
      const STORAGE_KEY = "muddha_yapping_planner_v1";

      function safeParse(json) {
        try {
          return JSON.parse(json);
        } catch (e) {
          console.warn("YAP planner parse error", e);
          return null;
        }
      }

      function loadPlans() {
        if (!window.localStorage) return [];
        const raw = localStorage.getItem(STORAGE_KEY);
        const data = raw ? safeParse(raw) : null;
        return Array.isArray(data) ? data : [];
      }

      function savePlans(list) {
        if (!window.localStorage) return;
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
        } catch (e) {
          console.warn("YAP planner save error", e);
        }
      }

      function todayISO() {
        const d = new Date();
        d.setHours(0, 0, 0, 0);
        return d.toISOString().slice(0, 10);
      }

      function toISODate(date) {
        const d = new Date(date.getTime());
        d.setHours(0, 0, 0, 0);
        return d.toISOString().slice(0, 10);
      }

      function getWeekStart(date) {
        const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const day = d.getDay(); // 0=Sun,1=Mon,...
        const diff = day === 0 ? -6 : 1 - day; // Monday as first
        d.setDate(d.getDate() + diff);
        d.setHours(0, 0, 0, 0);
        return d;
      }

      function addDays(date, offset) {
        const d = new Date(date.getTime());
        d.setDate(d.getDate() + offset);
        return d;
      }

      function weekdayLabelMonFirst(idx) {
        // idx: 0=Mon..6=Sun
        const arr = ["월", "화", "수", "목", "금", "토", "일"];
        return arr[idx] || "";
      }

      function weekdayFromDate(date) {
        // JS: 0=Sun..6=Sat -> convert to 0=Mon
        const js = date.getDay();
        const idx = (js + 6) % 7; // Sun->6, Mon->0,...
        return weekdayLabelMonFirst(idx);
      }

      function formatRangeLabel(start, end) {
        const sY = start.getFullYear();
        const sM = start.getMonth() + 1;
        const sD = start.getDate();
        const eM = end.getMonth() + 1;
        const eD = end.getDate();
        return sY + "년 " + sM + "월 " + sD + "일 ~ " + eM + "월 " + eD + "일";
      }

      function formatMonthLabel(base) {
        return base.getFullYear() + "년 " + (base.getMonth() + 1) + "월";
      }

      function importanceDotClass(plan) {
        if (plan.importance === "필수") return "core";
        if (plan.horizon === "장기") return "long";
        return "sub";
      }

      let dashboardRenderFn = null;

      // ----------------- Planner Tab -----------------
      function setupPlannerTab() {
        const root = document.getElementById("tab-planner");
        if (!root) return;

        const dateInput = document.getElementById("planDate");
        if (!dateInput) return; // nothing to do yet

        const countInput = document.getElementById("planCount");
        const titleInput = document.getElementById("planTitle");
        const typeSelect = document.getElementById("planType");
        const projectInput = document.getElementById("planProject");
        const memoInput = document.getElementById("planMemo");
        const importanceGroup = document.getElementById("planImportanceGroup");
        const horizonGroup = document.getElementById("planHorizonGroup");
        const addBtn = document.getElementById("plannerAddButton");
        const clearBtn = document.getElementById("plannerClearButton");
        const filterButtons = root.querySelectorAll(".planner-filter-btn");
        const savedSummary = document.getElementById("plannerSavedSummary");
        const savedList = document.getElementById("plannerSavedList");

        const weekGrid = document.getElementById("plannerWeekGrid");
        const weekEmpty = document.getElementById("plannerEmptyWeek");
        const monthGrid = document.getElementById("plannerMonthGrid");
        const monthEmpty = document.getElementById("plannerEmptyMonth");
        const weekView = document.getElementById("plannerWeekView");
        const monthView = document.getElementById("plannerMonthView");
        const calendarTabs = root.querySelectorAll(".planner-calendar-tab");
        const rangeLabel = document.getElementById("plannerRangeLabel");
        const navButtons = root.querySelectorAll(".planner-nav-btn");

        const today = todayISO();
        dateInput.value = today;

        const state = {
          filter: "upcoming",
          view: "week",
          weekBase: getWeekStart(new Date()),
          monthBase: new Date(new Date().getFullYear(), new Date().getMonth(), 1)
        };

        function getActiveChipValue(groupEl, fallback) {
          if (!groupEl) return fallback;
          const active = groupEl.querySelector(".planner-chip.active");
          return active ? active.getAttribute("data-value") : fallback;
        }

        function handleChipClick(ev) {
          const btn = ev.target.closest(".planner-chip");
          if (!btn) return;
          const parent = btn.parentElement;
          Array.prototype.forEach.call(parent.children, function (el) {
            el.classList.remove("active");
          });
          btn.classList.add("active");
        }

        if (importanceGroup) importanceGroup.addEventListener("click", handleChipClick);
        if (horizonGroup) horizonGroup.addEventListener("click", handleChipClick);

        function applyFilter(filter) {
          state.filter = filter;
          filterButtons.forEach(function (b) {
            b.classList.toggle("active", b.getAttribute("data-filter") === filter);
          });
          renderList();
        }

        function renderList() {
          const plans = loadPlans();
          const t = todayISO();
          const upcomingCount = plans.filter(function (p) {
            return !p.done && p.date >= t;
          }).length;

          if (savedSummary) {
            savedSummary.textContent = "총 " + plans.length + "개 · 앞으로 남은 일정 " + upcomingCount + "개";
          }

          if (!savedList) return;
          savedList.innerHTML = "";

          let filtered = plans.slice();
          if (state.filter === "upcoming") {
            filtered = filtered.filter(function (p) {
              return !p.done && p.date >= t;
            });
          } else if (state.filter === "done") {
            filtered = filtered.filter(function (p) {
              return p.done;
            });
          }

          filtered.sort(function (a, b) {
            if (a.date !== b.date) return a.date.localeCompare(b.date);
            if (a.importance !== b.importance) {
              return a.importance === "필수" ? -1 : 1;
            }
            return (a.createdAt || "").localeCompare(b.createdAt || "");
          });

          if (!filtered.length) {
            const empty = document.createElement("div");
            empty.className = "planner-empty";
            empty.textContent = "해당 조건에 맞는 야핑 계획이 아직 없어요.";
            savedList.appendChild(empty);
            return;
          }

          filtered.forEach(function (p) {
            const item = document.createElement("div");
            item.className = "planner-saved-item" + (p.done ? " done" : "");
            item.setAttribute("data-id", p.id);

            const line1 = document.createElement("div");
            line1.className = "planner-saved-line1";

            const titleSpan = document.createElement("div");
            titleSpan.className = "planner-saved-title" + (p.done ? " done" : "");
            const dObj = new Date(p.date + "T00:00:00");
            titleSpan.textContent = weekdayFromDate(dObj) + " · " + p.title;

            const countSpan = document.createElement("div");
            countSpan.className = "planner-saved-meta";
            countSpan.textContent = (p.count || 1) + "회";

            line1.appendChild(titleSpan);
            line1.appendChild(countSpan);

            const meta = document.createElement("div");
            meta.className = "planner-saved-meta";
            const dateLabel = p.date.replace(/-/g, ". ");
            const typeLabel = p.type || "";
            const projectLabel = p.project || "";
            meta.textContent = dateLabel + " · " + typeLabel + (projectLabel ? " · " + projectLabel : "");

            const badges = document.createElement("div");
            badges.className = "planner-saved-badges";
            const b1 = document.createElement("span");
            b1.className = "planner-badge";
            b1.textContent = p.importance || "필수";
            const b2 = document.createElement("span");
            b2.className = "planner-badge";
            b2.textContent = p.horizon || "단기";
            badges.appendChild(b1);
            badges.appendChild(b2);

            const actions = document.createElement("div");
            actions.className = "planner-saved-actions";
            const doneBtn = document.createElement("button");
            doneBtn.className = "planner-mini-btn primary";
            doneBtn.setAttribute("data-action", "toggleDone");
            doneBtn.textContent = p.done ? "완료 해제" : "완료 표시";
            const delBtn = document.createElement("button");
            delBtn.className = "planner-mini-btn danger";
            delBtn.setAttribute("data-action", "delete");
            delBtn.textContent = "삭제";
            actions.appendChild(doneBtn);
            actions.appendChild(delBtn);

            item.appendChild(line1);
            item.appendChild(meta);
            if (p.memo) {
              const memo = document.createElement("div");
              memo.className = "planner-saved-meta";
              memo.textContent = p.memo;
              item.appendChild(memo);
            }
            item.appendChild(badges);
            item.appendChild(actions);

            savedList.appendChild(item);
          });
        }

        function renderCalendar() {
          const plans = loadPlans();
          renderWeek(plans);
          renderMonth(plans);
        }

        function renderWeek(plans) {
          if (!weekGrid || !weekEmpty) return;
          const start = getWeekStart(state.weekBase);
          const end = addDays(start, 6);
          if (rangeLabel && state.view === "week") {
            rangeLabel.textContent = formatRangeLabel(start, end);
          }

          const byDate = {};
          plans.forEach(function (p) {
            if (!p.date) return;
            if (!byDate[p.date]) byDate[p.date] = [];
            byDate[p.date].push(p);
          });

          weekGrid.innerHTML = "";
          let hasAny = false;

          for (let i = 0; i < 7; i++) {
            const dayDate = addDays(start, i);
            const iso = toISODate(dayDate);
            const list = byDate[iso] || [];
            if (list.length) hasAny = true;

            const cell = document.createElement("div");
            cell.className = "planner-day";

            const header = document.createElement("div");
            header.className = "planner-day-header";
            const labelEl = document.createElement("div");
            labelEl.textContent = weekdayLabelMonFirst(i) + " " + dayDate.getDate();
            const countEl = document.createElement("div");
            countEl.className = "planner-day-count";
            if (list.length) countEl.textContent = list.length + "개";
            header.appendChild(labelEl);
            header.appendChild(countEl);
            cell.appendChild(header);

            list.sort(function (a, b) {
              return a.importance === "필수" ? -1 : 1;
            });

            list.forEach(function (p) {
              const pill = document.createElement("div");
              pill.className = "planner-pill";

              const main = document.createElement("div");
              main.className = "planner-pill-main";

              const title = document.createElement("div");
              title.className = "planner-pill-title";
              const dot = document.createElement("span");
              dot.className = "planner-dot " + importanceDotClass(p);
              const text = document.createElement("span");
              text.textContent = p.title;
              title.appendChild(dot);
              title.appendChild(text);

              const count = document.createElement("div");
              count.className = "planner-pill-meta";
              count.textContent = (p.count || 1) + "회";

              main.appendChild(title);
              main.appendChild(count);

              const meta = document.createElement("div");
              meta.className = "planner-pill-meta";
              const typeLabel = p.type || "";
              const projectLabel = p.project || "";
              meta.textContent = typeLabel + (projectLabel ? " · " + projectLabel : "");

              pill.appendChild(main);
              pill.appendChild(meta);

              if (p.memo) {
                const tagline = document.createElement("div");
                tagline.className = "planner-pill-tagline";
                tagline.textContent = p.memo;
                pill.appendChild(tagline);
              }

              cell.appendChild(pill);
            });

            weekGrid.appendChild(cell);
          }

          weekEmpty.style.display = hasAny ? "none" : "block";
        }

        function renderMonth(plans) {
          if (!monthGrid || !monthEmpty) return;
          const base = state.monthBase;
          const firstOfMonth = new Date(base.getFullYear(), base.getMonth(), 1);
          const start = getWeekStart(firstOfMonth);
          const cells = 42;

          const byDate = {};
          plans.forEach(function (p) {
            if (!p.date) return;
            if (!byDate[p.date]) byDate[p.date] = [];
            byDate[p.date].push(p);
          });

          monthGrid.innerHTML = "";
          let hasAny = false;

          for (let i = 0; i < cells; i++) {
            const dayDate = addDays(start, i);
            const iso = toISODate(dayDate);
            const list = byDate[iso] || [];
            if (list.length && dayDate.getMonth() === base.getMonth()) {
              hasAny = true;
            }

            const cell = document.createElement("div");
            cell.className = "planner-month-cell";
            if (dayDate.getMonth() !== base.getMonth()) {
              cell.classList.add("planner-month-other");
            }

            const header = document.createElement("div");
            header.className = "planner-month-day";
            const left = document.createElement("div");
            left.textContent = dayDate.getDate();
            const right = document.createElement("div");
            right.className = "planner-month-count";
            if (list.length) right.textContent = list.length + "개";
            header.appendChild(left);
            header.appendChild(right);
            cell.appendChild(header);

            list.slice(0, 3).forEach(function (p) {
              const row = document.createElement("div");
              row.className = "planner-month-item";
              row.textContent = p.title;
              cell.appendChild(row);
            });

            monthGrid.appendChild(cell);
          }

          if (monthEmpty) {
            monthEmpty.style.display = hasAny ? "none" : "block";
          }
          if (rangeLabel && state.view === "month") {
            rangeLabel.textContent = formatMonthLabel(base);
          }
        }

        function handleAdd(ev) {
          ev.preventDefault();
          const date = (dateInput.value || todayISO());
          const count = parseInt(countInput.value || "1", 10);
          const title = (titleInput.value || "").trim();
          const type = typeSelect.value;
          const project = (projectInput.value || "").trim();
          const memo = (memoInput.value || "").trim();
          const importance = getActiveChipValue(importanceGroup, "필수");
          const horizon = getActiveChipValue(horizonGroup, "단기");

          if (!title) {
            alert("야핑 주제/제목을 입력해줘!");
            titleInput.focus();
            return;
          }

          const now = new Date();
          const newPlan = {
            id: "plan_" + now.getTime() + "_" + Math.random().toString(16).slice(2, 8),
            date: date,
            count: isNaN(count) ? 1 : count,
            title: title,
            type: type,
            project: project,
            memo: memo,
            importance: importance,
            horizon: horizon,
            done: false,
            createdAt: now.toISOString()
          };

          const plans = loadPlans();
          plans.push(newPlan);
          savePlans(plans);

          renderList();
          renderCalendar();
          if (typeof dashboardRenderFn === "function") {
            dashboardRenderFn();
          }
        }

        function handleClear() {
          if (!confirm("정말 모든 야핑 계획을 삭제할까요?")) return;
          savePlans([]);
          renderList();
          renderCalendar();
          if (typeof dashboardRenderFn === "function") {
            dashboardRenderFn();
          }
        }

        if (addBtn) addBtn.addEventListener("click", handleAdd);
        if (clearBtn) clearBtn.addEventListener("click", handleClear);

        if (savedList) {
          savedList.addEventListener("click", function (ev) {
            const btn = ev.target.closest("button[data-action]");
            if (!btn) return;
            const action = btn.getAttribute("data-action");
            const item = btn.closest(".planner-saved-item");
            if (!item) return;
            const id = item.getAttribute("data-id");
            const plans = loadPlans();
            const idx = plans.findIndex(function (p) { return p.id === id; });
            if (idx === -1) return;

            if (action === "toggleDone") {
              plans[idx].done = !plans[idx].done;
            } else if (action === "delete") {
              if (!confirm("이 야핑 계획을 삭제할까요?")) return;
              plans.splice(idx, 1);
            }
            savePlans(plans);
            renderList();
            renderCalendar();
            if (typeof dashboardRenderFn === "function") {
              dashboardRenderFn();
            }
          });
        }

        calendarTabs.forEach(function (btn) {
          btn.addEventListener("click", function () {
            const view = btn.getAttribute("data-view") || "week";
            state.view = view;
            calendarTabs.forEach(function (b) {
              b.classList.toggle("active", b === btn);
            });
            if (view === "week") {
              if (weekView) weekView.style.display = "block";
              if (monthView) monthView.style.display = "none";
              const start = getWeekStart(state.weekBase);
              const end = addDays(start, 6);
              if (rangeLabel) rangeLabel.textContent = formatRangeLabel(start, end);
            } else {
              if (weekView) weekView.style.display = "none";
              if (monthView) monthView.style.display = "block";
              if (rangeLabel) rangeLabel.textContent = formatMonthLabel(state.monthBase);
            }
          });
        });

        navButtons.forEach(function (btn) {
          btn.addEventListener("click", function () {
            const dir = btn.getAttribute("data-dir") === "prev" ? -1 : 1;
            if (state.view === "week") {
              state.weekBase = addDays(state.weekBase, dir * 7);
              const start = getWeekStart(state.weekBase);
              const end = addDays(start, 6);
              if (rangeLabel) rangeLabel.textContent = formatRangeLabel(start, end);
            } else {
              const mb = state.monthBase;
              state.monthBase = new Date(mb.getFullYear(), mb.getMonth() + dir, 1);
              if (rangeLabel) rangeLabel.textContent = formatMonthLabel(state.monthBase);
            }
            renderCalendar();
          });
        });

        // initial render
        applyFilter("upcoming");
        renderCalendar();
        const ws = getWeekStart(state.weekBase);
        const we = addDays(ws, 6);
        if (rangeLabel) rangeLabel.textContent = formatRangeLabel(ws, we);
      }

      // ----------------- Dashboard widget -----------------
      function setupDashboardWidget() {
        const weekGrid = document.getElementById("dashYapWeekGrid");
        const weekEmpty = document.getElementById("dashYapEmptyWeek");
        const monthGrid = document.getElementById("dashYapMonthGrid");
        const monthEmpty = document.getElementById("dashYapEmptyMonth");
        const label = document.getElementById("dashYapLabel");
        const tabs = document.querySelectorAll(".dash-yap-tab");
        const navButtons = document.querySelectorAll(".dash-yap-nav");
        const weekView = document.getElementById("dashYapWeekView");
        const monthView = document.getElementById("dashYapMonthView");

        if (!weekGrid || !label) return;

        const state = {
          view: "week",
          weekBase: getWeekStart(new Date()),
          monthBase: new Date(new Date().getFullYear(), new Date().getMonth(), 1)
        };

        function render() {
          const plans = loadPlans().filter(function (p) {
            // 위젯에는 "완료 안 된" 일정만 보여줌
            return !p.done;
          });
          if (state.view === "week") {
            renderWeek(plans);
          } else {
            renderMonth(plans);
          }
        }

        function renderWeek(plans) {
          const start = getWeekStart(state.weekBase);
          const end = addDays(start, 6);
          if (label) label.textContent = formatRangeLabel(start, end);

          const byDate = {};
          plans.forEach(function (p) {
            if (!p.date) return;
            if (!byDate[p.date]) byDate[p.date] = [];
            byDate[p.date].push(p);
          });

          weekGrid.innerHTML = "";
          let hasAny = false;

          for (let i = 0; i < 7; i++) {
            const dayDate = addDays(start, i);
            const iso = toISODate(dayDate);
            const list = byDate[iso] || [];
            if (list.length) hasAny = true;

            const cell = document.createElement("div");
            cell.className = "dash-yap-day";

            const header = document.createElement("div");
            header.className = "dash-yap-day-header";
            const labelEl = document.createElement("div");
            labelEl.textContent = weekdayLabelMonFirst(i) + " " + dayDate.getDate();
            const countEl = document.createElement("div");
            countEl.className = "dash-yap-day-count";
            if (list.length) countEl.textContent = list.length + "개";
            header.appendChild(labelEl);
            header.appendChild(countEl);
            cell.appendChild(header);

            list.sort(function (a, b) {
              return a.importance === "필수" ? -1 : 1;
            });

            list.forEach(function (p) {
              const pill = document.createElement("div");
              pill.className = "dash-yap-pill";

              const main = document.createElement("div");
              main.className = "dash-yap-pill-main";

              const title = document.createElement("div");
              title.className = "dash-yap-pill-title";
              const dot = document.createElement("span");
              dot.className = "dash-yap-dot " + importanceDotClass(p);
              const text = document.createElement("span");
              text.textContent = p.title;
              title.appendChild(dot);
              title.appendChild(text);

              const count = document.createElement("div");
              count.className = "dash-yap-pill-meta";
              count.textContent = (p.count || 1) + "회";

              main.appendChild(title);
              main.appendChild(count);

              const meta = document.createElement("div");
              meta.className = "dash-yap-pill-meta";
              const typeLabel = p.type || "";
              const projectLabel = p.project || "";
              meta.textContent = typeLabel + (projectLabel ? " · " + projectLabel : "");

              pill.appendChild(main);
              pill.appendChild(meta);

              if (p.memo) {
                const tagline = document.createElement("div");
                tagline.className = "dash-yap-tagline";
                tagline.textContent = p.memo;
                pill.appendChild(tagline);
              }

              cell.appendChild(pill);
            });

            weekGrid.appendChild(cell);
          }

          if (weekEmpty) {
            weekEmpty.style.display = hasAny ? "none" : "block";
          }
          if (weekView && monthView) {
            weekView.style.display = "block";
            monthView.style.display = "none";
          }
        }

        function renderMonth(plans) {
          const base = state.monthBase;
          if (label) label.textContent = formatMonthLabel(base);

          const firstOfMonth = new Date(base.getFullYear(), base.getMonth(), 1);
          const start = getWeekStart(firstOfMonth);
          const cells = 42;

          const byDate = {};
          plans.forEach(function (p) {
            if (!p.date) return;
            if (!byDate[p.date]) byDate[p.date] = [];
            byDate[p.date].push(p);
          });

          monthGrid.innerHTML = "";
          let hasAny = false;

          for (let i = 0; i < cells; i++) {
            const dayDate = addDays(start, i);
            const iso = toISODate(dayDate);
            const list = byDate[iso] || [];
            if (list.length && dayDate.getMonth() === base.getMonth()) {
              hasAny = true;
            }

            const cell = document.createElement("div");
            cell.className = "dash-yap-month-cell";
            if (dayDate.getMonth() !== base.getMonth()) {
              cell.classList.add("dash-yap-month-other");
            }

            const header = document.createElement("div");
            header.className = "dash-yap-month-day";
            const left = document.createElement("div");
            left.textContent = dayDate.getDate();
            const right = document.createElement("div");
            right.className = "dash-yap-month-count";
            if (list.length) right.textContent = list.length + "개";
            header.appendChild(left);
            header.appendChild(right);
            cell.appendChild(header);

            list.slice(0, 3).forEach(function (p) {
              const row = document.createElement("div");
              row.className = "dash-yap-month-item";
              row.textContent = p.title;
              cell.appendChild(row);
            });

            monthGrid.appendChild(cell);
          }

          if (monthEmpty) {
            monthEmpty.style.display = hasAny ? "none" : "block";
          }
          if (weekView && monthView) {
            weekView.style.display = "none";
            monthView.style.display = "block";
          }
        }

        tabs.forEach(function (btn) {
          btn.addEventListener("click", function () {
            const view = btn.getAttribute("data-view") || "week";
            state.view = view;
            tabs.forEach(function (b) {
              b.classList.toggle("active", b === btn);
            });
            render();
          });
        });

        navButtons.forEach(function (btn) {
          btn.addEventListener("click", function () {
            const dir = btn.getAttribute("data-dir") === "prev" ? -1 : 1;
            if (state.view === "week") {
              state.weekBase = addDays(state.weekBase, dir * 7);
            } else {
              const mb = state.monthBase;
              state.monthBase = new Date(mb.getFullYear(), mb.getMonth() + dir, 1);
            }
            render();
          });
        });

        dashboardRenderFn = render;
        render();
      }

      document.addEventListener("DOMContentLoaded", function () {
        setupPlannerTab();
        setupDashboardWidget();
      });
    })();
  </script>


  <script>
    (function () {
      if (typeof window === "undefined") return;
      if (typeof supabaseClient === "undefined") {
        console.warn("Community tab: supabaseClient is not defined. 커뮤니티 기능이 비활성화됩니다.");
        return;
      }

      const COMMUNITY_BOARD_LABELS = {
        free: "자유게시판",
        request: "상호요청"
      };

      let communityCurrentBoard = "free";
      let communityCurrentUser = null;
      let communityProfile = null;
      let communityViewSeed = Math.floor(Math.random() * 50) + 20;
      let communityCurrentSort = "latest";

      let $badgeUser,
          $boardLabel,
          $boardCountText,
          $tbody,
          $writePanel,
          $toggleTop,
          $toggleBottom,
          $titleInput,
          $bodyInput,
          $submitBtn;

      function fmtDate(iso) {
        if (!iso) return "-";
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return "-";
        const y = String(d.getFullYear()).slice(-2);
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return y + "." + m + "." + dd;
      }

      async function loadCommunityUser() {
        try {
          const { data, error } = await supabaseClient.auth.getUser();
          if (error || !data || !data.user) {
            if ($badgeUser) $badgeUser.textContent = "로그인 필요 · 글쓰기는 로그인 후 가능";
            return;
          }
          communityCurrentUser = data.user;
          let badge = "로그인됨: " + (data.user.email || data.user.id);

          const { data: profile, error: profErr } = await supabaseClient
            .from("profiles")
            .select("nickname, handle, x_handle")
            .eq("user_id", data.user.id)
            .maybeSingle();

          if (!profErr && profile) {
            communityProfile = profile;
            const displayName = profile.nickname || "붓다";
            const handle = profile.handle || profile.x_handle || "bud_dha__";
            badge = displayName + " (@" + handle + ")";
          }
          if ($badgeUser) $badgeUser.textContent = badge;
        } catch (e) {
          console.warn("Community tab: loadCommunityUser error", e);
          if ($badgeUser) $badgeUser.textContent = "로그인 상태 확인 실패";
        }
      }

      async function loadCommunityPosts() {
        if (!$tbody) return;
        $tbody.innerHTML = '<tr><td colspan="6" class="community-empty-row">게시글을 불러오는 중...</td></tr>';
        try {
          let query = supabaseClient
            .from("community_posts")
            .select("id, board, title, body, nickname, handle, created_at, reply_count, like_count")
            .eq("board", communityCurrentBoard)
            .limit(80);

          if (communityCurrentSort === "latest") {
            query = query.order("created_at", { ascending: false });
          } else {
            query = query.order("like_count", { ascending: false }).order("created_at", { ascending: false });
          }

          const { data, error } = await query;
          if (error) {
            console.warn("Community tab: loadCommunityPosts error", error);
            $tbody.innerHTML = '<tr><td colspan="6" class="community-empty-row">community_posts 테이블이 없거나 권한 오류입니다. Supabase에서 테이블을 먼저 만들어 주세요.</td></tr>';
            if ($boardCountText) $boardCountText.textContent = "총 0개 글";
            return;
          }

          const posts = Array.isArray(data) ? data : [];
          if ($boardCountText) $boardCountText.textContent = "총 " + posts.length + "개 글";

          if (!posts.length) {
            $tbody.innerHTML = '<tr><td colspan="6" class="community-empty-row">아직 글이 없습니다. 하단 글쓰기 버튼으로 첫 글을 남겨보세요.</td></tr>';
            return;
          }

          let html = "";
          posts.forEach(function (post, idx) {
            const rowNo = posts.length - idx;
            const title = (post.title || "").trim() || "(제목 없음)";
            const nickname = (post.nickname || "").trim() || "익명";
            const handle = (post.handle || "").trim();
            const created = fmtDate(post.created_at);
            const replyCount = post.reply_count ?? 0;
            const likeCount = post.like_count ?? 0;
            const viewCount = likeCount * 2 + replyCount + communityViewSeed + idx;
            const isBest = likeCount >= 10;

            html += '<tr data-id="' + post.id + '">'
                  +   '<td class="community-col-no">' + rowNo + '</td>'
                  +   '<td class="community-col-title">'
                  +     '<div class="community-title-inner">'
                  +       (isBest ? '<span class="community-best-mark">★</span>' : '')
                  +       '<span class="community-title-text">' + title.replace(/</g, "&lt;") + '</span>'
                  +       (replyCount > 0 ? '<span class="community-reply-count">[' + replyCount + ']</span>' : '')
                  +     '</div>'
                  +   '</td>'
                  +   '<td class="community-col-writer">' + nickname.replace(/</g, "&lt;") + (handle ? " (@" + handle.replace(/</g, "&lt;") + ")" : "") + '</td>'
                  +   '<td class="community-col-date">' + created + '</td>'
                  +   '<td class="community-col-views">' + viewCount + '</td>'
                  +   '<td class="community-col-likes">' + likeCount + '</td>'
                  + '</tr>';
          });

          $tbody.innerHTML = html;
        } catch (e) {
          console.warn("Community tab: loadCommunityPosts unexpected error", e);
          $tbody.innerHTML = '<tr><td colspan="6" class="community-empty-row">게시글을 불러오는 중 알 수 없는 오류가 발생했습니다.</td></tr>';
          if ($boardCountText) $boardCountText.textContent = "총 0개 글";
        }
      }

      function toggleWritePanel() {
        if (!$writePanel) return;
        const isOpen = $writePanel.style.display === "block";
        $writePanel.style.display = isOpen ? "none" : "block";
      }

      async function handleSubmit() {
        if (!communityCurrentUser) {
          alert("먼저 로그인해 주세요. (커뮤니티 글쓰기는 로그인 후 사용 가능)");
          return;
        }
        const title = ($titleInput && $titleInput.value || "").trim();
        const body = ($bodyInput && $bodyInput.value || "").trim();
        if (!title || !body) {
          alert("제목과 내용을 모두 입력해 주세요.");
          return;
        }

        if ($submitBtn) {
          $submitBtn.disabled = true;
          $submitBtn.textContent = "작성 중...";
        }

        try {
          const nickname = (communityProfile && communityProfile.nickname) || "붓다";
          const handle = (communityProfile && (communityProfile.handle || communityProfile.x_handle)) || "bud_dha__";

          const { error } = await supabaseClient
            .from("community_posts")
            .insert({
              board: communityCurrentBoard,
              title,
              body,
              user_id: communityCurrentUser.id,
              nickname,
              handle,
              reply_count: 0,
              like_count: 0
            });

          if (error) {
            console.warn("Community tab: insert error", error);
            alert("글 작성 중 오류가 발생했습니다. 콘솔을 확인해 주세요.");
            return;
          }

          if ($titleInput) $titleInput.value = "";
          if ($bodyInput) $bodyInput.value = "";
          await loadCommunityPosts();
        } catch (e) {
          console.warn("Community tab: insert unexpected error", e);
          alert("글 작성 중 알 수 없는 오류가 발생했습니다.");
        } finally {
          if ($submitBtn) {
            $submitBtn.disabled = false;
            $submitBtn.textContent = "작성하기";
          }
        }
      }

      function initCommunityTab() {
        const root = document.getElementById("tab-community");
        if (!root) return;

        $badgeUser = document.getElementById("communityUserBadge");
        $boardLabel = document.getElementById("communityBoardLabel");
        $boardCountText = document.getElementById("communityBoardCountText");
        $tbody = document.getElementById("communityBoardBody");
        $writePanel = document.getElementById("communityWritePanel");
        $toggleTop = document.getElementById("communityWriteToggleTop");
        $toggleBottom = document.getElementById("communityWriteToggleBottom");
        $titleInput = document.getElementById("communityPostTitle");
        $bodyInput = document.getElementById("communityPostContent");
        $submitBtn = document.getElementById("communityPostSubmitBtn");

        const tabButtons = root.querySelectorAll(".community-tab-btn");
        tabButtons.forEach(function (btn) {
          btn.addEventListener("click", function () {
            const board = btn.getAttribute("data-board");
            if (!board || board === communityCurrentBoard) return;
            communityCurrentBoard = board;
            tabButtons.forEach(function (b) {
              b.classList.toggle("active", b.getAttribute("data-board") === board);
            });
            if ($boardLabel) {
              $boardLabel.textContent = COMMUNITY_BOARD_LABELS[board] || board;
            }
            loadCommunityPosts();
          });
        });

        const sortButtons = root.querySelectorAll(".community-sort-btn");
        sortButtons.forEach(function (btn) {
          btn.addEventListener("click", function () {
            const sort = btn.getAttribute("data-sort") || "latest";
            if (sort === communityCurrentSort) return;
            communityCurrentSort = sort;
            sortButtons.forEach(function (b) {
              b.classList.toggle("active", b.getAttribute("data-sort") === sort);
            });
            loadCommunityPosts();
          });
        });

        if ($toggleTop) $toggleTop.addEventListener("click", toggleWritePanel);
        if ($toggleBottom) $toggleBottom.addEventListener("click", toggleWritePanel);
        if ($submitBtn) $submitBtn.addEventListener("click", handleSubmit);

        const sideBtn = document.querySelector('.nav-item[data-target="tab-community"]');
        if (sideBtn) {
          sideBtn.addEventListener("click", function () {
            loadCommunityPosts();
          });
        }

        loadCommunityUser();
        loadCommunityPosts();
      }

      document.addEventListener("DOMContentLoaded", initCommunityTab);
    })();
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      var tabs = document.querySelectorAll('#tab-guide .guide-tab-btn');
      var panels = document.querySelectorAll('#tab-guide .guide-panel');
      if (!tabs.length || !panels.length) return;

      tabs.forEach(function (btn) {
        btn.addEventListener("click", function () {
          var target = btn.getAttribute("data-guide");
          tabs.forEach(function (b) { b.classList.remove("active"); });
          panels.forEach(function (p) { p.classList.remove("active"); });
          btn.classList.add("active");
          var panel = document.getElementById(target);
          if (panel) panel.classList.add("active");
        });
      });
    });
  </script>

<script>
  async function muddhaFetchYapsPlus() {
    const input = document.getElementById("yapsplus-handle");
    const valueEl = document.getElementById("yapsplus-value");
    const metaEl = document.getElementById("yapsplus-meta");

    if (!input || !valueEl || !metaEl) return;

    const raw = (input.value || "").trim();
    if (!raw) {
      metaEl.textContent = "핸들을 입력해 주세요.";
      return;
    }

    const cleanHandle = raw.replace(/^@+/, "");
    valueEl.textContent = "…";
    metaEl.textContent = "계정 @" + cleanHandle + "의 YAP 값을 불러오는 중입니다.";

    try {
      const resp = await fetch(
        "https://kaito-yap-proxy.wnehdrla8382.workers.dev/?username=" + encodeURIComponent(cleanHandle),
        { method: "GET" }
      );

      if (!resp.ok) {
        console.error("YAPS+ fetch error:", resp.status, resp.statusText);
        valueEl.textContent = "-";
        metaEl.textContent = "API 응답을 불러오지 못했어요.";
        return;
      }

      const text = await resp.text();
      console.log("YAPS+ raw text:", text);

      let json;
      try {
        json = JSON.parse(text);
      } catch (parseErr) {
        console.error("YAPS+ JSON parse error:", parseErr);
        valueEl.textContent = "-";
        metaEl.textContent = "JSON 파싱 오류가 발생했어요.";
        return;
      }

      console.log("YAPS+ json parsed:", json);

      let val = null;
      if (typeof json === "number") {
        val = json;
      } else if (json && typeof json.yaps_all !== "undefined") {
        val = json.yaps_all;
      } else if (json && json.data && typeof json.data.yaps_all !== "undefined") {
        val = json.data.yaps_all;
      }

      const num = Number(val);
      if (!isFinite(num)) {
        valueEl.textContent = "-";
        metaEl.textContent = "유효한 YAP 값을 찾지 못했어요.";
        return;
      }

      valueEl.textContent = num.toFixed(4);
      metaEl.textContent = "계정 @" + cleanHandle + "의 원본 YAP 값: " + String(val);
    } catch (e) {
      console.error("YAPS+ unexpected error:", e);
      valueEl.textContent = "-";
      metaEl.textContent = "오류: " + (e && e.message ? e.message : e);
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    const btn = document.getElementById("yapsplus-btn");
    const input = document.getElementById("yapsplus-handle");
    if (btn) {
      btn.addEventListener("click", function () {
        muddhaFetchYapsPlus();
      });
    }
    if (input) {
      input.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          muddhaFetchYapsPlus();
        }
      });
    }
  });
</script>

  <!-- 프로젝트별 마인드쉐어 JS (PROJECTS 키워드 기반) -->
  <script>
// ---- MOCK 데이터 (실제 이식 시 CSV 분석 결과로 대체) ----
    

    let projectPieChart = null;
    let scorePieChart = null;
    let gradePieChart = null;

    
function aggregateByProject(posts) {
      const projMap = new Map();

      for (const p of posts) {
        const key = p.project || "기타";
        if (!projMap.has(key)) {
          projMap.set(key, {
            name: key,
            count: 0,
            sumScore: 0,
            scores: [],
            grades: { S: 0, A: 0, B: 0, C: 0 },
            topPost: null
          });
        }
        const proj = projMap.get(key);
        const score = typeof p.score === "number" ? p.score : 0;
        proj.count += 1;
        proj.sumScore += score;
        proj.scores.push(score);

        const t = (p.tier || "C").toUpperCase();
        if (proj.grades[t] != null) proj.grades[t] += 1;
      }

      function computeTrimmed(arr, ratio = 0.1) {
        if (!arr.length) return 0;
        const sorted = arr.slice().sort((a, b) => a - b);
        let n = sorted.length;
        let k = Math.floor(n * ratio);
        if (k * 2 >= n) k = 0;
        const trimmed = sorted.slice(k, n - k);
        const sum = trimmed.reduce((s, v) => s + v, 0);
        return trimmed.length ? sum / trimmed.length : 0;
      }

      const gradeCountAll = { S: 0, A: 0, B: 0, C: 0 };
      const list = Array.from(projMap.values()).map(p => {
        for (const g of ["S","A","B","C"]) {
          gradeCountAll[g] += p.grades[g] || 0;
        }
        return {
          ...p,
          avgScore: p.count ? p.sumScore / p.count : 0,
          avgTrimmed: p.count ? computeTrimmed(p.scores) : 0
        };
      });

      list.sort((a, b) => b.count - a.count || b.avgScore - a.avgScore);
      return { projects: list, gradeCountAll };
    }

function renderSummaryTable(summary) {
      const wrap = document.getElementById("project-summary-wrap");
      if (!wrap) return;
      if (!summary.projects.length) {
        wrap.innerHTML = '<div class="empty">CSV 분석 결과가 없습니다. (Dev: MOCK 데이터 필요)</div>';
        return;
      }
      const rowsHtml = summary.projects.map((p, idx) => {
        const rank = idx + 1;
        const topLabel = p.topPost ? "대표 트윗 보기 ↗" : "-";
        return `
          <tr>
            <td>#${rank}</td>
            <td>${p.name}</td>
            <td>${p.count}</td>
            <td>${p.avgScore.toFixed(1)}</td>
            <td>${p.avgTrimmed.toFixed(1)}</td>
            <td><span class="link-btn" data-project="${encodeURIComponent(p.name)}" data-role="top-tweet">${topLabel}</span></td>
          </tr>
        `;
      }).join("");

      wrap.innerHTML = `
        <table>
          <thead>
            <tr>
              <th style="width:50px;">순위</th>
              <th>프로젝트</th>
              <th style="width:80px;">게시글 수</th>
              <th style="width:90px;">평균 점수</th>
              <th style="width:96px;">트림드 평균</th>
              <th style="width:110px;">대표 트윗</th>
            </tr>
          </thead>
          <tbody>
            ${rowsHtml}
          </tbody>
        </table>
      `;

      wrap.querySelectorAll('[data-role="top-tweet"]').forEach(btn => {
        btn.addEventListener("click", () => {
          const projectName = decodeURIComponent(btn.getAttribute("data-project") || "");
          const proj = summary.projects.find(p => p.name === projectName);
          if (!proj || !proj.topPost) return;
          const url = proj.topPost.url || "#";
          if (url && url !== "#") {
            window.open(url, "_blank");
          }
        });
      });
    }

    function renderProjectSelect(summary) {
      const sel = document.getElementById("project-select");
      if (!sel) return;
      sel.innerHTML = '<option value="">프로젝트 선택</option>';
      summary.projects.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.name;
        opt.textContent = `${p.name} (${p.count})`;
        sel.appendChild(opt);
      });
    }

    function renderDetailTable(posts, projectName) {
      const wrap = document.getElementById("project-detail-wrap");
      if (!wrap) return;
      const list = posts.filter(p => (p.project || "기타") === projectName);
      if (!list.length) {
        wrap.innerHTML = '<div class="empty">선택한 프로젝트에 해당하는 게시글이 없습니다.</div>';
        return;
      }
      const rowsHtml = list.map((p, idx) => {
        const tier = (p.tier || "C").toUpperCase();
        const cls = "tier-badge tier-" + (["S","A","B","C"].includes(tier) ? tier : "C");
        return `
          <tr>
            <td style="width:40px;">#${idx + 1}</td>
            <td style="width:60px;"><span class="${cls}">${tier}</span></td>
            <td class="tweet-text">${p.text || ""}</td>
            <td style="width:130px;">
              <span class="metric-pill">참여 ${p.engagement ?? "-"} / 노출 ${p.impressions ?? "-"}</span>
            </td>
            <td style="width:80px;">
              <span class="metric-pill">${(p.score ?? 0).toFixed(1)}점</span>
            </td>
            <td style="width:100px;">
              <a class="link-btn" href="${p.url || "#"}" target="_blank">트윗 보기</a>
            </td>
          </tr>
        `;
      }).join("");

      wrap.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>등급</th>
              <th>본문</th>
              <th>참여/노출</th>
              <th>점수</th>
              <th>링크</th>
            </tr>
          </thead>
          <tbody>
            ${rowsHtml}
          </tbody>
        </table>
      `;
    }

    function renderCharts(summary, posts) {
      const labels = summary.projects.map(p => p.name);
      const counts = summary.projects.map(p => p.count);
      const avgTrimmed = summary.projects.map(p => p.avgTrimmed.toFixed(1));

      const ctxProj = document.getElementById("project-pie");
      const ctxScore = document.getElementById("project-score-pie");
      const ctxGrade = document.getElementById("project-grade-pie");

      if (projectPieChart) projectPieChart.destroy();
      if (scorePieChart) scorePieChart.destroy();
      if (gradePieChart) gradePieChart.destroy();

      const selectEl = document.getElementById("project-select");

      function computeGradeDistForProject(projectName) {
        const gradeCount = { S: 0, A: 0, B: 0, C: 0 };
        posts.forEach(p => {
          if ((p.project || "기타") === projectName) {
            const t = (p.tier || "C").toUpperCase();
            if (gradeCount[t] != null) gradeCount[t] += 1;
          }
        });
        return gradeCount;
      }

      function selectProject(name) {
        if (!name) return;
        if (selectEl) {
          selectEl.value = name;
        }
        const gc = computeGradeDistForProject(name);
        if (gradePieChart) {
          gradePieChart.data.datasets[0].data = [gc.S, gc.A, gc.B, gc.C];
          gradePieChart.update();
        }
        renderDetailTable(posts, name);
      }

      if (ctxProj) {
        projectPieChart = new Chart(ctxProj, {
          type: "doughnut",
          data: {
            labels,
            datasets: [{
              data: counts
            }]
          },
          options: {
            plugins: {
              legend: { display: true, position: "bottom" }
            },
            cutout: "60%",
            onClick: (event, elements) => {
              if (!elements.length) return;
              const idx = elements[0].index;
              const name = labels[idx];
              selectProject(name);
            }
          }
        });
      }

      if (ctxScore) {
        scorePieChart = new Chart(ctxScore, {
          type: "doughnut",
          data: {
            labels,
            datasets: [{
              data: avgTrimmed
            }]
          },
          options: {
            plugins: {
              legend: { display: true, position: "bottom" }
            },
            cutout: "60%",
            onClick: (event, elements) => {
              if (!elements.length) return;
              const idx = elements[0].index;
              const name = labels[idx];
              selectProject(name);
            }
          }
        });
      }

      if (ctxGrade) {
        gradePieChart = new Chart(ctxGrade, {
          type: "doughnut",
          data: {
            labels: ["S", "A", "B", "C"],
            datasets: [{
              data: [0, 0, 0, 0]
            }]
          },
          options: {
            plugins: {
              legend: { display: true, position: "bottom" }
            },
            cutout: "60%"
          }
        });
      }

      if (selectEl) {
        selectEl.addEventListener("change", () => {
          const name = selectEl.value;
          if (!name) return;
          selectProject(name);
        });
      }

      const initialProject = summary.projects[0] && summary.projects[0].name;
      if (initialProject) {
        selectProject(initialProject);
      }
    }

    


// ---- 프로젝트 정의: Cookie leaderboard 파일에서 가져온 PROJECTS ----
const PROJECTS = [
  // --- L0 / L1 ---
  { id: "aptos",       label: "Aptos",                  category: "L0/L1", keywords: ["aptos"] },
  { id: "beldex",      label: "Beldex",                 category: "L0/L1", keywords: ["beldex"] },
  { id: "berachain",   label: "Berachain",              category: "L0/L1", keywords: ["berachain"] },
  { id: "camp",        label: "Camp Network",           category: "L0/L1", keywords: ["camp network","campnet"] },
  { id: "ethereum",    label: "Ethereum",               category: "L0/L1", keywords: ["ethereum","eth "] },
  { id: "fogo",        label: "Fogo",                   category: "L0/L1", keywords: ["fogo"] },
  { id: "injective",   label: "Injective",              category: "L0/L1", keywords: ["injective","inj "] },
  { id: "irys",        label: "Irys",                   category: "L0/L1", keywords: ["irys"] },
  { id: "kaia",        label: "Kaia",                   category: "L0/L1", keywords: ["kaia"] },
  { id: "mantra",      label: "MANTRA",                 category: "L0/L1", keywords: ["mantra"] },
  { id: "mavryk",      label: "Mavryk",                 category: "L0/L1", keywords: ["mavryk"] },
  { id: "mitosis",     label: "Mitosis",                category: "L0/L1", keywords: ["mitosis"] },
  { id: "monad",       label: "Monad",                  category: "L0/L1", keywords: ["monad"] },
  { id: "movement",    label: "Movement",               category: "L0/L1", keywords: ["movement"] },
  { id: "near",        label: "Near",                   category: "L0/L1", keywords: ["near"] },
  { id: "peaq",        label: "PEAQ",                   category: "L0/L1", keywords: ["peaq"] },
  { id: "polkadot",    label: "Polkadot",               category: "L0/L1", keywords: ["polkadot","dot "] },
  { id: "sei",         label: "Sei",                    category: "L0/L1", keywords: ["sei "] },
  { id: "somnia",      label: "Somnia",                 category: "L0/L1", keywords: ["somnia"] },
  { id: "sonic",       label: "Sonic (L1)",             category: "L0/L1", keywords: ["sonic chain","sonic l1","sonic mainnet"] },
  { id: "story",       label: "Story",                  category: "L0/L1", keywords: ["story protocol","story chain"] },
  { id: "xion",        label: "XION",                   category: "L0/L1", keywords: ["xion"] },

  // --- L2 ---
  { id: "arbitrum",    label: "Arbitrum",               category: "L2",    keywords: ["arbitrum","arb "] },
  { id: "katana",      label: "Katana",                 category: "L2",    keywords: ["katana"] },
  { id: "mantle",      label: "Mantle",                 category: "L2",    keywords: ["mantle"] },
  { id: "megaeth",     label: "MegaETH",                category: "L2",    keywords: ["megaeth"] },
  { id: "polygon",     label: "Polygon",                category: "L2",    keywords: ["polygon","matic"] },
  { id: "soon",        label: "SOON",                   category: "L2",    keywords: ["soon network","soon chain"] },

  // --- DeFi / Infra ---
  { id: "falcon",      label: "Falcon Finance",         category: "DeFi",  keywords: ["falcon finance","falconfi"] },
  { id: "frax",        label: "Frax",                   category: "DeFi",  keywords: ["frax"] },
  { id: "huma",        label: "Huma",                   category: "DeFi",  keywords: ["huma"] },
  { id: "moremarkets", label: "MoreMarkets",            category: "DeFi",  keywords: ["moremarkets","more markets"] },
  { id: "multipli",    label: "Multipli",               category: "DeFi",  keywords: ["multipli"] },
  { id: "noble",       label: "Noble",                  category: "DeFi",  keywords: ["noble chain","noble network"] },
  { id: "orderly",     label: "Orderly",                category: "DeFi",  keywords: ["orderly","orderly network","orderly omni"] },
  { id: "pyth",        label: "Pyth",                   category: "DeFi",  keywords: ["pyth oracle","pyth network"] },
  { id: "soul",        label: "Soul Protocol",          category: "DeFi",  keywords: ["soul protocol"] },
  { id: "stbl",        label: "STBL",                   category: "DeFi",  keywords: ["stbl","usst","yld","stablecoin 2.0"] },
  { id: "turtle",      label: "Turtle Club",            category: "DeFi",  keywords: ["turtle club"] },
  { id: "walrus",      label: "Walrus",                 category: "DeFi",  keywords: ["walrus"] },

  // --- AI Agents / Agent Infra ---
  { id: "creatorbid",  label: "CreatorBid",             category: "AI Agents", keywords: ["creatorbid"] },
  { id: "infinit",     label: "INFINIT",                category: "AI Agents", keywords: ["infinit"] },
  { id: "newton",      label: "Newton",                 category: "AI Agents", keywords: ["newton ai"] },
  { id: "surf",        label: "Surf",                   category: "AI Agents", keywords: ["surf ai","surf agent"] },
  { id: "symphony",    label: "Symphony",               category: "AI Agents", keywords: ["symphony","symphony finance","symphony router"] },
  { id: "talus",       label: "Talus",                  category: "AI Agents", keywords: ["talus"] },
  { id: "theoriq",     label: "Theoriq",                category: "AI Agents", keywords: ["theoriq"] },
  { id: "virtuals",    label: "Virtuals Protocol",      category: "AI Agents", keywords: ["virtuals","virtuals protocol"] },
  { id: "warden",      label: "Warden Protocol",        category: "AI Agents", keywords: ["warden protocol"] },
  { id: "wayfinder",   label: "Wayfinder",              category: "AI Agents", keywords: ["wayfinder"] },

  // --- Culture / NFT ---
  { id: "anime",       label: "ANIME",                  category: "Culture", keywords: ["anime token","anime protocol"] },
  { id: "boop",        label: "Boop",                   category: "Culture", keywords: ["boop"] },
  { id: "doodles",     label: "Doodles",                category: "Culture", keywords: ["doodles"] },
  { id: "memex",       label: "MemeX",                  category: "Culture", keywords: ["memex"] },
  { id: "moonbirds",   label: "Moonbirds",              category: "Culture", keywords: ["moonbirds"] },
  { id: "pengu",       label: "PENGU",                  category: "Culture", keywords: ["pengu"] },

  // --- BTCFi ---
  { id: "corn",        label: "Corn",                   category: "BTCFi",  keywords: ["corn"] },
  { id: "goat",        label: "GOAT Network",           category: "BTCFi",  keywords: ["goat network"] },
  { id: "lombard",     label: "Lombard",                category: "BTCFi",  keywords: ["lombard"] },
  { id: "portalbtc",   label: "Portal to BTC",          category: "BTCFi",  keywords: ["portal to btc","portal btc"] },
  { id: "satlayer",    label: "SatLayer",               category: "BTCFi",  keywords: ["satlayer"] },

  // --- Robotics ---
  { id: "openmind",    label: "Openmind",               category: "Robotics", keywords: ["openmind"] },

  // --- ZK ---
  { id: "boundless",   label: "Boundless",              category: "ZK", keywords: ["boundless"] },
  { id: "brevis",      label: "Brevis",                 category: "ZK", keywords: ["brevis"] },
  { id: "cysic",       label: "Cysic",                  category: "ZK", keywords: ["cysic"] },
  { id: "miden",       label: "Miden",                  category: "ZK", keywords: ["miden"] },
  { id: "starknet",    label: "Starknet",               category: "ZK", keywords: ["starknet"] },
  { id: "succinct",    label: "Succinct",               category: "ZK", keywords: ["succinct"] },
  { id: "zcash",       label: "Zcash",                  category: "ZK", keywords: ["zcash"] },
  { id: "zkpass",      label: "zkPass",                 category: "ZK", keywords: ["zkpass"] },

  // --- Others ---
  { id: "anoma",       label: "Anoma",                  category: "Others", keywords: ["anoma"] },
  { id: "bless",       label: "Bless",                  category: "Others", keywords: ["bless protocol"] },
  { id: "bybittradfi", label: "Bybit TradFi",           category: "Others", keywords: ["bybit tradfi"] },
  { id: "humanity",    label: "Humanity Protocol",      category: "Others", keywords: ["humanity protocol"] },
  { id: "integra",     label: "Integra",                category: "Others", keywords: ["integra"] },
  { id: "multibank",   label: "Multibank",              category: "Others", keywords: ["multibank"] },
  { id: "thrive",      label: "Thrive Protocol",        category: "Others", keywords: ["thrive protocol"] },

  // --- Exchange / Perp ---
  { id: "apex",        label: "ApeX",                   category: "Exchange", keywords: ["apex pro","apex dex"] },
  { id: "bluefin",     label: "Bluefin",                category: "Exchange", keywords: ["bluefin"] },
  { id: "dydx",        label: "dYdX",                   category: "Exchange", keywords: ["dydx"] },
  { id: "flipster",    label: "Flipster",               category: "Exchange", keywords: ["flipster"] },
  { id: "mememax",     label: "MemeMax",                category: "Exchange", keywords: ["mememax","mememax_fi","@mememax_fi","memax"] },
  { id: "momentum",    label: "Momentum",               category: "Exchange", keywords: ["momentum"] },
  { id: "paradex",     label: "PARADEX",                category: "Exchange", keywords: ["paradex"] },

  // --- AI / InfoFi ---
  { id: "kaito",       label: "Kaito / Yapper",         category: "AI", keywords: ["kaito","kaito ai","yapper","yap points","infofi"] },
  { id: "og",          label: "OG",                     category: "AI", keywords: ["og protocol"] },
  { id: "allora",      label: "Allora",                 category: "AI", keywords: ["allora"] },
  { id: "billions",    label: "Billions Network",       category: "AI", keywords: ["billions network"] },
  { id: "edgen",       label: "Edgen",                  category: "AI", keywords: ["edgen"] },
  { id: "everlynai",   label: "EverlynAI",              category: "AI", keywords: ["everlynai"] },
  { id: "iq",          label: "IQ",                     category: "AI", keywords: ["iq ai","iq token"] },
  { id: "kindred",     label: "Kindred",                category: "AI", keywords: ["kindred"] },
  { id: "mira",        label: "Mira Network",           category: "AI", keywords: ["mira network"] },
  { id: "novastro",    label: "Novastro",               category: "AI", keywords: ["novastro"] },
  { id: "noya",        label: "Noya.ai",                category: "AI", keywords: ["noya.ai","noya ai"] },
  { id: "openledger",  label: "OpenLedger",             category: "AI", keywords: ["openledger"] },
  { id: "pipworld",    label: "PiP World",              category: "AI", keywords: ["pip world","pipworld"] },
  { id: "playai",      label: "PlayAI",                 category: "AI", keywords: ["playai","play ai"] },
  { id: "sapien",      label: "Sapien",                 category: "AI", keywords: ["sapien"] },
  { id: "sentient",    label: "Sentient",               category: "AI", keywords: ["sentient"] },
  { id: "uxlink",      label: "UXLINK",                 category: "AI", keywords: ["uxlink"] },

  // --- Consumer / Apps ---
  { id: "tria",        label: "Tria",                   category: "Consumer", keywords: ["tria","use tria","@useTria"] },
  { id: "anichess",    label: "Anichess",               category: "Consumer", keywords: ["anichess"] },
  { id: "bitdealer",   label: "Bitdealer",              category: "Consumer", keywords: ["bitdealer"] },
  { id: "defiapp",     label: "Defi App",               category: "Consumer", keywords: ["defi app"] },
  { id: "hana",        label: "Hana",                   category: "Consumer", keywords: ["hana app"] },
  { id: "infinex",     label: "Infinex",                category: "Consumer", keywords: ["infinex"] },
  { id: "lumiterra",   label: "Lumiterra",              category: "Consumer", keywords: ["lumiterra"] },
  { id: "maplestory",  label: "MapleStory Universe",    category: "Consumer", keywords: ["maplestory universe","msu"] },
  { id: "metawin",     label: "Metawin",                category: "Consumer", keywords: ["metawin"] },
  { id: "parti",       label: "Parti",                  category: "Consumer", keywords: ["parti"] },
  { id: "puffpaw",     label: "Puffpaw",                category: "Consumer", keywords: ["puffpaw"] },
  { id: "rainbow",     label: "Rainbow",                category: "Consumer", keywords: ["rainbow wallet","rainbow app"] },
  { id: "sidekick",    label: "Sidekick",               category: "Consumer", keywords: ["sidekick"] },
  { id: "sixr",        label: "SIXR Cricket",           category: "Consumer", keywords: ["sixr cricket","sixr"] },
  { id: "sophon",      label: "Sophon",                 category: "Consumer", keywords: ["sophon"] },
  { id: "vultisig",    label: "Vultisig",               category: "Consumer", keywords: ["vultisig"] },
  { id: "yeet",        label: "YEET",                   category: "Consumer", keywords: ["yeet"] },

  // --- Interop ---
  { id: "caldera",     label: "Caldera",                category: "Interop", keywords: ["caldera"] },
  { id: "initia",      label: "Initia",                 category: "Interop", keywords: ["initia"] },
  { id: "skate",       label: "Skate",                  category: "Interop", keywords: ["skate"] },
  { id: "union",       label: "Union",                  category: "Interop", keywords: ["union"] },

  // --- RWA ---
  { id: "kaio",        label: "KAIO",                   category: "RWA", keywords: ["kaio","kaio network"] },
  { id: "theo",        label: "Theo Network",           category: "RWA", keywords: ["theo","theo network","thbill","tultra"] },

  // --- Snapper / Campaign style(마인드쉐어용) ---
  { id: "superform",   label: "Superform",              category: "Campaign", keywords: ["superform","superformxyz","@superformxyz"] },
  { id: "glint",       label: "Glint Analytics",        category: "Campaign", keywords: ["glint analytics","@glintanalytics"] },
  { id: "solv",        label: "Solv Protocol",          category: "Campaign", keywords: ["solv protocol","@solvprotocol"] },
  { id: "pacifica",    label: "Pacifica",               category: "Campaign", keywords: ["pacifica_fi","@pacifica_fi","pacifica fi"] },
  { id: "layerbank",   label: "LayerBank",              category: "Campaign", keywords: ["layerbank","layerbankfi","@layerbankfi"] },
  { id: "rayls",       label: "Rayls",                  category: "Campaign", keywords: ["rayls","@RaylsLabs","raylslabs"] },
  { id: "velora",      label: "Velora",                 category: "Campaign", keywords: ["velora","veloradex","@veloradex"] },
  { id: "antix",       label: "Antix",                  category: "Campaign", keywords: ["antix","@antix_in"] },
  { id: "almanak",     label: "Almanak",                category: "Campaign", keywords: ["almanak","@Almanak"] },
  { id: "bob",         label: "BOB",                    category: "Campaign", keywords: ["bob","build on bitcoin","@build_on_bob"] },
  { id: "ten",         label: "TEN Protocol",           category: "Campaign", keywords: ["ten protocol","@tenprotocol","ten app"] },
  { id: "vooi",        label: "Vooi",                   category: "Campaign", keywords: ["vooi","@vooi_io","vooi io"] },

  // --- 너 전용(이미 CSV에서 자주 쓰는 것들) ---
  { id: "river",       label: "River / satUSD",         category: "Stable", keywords: ["river","satusd","sat usd","river4fun","river4 fun","@riverhq"] },
  { id: "cookie",      label: "Cookie.fun",             category: "InfoFi", keywords: ["cookie.fun","cookie fun","cookie leaderboard","@cookie_fun"] },
  { id: "bnkr",        label: "BNKR / BANKR",           category: "Social", keywords: ["bnkr","bankr","bankr leaderboard","@bnkr_network"] }
];

// 텍스트에서 프로젝트를 추론하는 함수
function inferProjectFromText(textRaw) {
  const text = String(textRaw || "").toLowerCase();
  if (!text.trim()) return "기타";
  for (const proj of PROJECTS) {
    if (!proj.keywords || !proj.keywords.length) continue;
    for (const kwRaw of proj.keywords) {
      const kw = String(kwRaw || "").toLowerCase();
      if (!kw) continue;
      if (text.includes(kw)) {
        return proj.label || proj.id || "기타";
      }
    }
  }
  return "기타";
}

// csvAllPosts를 기반으로 프로젝트별 게시글 배열 구성
function buildProjectPostsFromCsv() {
  const src = (window.csvAllPosts || []).slice();
  if (!src.length) return [];

  return src.map((p, idx) => {
    const text = p.text || p.snippet || "";
    const project = inferProjectFromText(text);
    const tier = (p.tier || p.grade || "C").toUpperCase();
    const engagement = (typeof p.engagement === "number")
      ? p.engagement
      : ((p.likes || 0) + (p.retweets || 0) + (p.replies || 0) + (p.quotes || 0) + (p.bookmarks || 0));
    const impressions = p.impressions || p.imps || 0;
    const score = (typeof p.score === "number") ? p.score : 0;

    return {
      id: idx + 1,
      project,
      score,
      tier,
      text,
      engagement,
      impressions,
      url: p.url || "#",
      likes: p.likes || 0,
      retweets: p.retweets || 0,
      replies: p.replies || 0,
      quotes: p.quotes || 0,
      bookmarks: p.bookmarks || 0
    };
  });
}

function initProjectMindshareFromCsv() {
  try {
    const infoEl = document.getElementById("project-summary-sub");
    const posts = buildProjectPostsFromCsv();
    if (!posts.length) {
      if (infoEl) infoEl.textContent = "CSV 분석 결과가 없거나, 프로젝트 키워드를 찾지 못했습니다.";
      renderSummaryTable({ projects: [], gradeCountAll: { S:0,A:0,B:0,C:0 } });
      const sel = document.getElementById("project-select");
      if (sel) sel.innerHTML = '<option value="">프로젝트 없음</option>';
      const wrap = document.getElementById("project-detail-wrap");
      if (wrap) wrap.innerHTML = '<div class="empty">CSV 탭에서 먼저 데이터를 불러와 주세요.</div>';
      return;
    }

    const summary = aggregateByProject(posts);
    if (infoEl) infoEl.textContent = "현재 CSV 분석 결과와 프로젝트 키워드를 기준으로 Mindshare를 계산한 화면입니다.";

    renderSummaryTable(summary);
    renderProjectSelect(summary);
    renderCharts(summary, posts);
    const firstName = summary.projects[0] ? summary.projects[0].name : "";
    if (firstName) {
      renderDetailTable(posts, firstName);
    }

    if (typeof window !== "undefined") {
      window.__projectMindshareState = window.__projectMindshareState || {
        posts
      };
      window.__projectMindshareState.posts = posts;
      window.__projectMindshareState.onProjectChange = function(name) {
        if (!name) return;
        renderDetailTable(posts, name);
        if (window.__projectMindshareState.updateGradeChart) {
          window.__projectMindshareState.updateGradeChart(name);
        }
      };
    }
  } catch (e) {
    console.warn("initProjectMindshareFromCsv error", e);
  }
}

// 사이드탭 클릭 시 자동 초기화
document.addEventListener("DOMContentLoaded", function() {
  const btn = document.querySelector('[data-target="tab-project"]');
  if (btn) {
    btn.addEventListener("click", function() {
      initProjectMindshareFromCsv();
    });
  }
});

  </script>
</body>

</html>
</script>
